<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTM 링크 생성기</title>
<style>
    /* 기본 스타일 */
    body { font-family: sans-serif; padding: 20px; font-size: 14px; }
    .dv1, .dv2, .dv3 { margin-bottom: 20px; }
    label { display: inline-block; min-width: 120px; margin-bottom: 5px; vertical-align: top; /* top 정렬 */ padding-top: 8px; /* 패딩 추가 */}
    input[type="text"] { padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px; vertical-align: middle; }
    input[type="text"]#final_url { background-color: #eee; }
    button { padding: 8px 15px; margin-left: 5px; cursor: pointer; vertical-align: middle; }
    fieldset { margin-bottom: 20px; border:1px solid #ccc; padding:10px; }
    legend { font-weight: bold; }
    .required { color: red; font-weight: bold; }
    .hidden { display: none !important; } /* 숨김 스타일 */

    /* 드롭다운 스타일 */
    .custom-dropdown-container { display: inline-block; vertical-align: top; /* top 정렬 */ } /* 컨테이너 추가 */
    .custom-dropdown {
        position: relative;
        display: inline-block;
        min-width: 200px; /* 최소 너비 유지 */
        width: auto; /* 자동 너비 */
        max-width: 300px; /* 최대 너비 제한 (선택적) */
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #fff;
        margin-bottom: 10px; /* 하단 마진 */
    }
    .dropdown-selected {
        padding: 8px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block; /* 블록 요소로 변경 */
    }
    .dropdown-selected::after { /* 화살표 아이콘 */
        content: '▼';
        font-size: 0.8em;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
    }
    .dropdown-options {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #fff;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
        z-index: 10; /* 다른 요소 위에 오도록 */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dropdown-options li {
        padding: 8px 10px;
        cursor: pointer;
        display: flex; /* Flexbox 사용 */
        align-items: center; /* 수직 중앙 정렬 */
        justify-content: space-between; /* 양쪽 정렬 */
        white-space: nowrap; /* 줄바꿈 방지 */
    }
    .dropdown-options li:hover {
        background-color: #f0f0f0;
    }
    .dropdown-options li .option-content { /* 텍스트 영역 */
        flex-grow: 1; /* 남은 공간 차지 */
        margin-left: 8px; /* 아이콘과 간격 */
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .dropdown-options li .icon { /* 아이콘 스타일 (간단 예시) */
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #ddd; /* 기본 색상 */
        flex-shrink: 0; /* 아이콘 줄어들지 않게 */
    }
    /* 타입별 아이콘 색상 (선택적) */
    .dropdown-options li[data-type="default"] .icon { background-color: #aaa; }
    .dropdown-options li[data-type="custom"] .icon { background-color: #6aabff; }

    .dropdown-options li .delete-btn {
        background: none;
        border: none;
        color: #aaa;
        cursor: pointer;
        font-size: 1.1em; /* 크기 조정 */
        padding: 0 5px;
        margin-left: 10px;
        flex-shrink: 0; /* 버튼 줄어들지 않게 */
        font-weight: bold;
    }
    .dropdown-options li .delete-btn:hover {
        color: #f00;
    }
    /* 기본값 항목에서는 삭제 버튼 숨김 */
    .dropdown-options li[data-type="default"] .delete-btn {
        display: none;
    }

    .dropdown-options .add-option {
        color: #007bff;
        font-weight: bold;
        border-top: 1px solid #eee;
    }
    .add-option-input {
        padding: 5px; /* 내부 패딩 */
        border-top: 1px solid #eee;
        background-color: #f9f9f9;
    }
    .add-option-input input[type="text"] {
        width: calc(100% - 16px); /* 패딩 고려 */
        margin: 0;
        box-sizing: border-box;
    }
</style>
</head>
<body>
<div class="dv1">
    <div class="dv2">
        <h1>UTM 링크 생성</h1>
        <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;">
            <thead><tr><th colspan="2">UTM 네이밍 규칙</th></tr></thead>
            <tbody><tr><td>공통 규칙</td><td><ul><li>띄어쓰기 금지</li><li>구분자: 언더스코어('_') 및 하이픈('-') 사용</li><li>영문 네이밍: 소문자만 사용</li><li>특수문자 사용 금지 (&amp;, ?, #, ., /, \ 등)</li></ul></td></tr><tr><td>캠페인 규칙</td><td><ul><li>구성: 날짜_광고타입_캠페인목표_기획전종류_상품카테고리_광고타겟_소재타입_기기카테고리</li><li>없으면 'N'으로 채움</li><li><span class="required">필수 항목: 날짜, 광고타입, 기기카테고리</span></li></ul></td></tr><tr><td>콘텐츠 규칙</td><td><ul><li>목표행동, 추가기입사항, 버전 중 하나라도 입력되면 해당 값으로 조합</li><li>입력되지 않으면 'N'으로 처리</li></ul></td></tr></tbody>
        </table>
        <br>
    </div>

    <div class="dv3">
        <form action="http://localhost:5677/webhook/test" method="POST" id="utmForm" onsubmit="return combineUTMValues()">
            <label for="page_url">Page URL <span class="required">(필수)</span>:</label>
            <input type="text" id="page_url" name="page_url" required placeholder="https://example.com" oninput="updateFinalURL()"><br><br>

            <label for="utm_source">UTM Source <span class="required">(필수)</span>:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="source_dropdown">
                    <div class="dropdown-selected" id="source_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="source_options_list">
                        <li class="add-option" id="source_add_option_button">+ 옵션 추가</li>
                    </ul>
                    <div class="add-option-input hidden" id="source_add_input_container">
                        <input type="text" id="source_add_input" placeholder="입력 후 Enter">
                    </div>
                </div>
                <input type="hidden" id="source" name="utm_source" required> {/* ID를 'source'로 변경 */ }
            </div>
            <br><br>

            <label for="utm_medium">UTM Medium <span class="required">(필수)</span>:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="medium_dropdown">
                    <div class="dropdown-selected" id="medium_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="medium_options_list">
                        <li class="add-option" id="medium_add_option_button">+ 옵션 추가</li>
                    </ul>
                    <div class="add-option-input hidden" id="medium_add_input_container">
                        <input type="text" id="medium_add_input" placeholder="입력 후 Enter">
                    </div>
                </div>
                <input type="hidden" id="medium" name="utm_medium" required> {/* ID를 'medium'으로 변경 */ }
            </div>
            <br><br>


            <fieldset style="border:1px solid #ccc; padding:10px;">
                <legend>UTM Campaign 구성</legend>

                <label>날짜 <span class="required">(필수)</span>:</label>
                <input type="text" id="campaign_date" placeholder="YYYYMMDD" oninput="updateFinalURL()" required><br><br>

                <label>광고타입 <span class="required">(필수)</span>:</label>
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="ad_type_dropdown">
                        <div class="dropdown-selected" id="ad_type_selected_value" tabindex="0">-- 선택하세요 --</div>
                        <ul class="dropdown-options hidden" id="ad_type_options_list">
                            <li class="add-option" id="ad_type_add_option_button">+ 옵션 추가</li>
                        </ul>
                        <div class="add-option-input hidden" id="ad_type_add_input_container">
                            <input type="text" id="ad_type_add_input" placeholder="입력 후 Enter">
                        </div>
                    </div>
                    <input type="hidden" id="ad_type" name="ad_type" required>
                </div>
                <br><br>

                <label>캠페인목표:</label>
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="campaign_goal_dropdown">
                        <div class="dropdown-selected" id="campaign_goal_selected_value" tabindex="0">-- 선택하세요 --</div>
                        <ul class="dropdown-options hidden" id="campaign_goal_options_list">
                            <li class="add-option" id="campaign_goal_add_option_button">+ 옵션 추가</li>
                        </ul>
                        <div class="add-option-input hidden" id="campaign_goal_add_input_container">
                            <input type="text" id="campaign_goal_add_input" placeholder="입력 후 Enter">
                        </div>
                    </div>
                    <input type="hidden" id="campaign_goal" name="campaign_goal">
                </div>
                <br><br>

                <label>기획전종류:</label>
                 <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="event_type_dropdown"> {/* ID를 event_type으로 */}
                        <div class="dropdown-selected" id="event_type_selected_value" tabindex="0">-- 선택하세요 --</div>
                        <ul class="dropdown-options hidden" id="event_type_options_list">
                            <li class="add-option" id="event_type_add_option_button">+ 옵션 추가</li>
                        </ul>
                        <div class="add-option-input hidden" id="event_type_add_input_container">
                            <input type="text" id="event_type_add_input" placeholder="입력 후 Enter">
                        </div>
                    </div>
                    <input type="hidden" id="event_type" name="event_type"> {/* ID를 event_type으로 */}
                </div>
                <br><br>

                <label>상품카테고리:</label>
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="product_category_dropdown"> {/* ID를 product_category로 */}
                        <div class="dropdown-selected" id="product_category_selected_value" tabindex="0">-- 선택하세요 --</div>
                        <ul class="dropdown-options hidden" id="product_category_options_list">
                            <li class="add-option" id="product_category_add_option_button">+ 옵션 추가</li>
                        </ul>
                        <div class="add-option-input hidden" id="product_category_add_input_container">
                            <input type="text" id="product_category_add_input" placeholder="입력 후 Enter">
                        </div>
                    </div>
                    <input type="hidden" id="product_category" name="product_category"> {/* ID를 product_category로 */}
                </div>
                <br><br>

                <label>광고타겟:</label>
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="ad_target_dropdown">
                        <div class="dropdown-selected" id="ad_target_selected_value" tabindex="0">-- 선택하세요 --</div>
                        <ul class="dropdown-options hidden" id="ad_target_options_list">
                            <li class="add-option" id="ad_target_add_option_button">+ 옵션 추가</li>
                        </ul>
                        <div class="add-option-input hidden" id="ad_target_add_input_container">
                            <input type="text" id="ad_target_add_input" placeholder="입력 후 Enter">
                        </div>
                    </div>
                    <input type="hidden" id="ad_target" name="ad_target">
                </div>
                <br><br>

                <label>소재타입:</label>
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="creative_type_dropdown">
                        <div class="dropdown-selected" id="creative_type_selected_value" tabindex="0">-- 선택하세요 --</div>
                        <ul class="dropdown-options hidden" id="creative_type_options_list">
                            <li class="add-option" id="creative_type_add_option_button">+ 옵션 추가</li>
                        </ul>
                        <div class="add-option-input hidden" id="creative_type_add_input_container">
                            <input type="text" id="creative_type_add_input" placeholder="입력 후 Enter">
                        </div>
                    </div>
                    <input type="hidden" id="creative_type" name="creative_type">
                </div>
                <br><br>

                <label>기기카테고리 <span class="required">(필수)</span>:</label>
                 <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="device_type_dropdown">
                        <div class="dropdown-selected" id="device_type_selected_value" tabindex="0">-- 선택하세요 --</div>
                        <ul class="dropdown-options hidden" id="device_type_options_list">
                            <li class="add-option" id="device_type_add_option_button">+ 옵션 추가</li>
                        </ul>
                        <div class="add-option-input hidden" id="device_type_add_input_container">
                            <input type="text" id="device_type_add_input" placeholder="입력 후 Enter">
                        </div>
                    </div>
                    <input type="hidden" id="device_type" name="device_type" required>
                </div>
                <br><br>
            </fieldset>

            <fieldset style="border:1px solid #ccc; padding:10px;">
                <legend>UTM Content 구성</legend>

                <label>목표행동:</label>
                 <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="content_action_dropdown"> {/* ID를 content_action으로 */}
                        <div class="dropdown-selected" id="content_action_selected_value" tabindex="0">-- 선택하세요 --</div>
                        <ul class="dropdown-options hidden" id="content_action_options_list">
                            <li class="add-option" id="content_action_add_option_button">+ 옵션 추가</li>
                        </ul>
                        <div class="add-option-input hidden" id="content_action_add_input_container">
                            <input type="text" id="content_action_add_input" placeholder="입력 후 Enter">
                        </div>
                    </div>
                    <input type="hidden" id="content_action" name="content_action"> {/* ID를 content_action으로 */}
                </div>
                <br><br>

                <label>추가기입사항:</label>
                <input type="text" id="content_detail" placeholder="120X240-vertical" oninput="updateFinalURL()"><br><br>

                <label>버전:</label>
                <input type="text" id="content_version" placeholder="v1" oninput="updateFinalURL()"><br><br>
            </fieldset>

            <label for="utm_term">UTM Term (선택):</label>
            <input type="text" id="utm_term" name="utm_term" placeholder="shoes" oninput="updateFinalURL()"><br><br>

            {/* UTM Campaign / Content 조합 결과 (숨김) */}
            <input type="hidden" id="utm_campaign" name="utm_campaign" required>
            <input type="hidden" id="utm_content" name="utm_content">

            <label for="final_url">최종 URL:</label>
            <input type="text" id="final_url" disabled style="width:100%; font-family:monospace;">
            <button type="submit">제출</button>
        </form>

        <div id="historyTableContainer" style="margin-top: 30px;">
            <h2>생성 이력</h2>
            <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;" id="historyTable">
                <thead><tr><th>생성일시</th><th>Source</th><th>Medium</th><th>Campaign</th><th>Content</th><th>Term</th><th>단축 URL</th><th>원본 URL</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</div>

<script>

// --- 설정값 ---
const LS_KEY_PREFIX = 'utmGenerator_'; // LocalStorage 키 접두사
// !!! 여기에 웹에 게시된 CSV URL을 붙여넣으세요 !!!
// CSV 형식: 첫 행은 헤더, 각 행은 데이터
// 예시 헤더: source,medium,utm_campaign_ad_type,utm_campaign_goal,...
// (첫번째/두번째 열이 source/medium 구분용이 아님)
const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1861589139&single=true&output=csv'; // 실제 CSV URL로 변경하세요

// 드롭다운으로 만들 필드 ID 목록 (숨겨진 input의 ID 기준)
const dropdownBaseIds = [
    'source',
    'medium',
    'ad_type',
    'campaign_goal',
    'event_type',       // HTML ID 기준
    'product_category', // HTML ID 기준
    'ad_target',
    'creative_type',
    'device_type',
    'content_action'    // HTML ID 기준
];

// HTML 필드 ID와 CSV 컬럼 헤더 매핑
const columnHeaderMap = {
    'source': 'source',
    'medium': 'medium',
    'ad_type': 'utm_campaign_ad_type',
    'campaign_goal': 'utm_campaign_goal',
    'event_type': 'utm_campaign_promo_type', // HTML ID <-> CSV Header
    'product_category': 'utm_campaign_product_cate', // HTML ID <-> CSV Header
    'ad_target': 'ad_target', // CSV에 이 헤더가 있는지 확인 필요
    'creative_type': 'utm_campaign_creative_type',
    'device_type': 'utm_campaign_device_type',
    'content_action': 'utm_content_goal_action' // HTML ID <-> CSV Header
};

// --- 초기화 ---
document.addEventListener('DOMContentLoaded', async () => {
    for (const baseId of dropdownBaseIds) {
        try {
            await renderAllOptions(baseId); // 옵션 렌더링 (CSV 로드 포함)
            setupDropdownInteractions(baseId); // 이벤트 리스너 설정
        } catch (error) {
            console.error(`Error initializing dropdown for ${baseId}:`, error);
        }
    }
    updateFinalURL(); // 초기 URL 업데이트
    // TODO: 이력 로드 (필요시 구현)
    // loadHistory();
});

// === Helper Functions ===

// li 요소 생성 함수
function createOptionLi(value, displayText, type) {
    const li = document.createElement('li');
    const lowerCaseValue = String(value).toLowerCase(); // 값은 소문자 Key로 사용
    li.dataset.value = lowerCaseValue;
    li.dataset.type = type; // 'default' or 'custom'

    const iconSpan = document.createElement('span');
    iconSpan.className = 'icon';
    li.appendChild(iconSpan);

    const textSpan = document.createElement('span');
    textSpan.className = 'option-content';
    textSpan.textContent = displayText || value; // 표시 텍스트
    li.appendChild(textSpan);

    if (type === 'custom') {
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '&times;';
        li.appendChild(deleteBtn);
    }
    return li;
}

// Google Sheet CSV + LocalStorage 옵션 렌더링 (수정됨)
async function renderAllOptions(baseId) {
    const optionsList = document.getElementById(`${baseId}_options_list`);
    const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
    if (!optionsList || !addOptionButton) {
        // console.warn(`Dropdown elements not found for baseId: ${baseId}`);
        return; // 해당 ID 요소가 없으면 함수 종료
    }
    optionsList.innerHTML = ''; // 기존 목록 초기화
    optionsList.appendChild(addOptionButton); // "+ 옵션 추가" 버튼 다시 추가

    const defaultOptions = new Set(); // 중복 제거 및 기본 옵션 저장용 Set
    const targetHeader = columnHeaderMap[baseId]; // 매핑된 CSV 헤더 이름 가져오기

    // 1. Google Sheet CSV 로드 및 해당 열(Column)의 고유 값 추출
    if (targetHeader) { // 매핑된 헤더가 있을 경우에만 CSV 처리
        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvData = await response.text();
            const lines = csvData.split(/\r?\n/); // 다양한 줄바꿈 처리

            if (lines.length > 0) {
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                const columnIndex = headers.findIndex(header => header === targetHeader);

                if (columnIndex === -1) {
                    console.warn(`Column header '${targetHeader}' not found in CSV for baseId '${baseId}'.`);
                } else {
                    for (let i = 1; i < lines.length; i++) {
                        // 각 라인을 파싱하되, 쉼표가 값 안에 포함된 경우 고려 (간단 처리)
                        // 완벽한 CSV 파싱은 라이브러리 사용 권장
                         const columns = lines[i].split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                         //const columns = parseCsvLine(lines[i]); // 더 강력한 파서 필요 시

                        if (columns.length > columnIndex) {
                            const value = columns[columnIndex];
                            if (value) {
                                defaultOptions.add(value);
                            }
                        }
                    }
                }
            }
        } catch (error) {
            console.error(`Error loading or parsing CSV for ${baseId}:`, error);
            // 사용자에게 오류 메시지 표시 등 추가 처리 가능
        }
    } else {
         console.warn(`No CSV header mapping found for baseId '${baseId}'. Skipping CSV load.`);
    }


    // Set에 저장된 고유 값들로 기본 옵션 li 생성
    defaultOptions.forEach(value => {
        const li = createOptionLi(value, value, 'default');
        optionsList.insertBefore(li, addOptionButton);
    });

    // 2. LocalStorage 로드 및 커스텀 옵션 추가
    const storageKey = `${LS_KEY_PREFIX}${baseId}`; // 동적 키 생성
    const customValues = JSON.parse(localStorage.getItem(storageKey) || '[]');
    const existingValues = new Set(Array.from(optionsList.querySelectorAll('li[data-value]')).map(li => li.dataset.value));

    customValues.forEach(value => {
        const lowerCaseValue = String(value).toLowerCase();
        if (!existingValues.has(lowerCaseValue)) {
            const li = createOptionLi(value, value, 'custom');
            optionsList.insertBefore(li, addOptionButton);
            existingValues.add(lowerCaseValue);
        }
    });
}

// LocalStorage 저장 함수 (수정됨: 동적 키 사용)
function saveCustomOptionsToStorage(baseId) {
    const optionsList = document.getElementById(`${baseId}_options_list`);
    if (!optionsList) return;
    const storageKey = `${LS_KEY_PREFIX}${baseId}`;
    const customValues = [];
    optionsList.querySelectorAll('li[data-type="custom"]').forEach(li => {
        const contentElement = li.querySelector('.option-content');
        if(contentElement) {
            customValues.push(contentElement.textContent);
        }
    });
    localStorage.setItem(storageKey, JSON.stringify(customValues));
}

// Dropdown Interaction Setup 함수 (수정됨: baseId 기반으로 요소 찾기)
function setupDropdownInteractions(baseId) {
    const dropdown = document.getElementById(`${baseId}_dropdown`);
    const selectedValueDiv = document.getElementById(`${baseId}_selected_value`);
    const optionsList = document.getElementById(`${baseId}_options_list`);
    const hiddenInput = document.getElementById(baseId); // 숨겨진 input은 baseId 사용
    const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
    const addInputContainer = document.getElementById(`${baseId}_add_input_container`);
    const addInput = document.getElementById(`${baseId}_add_input`);

    // 요소 존재 여부 확인
     if (!dropdown || !selectedValueDiv || !optionsList || !hiddenInput || !addOptionButton || !addInputContainer || !addInput) {
        // console.warn(`One or more dropdown elements missing for baseId: ${baseId}`);
        return; // 필수 요소 없으면 설정 중단
    }

    // 드롭다운 열기/닫기
    selectedValueDiv.addEventListener('click', (event) => {
        event.stopPropagation();
        closeOtherDropdowns(baseId); // 다른 드롭다운 닫기
        optionsList.classList.toggle('hidden');
        addInputContainer.classList.add('hidden'); // 추가 입력창은 항상 닫음
    });

    // 옵션 리스트 이벤트 처리 (이벤트 위임)
    optionsList.addEventListener('click', (event) => {
        event.stopPropagation();
        const targetLi = event.target.closest('li');

        // 1. 삭제 버튼 클릭
        if (event.target.classList.contains('delete-btn') && targetLi && targetLi.dataset.type === 'custom') {
             const textContent = targetLi.querySelector('.option-content')?.textContent || targetLi.dataset.value;
             if (confirm(`'${textContent}' 항목을 삭제하시겠습니까?`)) {
                if (hiddenInput.value === targetLi.dataset.value) {
                    selectedValueDiv.textContent = '-- 선택하세요 --';
                    hiddenInput.value = '';
                }
                targetLi.remove();
                saveCustomOptionsToStorage(baseId);
                updateFinalURL();
            }
        }
        // 2. "+옵션 추가" 클릭
        else if (targetLi && targetLi.classList.contains('add-option')) {
             addInputContainer.classList.remove('hidden');
             addInput.value = '';
             addInput.focus();
        }
        // 3. 일반 옵션 항목 클릭
        else if (targetLi && targetLi.dataset.value) {
            const value = targetLi.dataset.value;
            const text = targetLi.querySelector('.option-content')?.textContent || value;

            selectedValueDiv.textContent = text;
            hiddenInput.value = value;
            optionsList.classList.add('hidden');
            addInputContainer.classList.add('hidden');
            updateFinalURL();
        }
    });

    // 새 옵션 입력 (Enter 키)
    addInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            const newValue = addInput.value.trim();
            const lowerCaseValue = newValue.toLowerCase();

            // 유효성 검사 (Key 기준)
            if (!newValue) { alert('추가할 값을 입력해주세요.'); return; }
            // 네이밍 규칙 검사 강화 (선택적) - 공백 및 특정 특수문자 제한
             if (/\s|&|\?|#|\.|\/|\\/.test(newValue)) {
                 alert("띄어쓰기 및 특수문자(&, ?, #, ., /, \\)는 사용할 수 없습니다.");
                 return;
            }
            // Key로는 소문자/숫자/_/- 만 허용 (기존 규칙 유지)
            if (/[^a-z0-9_\-]/.test(lowerCaseValue)) {
               alert("Key 값(소문자 변환값)은 영문 소문자, 숫자, 언더스코어(_), 하이픈(-)만 사용할 수 있습니다.");
               return;
             }


            // 중복 검사 (Key 기준)
            let exists = false;
            optionsList.querySelectorAll('li[data-value]').forEach(li => {
                if(li.dataset.value === lowerCaseValue) exists = true;
            });
            if (exists) { alert("이미 존재하는 값(소문자 변환 기준)입니다."); return; }

            const newLi = createOptionLi(newValue, newValue, 'custom'); // 표시 텍스트는 원본 사용
            optionsList.insertBefore(newLi, addOptionButton);

            saveCustomOptionsToStorage(baseId);
            selectedValueDiv.textContent = newValue;    // 선택 영역에 표시 텍스트
            hiddenInput.value = lowerCaseValue;     // 숨겨진 input에 Key 값
            addInputContainer.classList.add('hidden');
            optionsList.classList.add('hidden');
            updateFinalURL();
        }
    });

    // 입력 필드 포커스 아웃 시 숨김
    addInput.addEventListener('blur', () => {
        setTimeout(() => {
            // 여전히 입력창이나 그 안의 요소에 포커스가 있다면 숨기지 않음
            if (!addInputContainer.contains(document.activeElement)) {
                 addInputContainer.classList.add('hidden');
            }
        }, 150); // 약간의 딜레이를 주어 다른 요소 클릭 시 처리 시간 확보
    });
}

// 다른 드롭다운 닫기 헬퍼
function closeOtherDropdowns(currentBaseId) {
    dropdownBaseIds.forEach(baseId => {
        if (baseId !== currentBaseId) {
            document.getElementById(`${baseId}_options_list`)?.classList.add('hidden');
            document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden');
        }
    });
}

// 외부 클릭 시 모든 드롭다운 닫기
document.addEventListener('click', (event) => {
     dropdownBaseIds.forEach(baseId => {
         const dropdownElement = document.getElementById(`${baseId}_dropdown`);
         if (dropdownElement && !dropdownElement.contains(event.target)) {
             document.getElementById(`${baseId}_options_list`)?.classList.add('hidden');
             document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden');
         }
     });
});


// === UTM 조합 및 URL 업데이트 함수 (기존 로직 유지) ===

// 값 가져오기 (없으면 'N')
function getValueOrN(id) {
    const element = document.getElementById(id);
    // 숨겨진 input 이거나 text input 일 수 있으므로 value 확인
    const value = element ? element.value.trim() : "";
    return value === "" ? "N" : value;
}

// Form Submit 시 UTM 값 조합 (기존 로직 유지)
function combineUTMValues() {
    // 필수 항목 체크 (숨겨진 input 기준)
    const requiredIds = ["source", "medium", "campaign_date", "ad_type", "device_type"];
    for (let id of requiredIds) {
        const element = document.getElementById(id);
        if (!element || element.value.trim() === "") {
            // 사용자 친화적 메시지: label 텍스트 가져오기 시도
            const label = document.querySelector(`label[for='${id}']`) || document.getElementById(`${id}_dropdown`)?.previousElementSibling;
            const fieldName = label ? label.textContent.replace(/ \(.+\):/, '').trim() : id; // 레이블 텍스트 정리
             alert(`필수 항목 '${fieldName}'을(를) 선택 또는 입력해주세요.`);
             element?.focus(); // 해당 필드로 포커스 이동 시도
             return false; // 제출 중단
        }
    }

    // utm_campaign 조합
    const campaignParts = [
        getValueOrN("campaign_date"),
        getValueOrN("ad_type"),
        getValueOrN("campaign_goal"),
        getValueOrN("event_type"),       // ID 기준
        getValueOrN("product_category"), // ID 기준
        getValueOrN("ad_target"),
        getValueOrN("creative_type"),
        getValueOrN("device_type")
    ];
    document.getElementById("utm_campaign").value = campaignParts.join("_");

    // utm_content 조합
    const contentParts = [
        getValueOrN("content_action"),   // ID 기준
        getValueOrN("content_detail"),
        getValueOrN("content_version")
    ];
    // 모든 부분이 'N'일 경우만 'N'으로, 아니면 조합
    const utmContentValue = contentParts.every(part => part === "N") ? "N" : contentParts.join("_");
    document.getElementById("utm_content").value = utmContentValue;

    // 최종 URL 업데이트 (실제 제출 전에 마지막 업데이트)
    updateFinalURL();

    // 여기서 실제 폼 제출 로직이 이어지거나, 다른 작업 수행 가능
    console.log("Form Submitted (Simulated)");
    console.log("Generated Campaign:", document.getElementById("utm_campaign").value);
    console.log("Generated Content:", document.getElementById("utm_content").value);
    console.log("Final URL:", document.getElementById("final_url").value);

    // TODO: 히스토리 저장 로직 (필요시 구현)
    // saveHistory();

    // 실제 서버 전송 대신 예시로 alert 띄우기 (실제 사용 시 제거/수정)
    alert("UTM 링크가 생성되었습니다. 최종 URL을 확인하세요.\n(실제 서버 전송은 구현되지 않았습니다)");
    return false; // 실제 폼 제출 방지 (테스트용)

    // return true; // 실제 폼 제출을 원할 경우 true 반환
}

// 최종 URL 실시간 업데이트 (기존 로직 유지, utm_content 조건 수정)
function updateFinalURL() {
    const pageUrl = document.getElementById("page_url").value.trim();
    const utmSource = document.getElementById("source").value.trim(); // ID 변경 반영
    const utmMedium = document.getElementById("medium").value.trim(); // ID 변경 반영

    // 실시간 utm_campaign 조합
    const utmCampaign = [
        getValueOrN("campaign_date"),
        getValueOrN("ad_type"),
        getValueOrN("campaign_goal"),
        getValueOrN("event_type"),
        getValueOrN("product_category"),
        getValueOrN("ad_target"),
        getValueOrN("creative_type"),
        getValueOrN("device_type")
    ].join("_");

    // 실시간 utm_content 조합
    const contentParts = [
        getValueOrN("content_action"),
        getValueOrN("content_detail"),
        getValueOrN("content_version")
    ];
    const utmContent = contentParts.every(part => part === "N") ? "N" : contentParts.join("_");

    const utmTerm = document.getElementById("utm_term").value.trim();

    // URL 조합 시작
    let finalURL = pageUrl;
    const params = [];

    if (utmSource) params.push(`utm_source=${encodeURIComponent(utmSource)}`);
    if (utmMedium) params.push(`utm_medium=${encodeURIComponent(utmMedium)}`);
    if (utmCampaign) params.push(`utm_campaign=${encodeURIComponent(utmCampaign)}`); // 항상 포함 (필수값 기반)
    if (utmContent && utmContent !== "N") params.push(`utm_content=${encodeURIComponent(utmContent)}`); // 모든 부분이 N일 경우 제외
    if (utmTerm) params.push(`utm_term=${encodeURIComponent(utmTerm)}`);

    if (params.length > 0) {
        finalURL += (pageUrl.includes('?') ? '&' : '?') + params.join('&');
    }

    document.getElementById("final_url").value = finalURL;
}

// --- 이력 관리 함수 (필요시 구현) ---
// function saveHistory() { ... }
// function loadHistory() { ... }

// --- CSV 파싱 보조 함수 (선택적, 간단 버전) ---
// function parseCsvLine(line) {
//   // 더 복잡한 CSV (따옴표 안의 쉼표 등) 처리가 필요하면 정규식 또는 라이브러리 사용
//   return line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
// }


</script>
</body>
</html>