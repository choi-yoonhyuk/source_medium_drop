<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTM ë§í¬ ìƒì„±ê¸° (n8n ì—°ë™ - ì¤‘ë³µ ì˜µì…˜ ì „ì†¡ ë°©ì§€)</title>
<style>
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ - ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ */
body { font-family: sans-serif; padding: 20px; font-size: 14px; }
.dv1, .dv2, .dv3 { margin-bottom: 20px; }
label { display: inline-block; min-width: 120px; margin-bottom: 5px; vertical-align: top; padding-top: 8px; }
input[type="text"] { padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px; vertical-align: middle; }
input[type="text"]#final_url { background-color: #eee; }
button { padding: 8px 15px; margin-left: 5px; cursor: pointer; vertical-align: middle; }
fieldset { margin-bottom: 20px; border:1px solid #ccc; padding:10px; }
legend { font-weight: bold; }
.required { color: red; font-weight: bold; }
.hidden { display: none !important; }

/* ë¡œë”© ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ - ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ */
#loadingIndicator {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(255, 255, 255, 0.7);
    z-index: 1000; display: flex; align-items: center; justify-content: center;
    font-weight: bold; font-size: 1.2em; display: none;
}

/* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ - ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ */
.custom-dropdown-container { display: inline-block; vertical-align: top; }
.custom-dropdown {
    position: relative; display: inline-block; min-width: 200px; width: auto;
    max-width: 300px; border: 1px solid #ccc; border-radius: 4px;
    background-color: #fff; margin-bottom: 10px;
}
.dropdown-selected {
    padding: 8px; cursor: pointer; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis; display: block;
}
.dropdown-selected::after {
    content: 'â–¼'; font-size: 0.8em; position: absolute; right: 10px;
    top: 50%; transform: translateY(-50%); color: #888;
}
.dropdown-options {
    position: absolute; top: 100%; left: 0; right: 0;
    background-color: #fff; border: 1px solid #ccc; border-top: none;
    border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto;
    list-style: none; padding: 0; margin: 0; z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dropdown-options li {
    padding: 8px 10px; cursor: pointer; display: flex;
    align-items: center; justify-content: space-between; white-space: nowrap;
}
.dropdown-options li:hover { background-color: #f0f0f0; }
.dropdown-options li .option-content {
    flex-grow: 1; margin-left: 8px; overflow: hidden; text-overflow: ellipsis;
}
.dropdown-options li .icon {
    display: inline-block; width: 10px; height: 10px;
    border-radius: 50%; background-color: #ddd; flex-shrink: 0;
}
.dropdown-options li[data-type="default"] .icon { background-color: #aaa; }
.dropdown-options li[data-type="custom"] .icon { background-color: #6aabff; }
.dropdown-options li .delete-btn {
    background: none; border: none; color: #aaa; cursor: pointer;
    font-size: 1.1em; padding: 0 5px; margin-left: 10px;
    flex-shrink: 0; font-weight: bold;
}
.dropdown-options li .delete-btn:hover { color: #f00; }
.dropdown-options li[data-type="default"] .delete-btn { display: none; }
.dropdown-options .add-option {
    color: #007bff; font-weight: bold; border-top: 1px solid #eee;
}
.add-option-input {
    padding: 5px; border-top: 1px solid #eee; background-color: #f9f9f9;
}
.add-option-input input[type="text"] {
    width: calc(100% - 16px); margin: 0; box-sizing: border-box;
}

/* ì‘ë‹µ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
#responseContainer {
    display: none; /* ì´ˆê¸° ìˆ¨ê¹€ */
    margin-top: 20px;
}
#responseContainer input[type="text"] { /* ë‹¨ì¶• URL ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ì¡°ì • */
    width: calc(100% - 100px); /* ë²„íŠ¼ ê³µê°„ í™•ë³´ */
    margin-right: 10px;
}
</style>
</head>
<body>
<div id="loadingIndicator">ë¡œë”© ì¤‘...</div>

<div class="dv1">
<div class="dv2">
    <h1>UTM ë§í¬ ìƒì„±</h1>
    <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;">
        <thead><tr><th colspan="2">UTM ë„¤ì´ë° ê·œì¹™</th></tr></thead>
        <tbody>
            <tr><td>ê³µí†µ ê·œì¹™</td><td><ul><li>ë„ì–´ì“°ê¸° ê¸ˆì§€</li><li>êµ¬ë¶„ì: ì–¸ë”ìŠ¤ì½”ì–´('_') ë° í•˜ì´í”ˆ('-') ì‚¬ìš©</li><li>ì˜ë¬¸ ë„¤ì´ë°: ì†Œë¬¸ìë§Œ ì‚¬ìš©</li><li>íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ê¸ˆì§€ (&amp;, ?, #, ., /, \ ë“±)</li></ul></td></tr>
            <tr><td>ìº í˜ì¸ ê·œì¹™</td><td><ul><li>êµ¬ì„±: ë‚ ì§œ_ê´‘ê³ íƒ€ì…_ìº í˜ì¸ëª©í‘œ_ê¸°íšì „ì¢…ë¥˜_ìƒí’ˆì¹´í…Œê³ ë¦¬_ê´‘ê³ íƒ€ê²Ÿ_ì†Œì¬íƒ€ì…_ê¸°ê¸°ì¹´í…Œê³ ë¦¬</li><li>ì—†ìœ¼ë©´ 'N'ìœ¼ë¡œ ì±„ì›€</li><li><span class="required">í•„ìˆ˜ í•­ëª©: ë‚ ì§œ, ê´‘ê³ íƒ€ì…, ê¸°ê¸°ì¹´í…Œê³ ë¦¬</span></li></ul></td></tr>
            <tr><td>ì½˜í…ì¸  ê·œì¹™</td><td><ul><li>ëª©í‘œí–‰ë™, ì¶”ê°€ê¸°ì…ì‚¬í•­, ë²„ì „ ì¤‘ í•˜ë‚˜ë¼ë„ ì…ë ¥ë˜ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ì¡°í•©</li><li>ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ 'N'ìœ¼ë¡œ ì²˜ë¦¬</li></ul></td></tr>
        </tbody>
    </table>
    <br>
</div>

<div class="dv3">
    <form id="utmForm">
        <label for="page_url">Page URL <span class="required">(í•„ìˆ˜)</span>:</label>
        <input type="text" id="page_url" name="page_url" required placeholder="https://example.com" oninput="updateFinalURL()"><br><br>

        <label for="source">UTM Source <span class="required">(í•„ìˆ˜)</span>:</label>
        <div class="custom-dropdown-container">
            <div class="custom-dropdown" id="source_dropdown">
                <div class="dropdown-selected" id="source_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                <ul class="dropdown-options hidden" id="source_options_list">
                    <li class="add-option" id="source_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                </ul>
                <div class="add-option-input hidden" id="source_add_input_container">
                    <input type="text" id="source_add_input" placeholder="ì…ë ¥ í›„ Enter">
                </div>
            </div>
            <input type="hidden" id="source" name="utm_source" required>
        </div>
        <br><br>

        <label for="medium">UTM Medium <span class="required">(í•„ìˆ˜)</span>:</label>
        <div class="custom-dropdown-container">
            <div class="custom-dropdown" id="medium_dropdown">
                <div class="dropdown-selected" id="medium_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                <ul class="dropdown-options hidden" id="medium_options_list">
                    <li class="add-option" id="medium_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                </ul>
                <div class="add-option-input hidden" id="medium_add_input_container">
                    <input type="text" id="medium_add_input" placeholder="ì…ë ¥ í›„ Enter">
                </div>
            </div>
            <input type="hidden" id="medium" name="utm_medium" required>
        </div>
        <br><br>
        
        <fieldset style="border:1px solid #ccc; padding:10px;">
            <legend>UTM Campaign êµ¬ì„±</legend>
        
            <label for="campaign_date">ë‚ ì§œ <span class="required">(í•„ìˆ˜)</span>:</label>
            <input type="text" id="campaign_date" name="campaign_date_display_id_matching_getvalueorn" placeholder="YYYYMMDD" oninput="updateFinalURL()" required><br><br> 
            <label for="ad_type">ê´‘ê³ íƒ€ì… <span class="required">(í•„ìˆ˜)</span>:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="ad_type_dropdown">
                    <div class="dropdown-selected" id="ad_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="ad_type_options_list"> <li class="add-option" id="ad_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li> </ul>
                    <div class="add-option-input hidden" id="ad_type_add_input_container"><input type="text" id="ad_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="ad_type" name="ad_type_val" required>
            </div><br><br>
            
            <label for="campaign_goal">ìº í˜ì¸ëª©í‘œ:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="campaign_goal_dropdown">
                    <div class="dropdown-selected" id="campaign_goal_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="campaign_goal_options_list"><li class="add-option" id="campaign_goal_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="campaign_goal_add_input_container"><input type="text" id="campaign_goal_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="campaign_goal" name="campaign_goal_val">
            </div><br><br>
            
            <label for="event_type">ê¸°íšì „ì¢…ë¥˜:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="event_type_dropdown">
                    <div class="dropdown-selected" id="event_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="event_type_options_list"><li class="add-option" id="event_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="event_type_add_input_container"><input type="text" id="event_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="event_type" name="event_type_val"> 
            </div><br><br>

            <label for="product_category">ìƒí’ˆì¹´í…Œê³ ë¦¬:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="product_category_dropdown">
                    <div class="dropdown-selected" id="product_category_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="product_category_options_list"><li class="add-option" id="product_category_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="product_category_add_input_container"><input type="text" id="product_category_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="product_category" name="product_category_val"> 
            </div><br><br>

            <label for="ad_target">ê´‘ê³ íƒ€ê²Ÿ:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="ad_target_dropdown">
                    <div class="dropdown-selected" id="ad_target_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="ad_target_options_list"><li class="add-option" id="ad_target_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="ad_target_add_input_container"><input type="text" id="ad_target_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="ad_target" name="ad_target_val"> 
            </div><br><br>

            <label for="creative_type">ì†Œì¬íƒ€ì…:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="creative_type_dropdown">
                    <div class="dropdown-selected" id="creative_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="creative_type_options_list"><li class="add-option" id="creative_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="creative_type_add_input_container"><input type="text" id="creative_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="creative_type" name="creative_type_val"> 
            </div><br><br>

            <label for="device_type">ê¸°ê¸°ì¹´í…Œê³ ë¦¬ <span class="required">(í•„ìˆ˜)</span>:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="device_type_dropdown">
                    <div class="dropdown-selected" id="device_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="device_type_options_list"><li class="add-option" id="device_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="device_type_add_input_container"><input type="text" id="device_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="device_type" name="device_type_val" required> 
            </div><br><br>
        </fieldset>
    
        <fieldset style="border:1px solid #ccc; padding:10px;">
            <legend>UTM Content êµ¬ì„±</legend>
            <label for="content_action">ëª©í‘œí–‰ë™:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="content_action_dropdown">
                    <div class="dropdown-selected" id="content_action_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="content_action_options_list"><li class="add-option" id="content_action_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="content_action_add_input_container"><input type="text" id="content_action_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="content_action" name="content_action_val"> 
            </div><br><br>
        
            <label for="content_detail">ì¶”ê°€ê¸°ì…ì‚¬í•­:</label>
            <input type="text" id="content_detail" name="content_detail_display_id_matching_getvalueorn" placeholder="120X240-vertical" oninput="updateFinalURL()"><br><br> 
            <label for="content_version">ë²„ì „:</label>
            <input type="text" id="content_version" name="content_version_display_id_matching_getvalueorn" placeholder="v1" oninput="updateFinalURL()"><br><br> 
        </fieldset>

        <label for="utm_term">UTM Term (ì„ íƒ):</label>
        <input type="text" id="utm_term" name="utm_term_display_id_matching_getvalueorn" placeholder="shoes" oninput="updateFinalURL()"><br><br> <input type="hidden" id="utm_campaign" name="utm_campaign" required>
        <input type="hidden" id="utm_content" name="utm_content">

        <label for="final_url">ìµœì¢… URL:</label>
        <input type="text" id="final_url" name="final_url_display" disabled style="width:100%; font-family:monospace;"> 
        <button type="submit">ì œì¶œ</button>
    </form>

    <div id="responseContainer">
        <label for="shortUrlInput">ğŸ”— ë‹¨ì¶• URL:</label>
        <input type="text" id="shortUrlInput" readonly="" style="font-family:monospace;">
        <button type="button" onclick="copyLink()">ğŸ“‹ ë³µì‚¬</button>
    </div>

    <div id="historyTableContainer" style="margin-top: 30px;">
        <h2>ìƒì„± ì´ë ¥</h2>
        <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;" id="historyTable">
            <thead><tr><th>ìƒì„±ì¼ì‹œ</th><th>Source</th><th>Medium</th><th>Campaign</th><th>Content</th><th>Term</th><th>í˜ì´ì§€ URL</th><th>ìµœì¢… URL</th><th>ë‹¨ì¶• URL</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</div>

<script>
// --- ì„¤ì •ê°’ ---
const LS_KEY_PREFIX = 'utmGenerator_standalone_';
const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1861589139&single=true&output=csv';
const N8N_WEBHOOK_URL = 'https://entrench-consulting.app.n8n.cloud/webhook-test/15daaf64-30ee-4b32-9426-45a8c8bd9184'; // <-- ì¤‘ìš”: ì‹¤ì œ n8n URLë¡œ ë³€ê²½!
const HISTORY_JSON_URL = 'https://raw.githubusercontent.com/choi-yoonhyuk/source_medium_drop/main/n8n-builder.json'; 
// ì°¸ê³ : HISTORY_JSON_URLì€ n8n ì›Œí¬í”Œë¡œìš°ê°€ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜, êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ì´ë ¥ì„ ê°€ì ¸ì˜¤ë„ë¡ ë³€ê²½ ê³ ë ¤

const dropdownBaseIds = [
    'source', 'medium', 'ad_type', 'campaign_goal', 'event_type', 
    'product_category', 'ad_target', 'creative_type', 'device_type', 'content_action'
];

const columnHeaderMap = { // CSV íŒŒì‹± ì‹œ ì–´ë–¤ ì—´ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ì§€ ë§¤í•‘
    'source': 'source', 'medium': 'medium', 'ad_type': 'utm_campaign_ad_type',
    'campaign_goal': 'utm_campaign_goal', 'event_type': 'utm_campaign_event_type',
    'product_category': 'utm_campaign_product_category', 'ad_target': 'utm_campaign_ad_target',
    'creative_type': 'utm_campaign_creative_type', 'device_type': 'utm_campaign_device_type',
    'content_action': 'utm_content_content_action'
};

// --- ì „ì—­ ë³€ìˆ˜: ë§ˆìŠ¤í„° ì˜µì…˜ ëª©ë¡ ì €ì¥ìš© ---
let masterOptionLists = {}; // ì˜ˆ: masterOptionLists.source = Set {'google', 'naver', ...}

// --- ì´ˆê¸°í™” ---
document.addEventListener('DOMContentLoaded', async () => {
    showLoading("ì˜µì…˜ ë° ì´ë ¥ ë¡œë”© ì¤‘...");
    let csvDataText = null;
    try {
        const response = await fetch(GOOGLE_SHEET_CSV_URL);
        if (!response.ok) throw new Error(`CSV ë¡œë“œ ì‹¤íŒ¨ (${response.status})`);
        csvDataText = await response.text();
        console.log("CSV ë°ì´í„° ë¡œë“œ ì™„ë£Œ");

        parseAndStoreMasterOptions(csvDataText); // ë§ˆìŠ¤í„° ì˜µì…˜ ëª©ë¡ íŒŒì‹± ë° ì €ì¥

        for (const baseId of dropdownBaseIds) {
            try {
                renderDropdownWithOptions(baseId); // ë“œë¡­ë‹¤ìš´ UI ë Œë”ë§
                setupDropdownInteractions(baseId);
            } catch (error) {
                console.error(`Error initializing dropdown for ${baseId}:`, error);
            }
        }
        updateFinalURL(); 
        await renderHistoryTable(); 
    } catch (error) {
        console.error("ì´ˆê¸° ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
        alert("ì´ˆê¸° ë°ì´í„°(ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë˜ëŠ” ì´ë ¥)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
        hideLoading();
    }
});

// === Helper Functions (ê¸°ì¡´ê³¼ ë™ì¼) ===
function showLoading(message = "ì²˜ë¦¬ ì¤‘...") { /* ë‚´ìš© ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼ */ }
function hideLoading() { /* ë‚´ìš© ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼ */ }
function createOptionLi(value, displayText, type) { /* ë‚´ìš© ìˆ˜ì •ë¨ - ì•„ë˜ ì°¸ì¡° */ }
function saveCustomOptionsToStorage(baseId) { /* ë‚´ìš© ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼ */ }
function closeOtherDropdowns(currentBaseId) { /* ë‚´ìš© ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼ */ }
document.addEventListener('click', (event) => { /* ë‚´ìš© ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼ */ });

// --- ìˆ˜ì •ëœ Helper Functions ---
function createOptionLi(value, displayText, type) { // valueì™€ displayText ëª¨ë‘ ì›ë³¸ ëŒ€ì†Œë¬¸ì ìœ ì§€í•˜ë„ë¡ ìˆ˜ì •
    const li = document.createElement('li');
    const valueForDataset = String(value).trim().toLowerCase(); // data-valueëŠ” ì†Œë¬¸ì/ê³µë°±ì œê±°ë¡œ í†µì¼ (ë¹„êµìš©)
    li.dataset.value = valueForDataset; 
    li.dataset.type = type;

    const iconSpan = document.createElement('span'); iconSpan.className = 'icon'; li.appendChild(iconSpan);
    const textSpan = document.createElement('span'); textSpan.className = 'option-content'; 
    textSpan.textContent = String(displayText).trim() || String(value).trim(); // í™”ë©´ í‘œì‹œëŠ” ì›ë³¸ ëŒ€ì†Œë¬¸ì
    li.appendChild(textSpan);

    if (type === 'custom') {
        const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; li.appendChild(deleteBtn);
    }
    return li;
}

// --- ì‹ ê·œ í•¨ìˆ˜: CSV íŒŒì‹±í•˜ì—¬ masterOptionListsì— ì €ì¥ ---
function parseAndStoreMasterOptions(csvDataText) {
    if (!csvDataText) {
        console.warn("CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´ ë§ˆìŠ¤í„° ì˜µì…˜ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        dropdownBaseIds.forEach(baseId => { masterOptionLists[baseId] = new Set(); }); // ëª¨ë“  baseIdì— ëŒ€í•´ ë¹ˆ Setìœ¼ë¡œ ì´ˆê¸°í™”
        return;
    }
    try {
        const lines = csvDataText.split(/\r?\n/);
        if (lines.length < 3) { // ìµœì†Œ í—¤ë”, íƒ€ì…, ë°ì´í„° 1ì¤„ í•„ìš” (ì‹¤ì œ ë°ì´í„°ëŠ” 3ë²ˆì§¸ ì¤„ë¶€í„°)
            console.warn("CSV ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ì˜µì…˜ ë°ì´í„°ëŠ” 3ë²ˆì§¸ ì¤„ë¶€í„° ì‹œì‘).");
            dropdownBaseIds.forEach(baseId => { masterOptionLists[baseId] = new Set(); });
            return;
        }
        const headers = lines[0].split(',').map(h => String(h).trim().replace(/^"|"$/g, ''));
        
        for (const baseId of dropdownBaseIds) {
            const targetCsvHeader = columnHeaderMap[baseId]; // CSVì—ì„œ ì°¾ì„ í—¤ë” ì´ë¦„
            if (!targetCsvHeader) {
                console.warn(`No CSV header mapping for dropdown baseId '${baseId}'.`);
                masterOptionLists[baseId] = new Set();
                continue;
            }

            const columnIndex = headers.findIndex(header => header === targetCsvHeader);
            if (columnIndex === -1) {
                console.warn(`CSVì—ì„œ '<span class="math-inline">\{targetCsvHeader\}' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ \(for baseId '</span>{baseId}').`);
                masterOptionLists[baseId] = new Set();
                continue;
            }

            const optionsForThisCategory = new Set();
            for (let i = 2; i < lines.length; i++) { // ì‹¤ì œ ì˜µì…˜ ë°ì´í„°ëŠ” 3ë²ˆì§¸ ì¤„(index 2)ë¶€í„° ì‹œì‘í•œë‹¤ê³  ê°€ì •
                const columns = lines[i].split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                if (columns.length > columnIndex) {
                    const value = String(columns[columnIndex]).trim();
                    if (value) { // ë¹ˆ ê°’ì€ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                        optionsForThisCategory.add(value); // ì›ë³¸ ëŒ€ì†Œë¬¸ì ìœ ì§€í•˜ì—¬ Setì— ì €ì¥
                    }
                }
            }
            masterOptionLists[baseId] = optionsForThisCategory;
            // console.log(`Master options for ${baseId}:`, Array.from(optionsForThisCategory)); // í•„ìš”ì‹œ ë¡œê¹…
        }
    } catch (error) {
        console.error("Error parsing master options CSV:", error);
        dropdownBaseIds.forEach(baseId => {
            if (!masterOptionLists[baseId]) masterOptionLists[baseId] = new Set();
        });
    }
}

// --- ìˆ˜ì •ëœ í•¨ìˆ˜: masterOptionListsì™€ localStorageë¥¼ ì‚¬ìš©í•˜ì—¬ ë“œë¡­ë‹¤ìš´ UI ë Œë”ë§ ---
function renderDropdownWithOptions(baseId) {
    const optionsList = document.getElementById(`${baseId}_options_list`);
    const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
    if (!optionsList || !addOptionButton) {
        console.error(`Dropdown elements not found for ${baseId}`);
        return;
    }

    optionsList.innerHTML = ''; 
    optionsList.appendChild(addOptionButton); 

    const defaultOptionsFromMaster = masterOptionLists[baseId] || new Set();
    const allRenderedValuesLowerCase = new Set(); // í™”ë©´ì— ì¤‘ë³µ ë Œë”ë§ ë°©ì§€ (ì†Œë¬¸ì ê¸°ì¤€)

    // 1. ë§ˆìŠ¤í„° ëª©ë¡(CSVì—ì„œ ë¡œë“œ) ì˜µì…˜ ë Œë”ë§ (ì›ë³¸ ëŒ€ì†Œë¬¸ì ìœ ì§€)
    defaultOptionsFromMaster.forEach(originalValue => {
        const valueTrimmed = String(originalValue).trim();
        const lowerCaseValue = valueTrimmed.toLowerCase();
        if (valueTrimmed && !allRenderedValuesLowerCase.has(lowerCaseValue)) {
            const li = createOptionLi(valueTrimmed, valueTrimmed, 'default');
            optionsList.insertBefore(li, addOptionButton);
            allRenderedValuesLowerCase.add(lowerCaseValue);
        }
    });

    // 2. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì»¤ìŠ¤í…€ ì˜µì…˜ ë Œë”ë§ (ë§ˆìŠ¤í„° ëª©ë¡ ë° í˜„ì¬ ë Œë”ë§ëœ ëª©ë¡ì— ì—†ëŠ” ê²ƒë§Œ)
    const storageKey = `<span class="math-inline">\{LS\_KEY\_PREFIX\}</span>{baseId}`;
    const customValuesFromStorage = JSON.parse(localStorage.getItem(storageKey) || '[]');
    
    customValuesFromStorage.forEach(originalValueFromStorage => {
        const valueTrimmed = String(originalValueFromStorage).trim();
        const lowerCaseValue = valueTrimmed.toLowerCase();

        if (valueTrimmed && !allRenderedValuesLowerCase.has(lowerCaseValue)) {
            let isInMasterListAlready = false;
            defaultOptionsFromMaster.forEach(masterOpt => { // ë§ˆìŠ¤í„° ëª©ë¡ê³¼ë„ ë¹„êµ
                if (String(masterOpt).trim().toLowerCase() === lowerCaseValue) {
                    isInMasterListAlready = true;
                }
            });

            if (!isInMasterListAlready) {
                const li = createOptionLi(valueTrimmed, valueTrimmed, 'custom');
                optionsList.insertBefore(li, addOptionButton);
                allRenderedValuesLowerCase.add(lowerCaseValue);
            }
        }
    });
}

function setupDropdownInteractions(baseId) {
    // ë‚´ìš© ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼ (ë‹¨, ë‚´ë¶€ì—ì„œ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ ë¶€ë¶„ì€ ì œê±°ë¨)
    const dropdown = document.getElementById(`${baseId}_dropdown`);
    const selectedValueDiv = document.getElementById(`${baseId}_selected_value`);
    const optionsList = document.getElementById(`${baseId}_options_list`);
    const hiddenInput = document.getElementById(baseId); 
    const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
    const addInputContainer = document.getElementById(`${baseId}_add_input_container`);
    const addInput = document.getElementById(`${baseId}_add_input`);

    if (!dropdown || !selectedValueDiv || !optionsList || !hiddenInput || !addOptionButton || !addInputContainer || !addInput) return;

    selectedValueDiv.addEventListener('click', (event) => {
        event.stopPropagation(); closeOtherDropdowns(baseId); optionsList.classList.toggle('hidden'); addInputContainer.classList.add('hidden');
    });

    optionsList.addEventListener('click', (event) => {
        event.stopPropagation(); 
        const targetLi = event.target.closest('li');
        if (event.target.classList.contains('delete-btn') && targetLi && targetLi.dataset.type === 'custom') {
            const textContent = targetLi.querySelector('.option-content')?.textContent || targetLi.dataset.value;
            if (confirm(`'${textContent}' í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¸Œë¼ìš°ì € ì €ì¥ì†Œì—ì„œë§Œ ì‚­ì œë©ë‹ˆë‹¤)`)) {
                if (hiddenInput.value === targetLi.dataset.value) { 
                    selectedValueDiv.textContent = '-- ì„ íƒí•˜ì„¸ìš” --'; 
                    hiddenInput.value = ''; 
                }
                targetLi.remove(); 
                saveCustomOptionsToStorage(baseId); 
                updateFinalURL();
            }
        } else if (targetLi && targetLi.classList.contains('add-option')) {
            addInputContainer.classList.remove('hidden'); addInput.value = ''; addInput.focus();
        } else if (targetLi && typeof targetLi.dataset.value !== 'undefined') {
            const value = targetLi.dataset.value; // data-valueëŠ” ì†Œë¬¸ì
            const text = targetLi.querySelector('.option-content')?.textContent || value; // í™”ë©´ í‘œì‹œëŠ” ì›ë³¸ ëŒ€ì†Œë¬¸ì
            selectedValueDiv.textContent = text; 
            hiddenInput.value = value; // hidden inputì—ëŠ” ì†Œë¬¸ì key ì €ì¥
            optionsList.classList.add('hidden'); 
            addInputContainer.classList.add('hidden'); 
            updateFinalURL();
        }
    });

    addInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            const originalNewValue = addInput.value.trim(); 
            const lowerCaseNewValue = originalNewValue.toLowerCase(); 

            if (!originalNewValue) { alert('ì¶”ê°€í•  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (/\s|&|\?|#|\.|\/|\\/.test(originalNewValue)) { alert("ë„ì–´ì“°ê¸° ë° íŠ¹ìˆ˜ë¬¸ì(&, ?, #, ., /, \\)ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            if (/[^a-z0-9_\-]/.test(lowerCaseNewValue)) { alert("Key ê°’(ì†Œë¬¸ìë¡œ ë³€í™˜ëœ ê°’)ì€ ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_), í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
            
            let existsInCurrentDropdown = false; 
            optionsList.querySelectorAll('li[data-value]').forEach(li => { if(li.dataset.value === lowerCaseNewValue) existsInCurrentDropdown = true; });
            if (existsInCurrentDropdown) { alert("ì´ë¯¸ í˜„ì¬ ë“œë¡­ë‹¤ìš´ ëª©ë¡ì— ì¡´ì¬í•˜ëŠ” ê°’ì…ë‹ˆë‹¤ (ì†Œë¬¸ì ê¸°ì¤€)."); return; }

            const newLi = createOptionLi(originalNewValue, originalNewValue, 'custom'); 
            optionsList.insertBefore(newLi, addOptionButton);
            saveCustomOptionsToStorage(baseId); 

            console.log(`ìƒˆ ì˜µì…˜ '${originalNewValue}'ì€(ëŠ”) ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê°’ì´ ì¤‘ì•™ ë§ˆìŠ¤í„° ëª©ë¡(êµ¬ê¸€ ì‹œíŠ¸ CSV)ì— ì—†ë‹¤ë©´, ë‹¤ìŒ 'ì œì¶œ' ì‹œ n8nìœ¼ë¡œ ì „ë‹¬ë˜ì–´ 'ì˜µì…˜ ë§ˆìŠ¤í„° ì‹œíŠ¸'ì— ì¶”ê°€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            
            selectedValueDiv.textContent = originalNewValue;
            hiddenInput.value = lowerCaseNewValue; 
            addInputContainer.classList.add('hidden');
            optionsList.classList.add('hidden');
            updateFinalURL();
        }
    });
    addInput.addEventListener('blur', () => {
        setTimeout(() => { if (!addInputContainer.contains(document.activeElement)) { addInputContainer.classList.add('hidden'); } }, 150);
    });
}


function getValueOrN(elementId) {
    // ì´ í•¨ìˆ˜ëŠ” hidden input (id=baseId) ë˜ëŠ” text input (id=...) ì—ì„œ ê°’ì„ ê°€ì ¸ì˜´.
    // text inputì˜ IDëŠ” campaign_date, content_detail, content_version, utm_term ì´ì–´ì•¼ í•¨.
    // HTMLì—ì„œ í•´ë‹¹ text inputë“¤ì˜ idê°€ name+"_display"ê°€ ì•„ë‹Œ, ì§ì ‘ì ì¸ idë¡œ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ í•„ìš”.
    // ì‚¬ìš©ì HTMLì—ì„œëŠ” id="campaign_date", id="content_detail", id="content_version", id="utm_term"ìœ¼ë¡œ ë˜ì–´ìˆìŒ. OK.
    const element = document.getElementById(elementId);
    let value = "";
    if (element) {
        value = element.value.trim(); // .valueëŠ” hidden inputì´ë‚˜ text input ëª¨ë‘ì— ì ìš© ê°€ëŠ¥
    }
    return value === "" || value === "-- ì„ íƒí•˜ì„¸ìš” --" ? "N" : value.toLowerCase(); // N ë˜ëŠ” ì†Œë¬¸ìí™”ëœ í‚¤ ê°’ ë°˜í™˜
}

function updateFinalURL() {
    const pageUrl = document.getElementById("page_url").value.trim();
    // getValueOrNì€ ì†Œë¬¸ìí™”ëœ í‚¤ ë˜ëŠ” "N"ì„ ë°˜í™˜í•¨
    const utmSource = getValueOrN("source"); 
    const utmMedium = getValueOrN("medium");
    const campaignDate = getValueOrN("campaign_date"); 
    const adType = getValueOrN("ad_type");
    const campaignGoal = getValueOrN("campaign_goal");
    const eventType = getValueOrN("event_type");
    const productCategory = getValueOrN("product_category");
    const adTarget = getValueOrN("ad_target");
    const creativeType = getValueOrN("creative_type");
    const deviceType = getValueOrN("device_type");

    const utmCampaignParts = [
        campaignDate, adType, campaignGoal, eventType, 
        productCategory, adTarget, creativeType, deviceType
    ];
    // ëª¨ë“  ë¶€ë¶„ì´ "N"ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ join. ëª¨ë“  ë¶€ë¶„ì´ "N"ì´ë©´ ìº í˜ì¸ ê°’ë„ "N"ì´ ë˜ë„ë¡.
    // Naming Rule: ì—†ìœ¼ë©´ 'N'ìœ¼ë¡œ ì±„ì›€. êµ¬ì„±: ë‚ ì§œ_ê´‘ê³ íƒ€ì…_...
    // ì´ë¯¸ getValueOrNì—ì„œ ë¹ˆ ê°’ì„ "N"ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ, ëª¨ë“  ìš”ì†Œê°€ "N"ì¸ì§€ í™•ì¸í•  í•„ìš” ì—†ì´ ê·¸ëƒ¥ join.
    // ë‹¨, í•„ìˆ˜í•­ëª©(ë‚ ì§œ, ê´‘ê³ íƒ€ì…, ê¸°ê¸°ì¹´í…Œê³ ë¦¬)ì´ Nì´ë©´ ì•ˆë˜ë¯€ë¡œ, ì´ ê²€ì¦ì€ submit ì‹œì— ì´ë£¨ì–´ì§.
    const utmCampaign = utmCampaignParts.join("_");
    document.getElementById("utm_campaign").value = utmCampaign;

    const contentAction = getValueOrN("content_action");
    const contentDetail = getValueOrN("content_detail"); 
    const contentVersion = getValueOrN("content_version"); 
    
    const utmContentParts = [contentAction, contentDetail, contentVersion];
    // ì½˜í…ì¸  ê·œì¹™: í•˜ë‚˜ë¼ë„ ì…ë ¥ë˜ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ì¡°í•©, ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ 'N'
    const utmContent = utmContentParts.every(part => part === "N") ? "N" : utmContentParts.join("_");
    document.getElementById("utm_content").value = utmContent;
    
    const utmTerm = getValueOrN("utm_term"); 

    let finalURLGenerated = pageUrl;
    const params = [];
    // getValueOrNì´ "N" ë˜ëŠ” ì†Œë¬¸ìí™”ëœ ê°’ì„ ë°˜í™˜í•˜ë¯€ë¡œ, "N"ì´ ì•„ë‹ ë•Œë§Œ ì¶”ê°€
    if (utmSource && utmSource !== "n") params.push(`utm_source=${encodeURIComponent(utmSource)}`);
    if (utmMedium && utmMedium !== "n") params.push(`utm_medium=${encodeURIComponent(utmMedium)}`);
    // utmCampaignì´ "N_N_N_N_N_N_N_N" (ëª¨ë“  ìš”ì†Œê°€ Nì¸ ê²½ìš°)ì´ ì•„ë‹ ë•Œ ì¶”ê°€
    if (utmCampaign && utmCampaign !== Array(utmCampaignParts.length).fill("n").join("_") ) {
        params.push(`utm_campaign=${encodeURIComponent(utmCampaign)}`);
    }
    if (utmContent && utmContent !== "n") params.push(`utm_content=${encodeURIComponent(utmContent)}`); // N_N_Nì¸ ê²½ìš°ë„ Nìœ¼ë¡œ ì²˜ë¦¬ë¨
    if (utmTerm && utmTerm !== "n") params.push(`utm_term=${encodeURIComponent(utmTerm)}`);

    if (params.length > 0) {
        finalURLGenerated += (pageUrl.includes('?') ? '&' : '?') + params.join('&');
    }
    document.getElementById("final_url").value = finalURLGenerated;
}

async function fetchHistoryData() { /* ë‚´ìš© ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼ */ }
async function renderHistoryTable() { /* ë‚´ìš© ìˆ˜ì •ë¨ - ì•„ë˜ ì°¸ì¡° */ }

async function renderHistoryTable() { // CSS í´ë˜ìŠ¤ ì¶”ê°€ ë° ìŠ¤íƒ€ì¼ ê°œì„ ëœ ë²„ì „ ìœ ì§€
    const tableBody = document.getElementById('historyTable')?.getElementsByTagName('tbody')[0];
    if (!tableBody) return;
    tableBody.innerHTML = ''; 

    showLoading("ì´ë ¥ ë¡œë”© ì¤‘...");
    const data = await fetchHistoryData(); 
    hideLoading();

    if (data.length === 0) {
        const row = tableBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 9; 
        cell.textContent = 'í‘œì‹œí•  ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.';
        cell.style.textAlign = 'center';
        return;
    }

    data.forEach(item => {
        const row = tableBody.insertRow(); 
        let displayTimestamp = 'N/A';
        // formData ê°ì²´ê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì ‘ê·¼
        const itemTimestamp = item.timestamp || (item.formData && item.formData.timestamp);
        if (itemTimestamp) {
            try {
                displayTimestamp = new Date(itemTimestamp).toLocaleString('ko-KR', { dateStyle: 'short', timeStyle: 'short'});
            } catch (e) { console.warn("Error parsing timestamp for history: ", itemTimestamp); }
        }
        row.insertCell().textContent = displayTimestamp;
        row.insertCell().textContent = item.utm_source || (item.formData && item.formData.utm_source) || 'N';
        row.insertCell().textContent = item.utm_medium || (item.formData && item.formData.utm_medium) || 'N';
        row.insertCell().textContent = item.utm_campaign || (item.formData && item.formData.utm_campaign) || 'N';
        row.insertCell().textContent = item.utm_content || (item.formData && item.formData.utm_content) || 'N';
        row.insertCell().textContent = item.utm_term || (item.formData && item.formData.utm_term) || 'N';
        
        const pageUrlCell = row.insertCell();
        const originalPageUrl = item.page_url || (item.formData && item.formData.page_url) || '';
        pageUrlCell.textContent = originalPageUrl;
        pageUrlCell.title = originalPageUrl;
        pageUrlCell.style.maxWidth = '150px'; pageUrlCell.style.overflow = 'hidden'; pageUrlCell.style.textOverflow = 'ellipsis'; pageUrlCell.style.whiteSpace = 'nowrap';

        const finalUrlCell = row.insertCell();
        const finalUrl = item.final_url || (item.formData && item.formData.final_url) || '';
        finalUrlCell.textContent = finalUrl;
        finalUrlCell.title = finalUrl; 
        finalUrlCell.style.maxWidth = '200px'; finalUrlCell.style.overflow = 'hidden'; finalUrlCell.style.textOverflow = 'ellipsis'; finalUrlCell.style.whiteSpace = 'nowrap';
        
        const shortUrlCell = row.insertCell();
        const shortUrl = item.short_url || ''; // n8n ì‘ë‹µì—ì„œ short_url ì§ì ‘ ì‚¬ìš©
        shortUrlCell.textContent = shortUrl || 'N/A';
        shortUrlCell.title = shortUrl;
        shortUrlCell.style.maxWidth = '100px'; shortUrlCell.style.overflow = 'hidden'; shortUrlCell.style.textOverflow = 'ellipsis'; shortUrlCell.style.whiteSpace = 'nowrap';
    });
}


document.getElementById("utmForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    showLoading("UTM ë§í¬ ìƒì„± ë° ì „ì†¡ ì¤‘...");

    const requiredIdsForSubmit = ["page_url", "source", "medium", "campaign_date", "ad_type", "device_type"];
    for (let id of requiredIdsForSubmit) {
        let element = document.getElementById(id);
        // ë“œë¡­ë‹¤ìš´ì˜ ê²½ìš° hidden input (id=baseId)ì˜ ê°’ì„, ì¼ë°˜ text inputë„ idë¡œ ì§ì ‘ ê°€ì ¸ì˜´.
        let valueToCheck = element ? element.value.trim() : ""; 
        
        if (!valueToCheck || valueToCheck === "-- ì„ íƒí•˜ì„¸ìš” --") { // "-- ì„ íƒí•˜ì„¸ìš” --"ëŠ” hidden inputì˜ ì´ˆê¸°ê°’ì´ ì•„ë‹ ìˆ˜ ìˆìŒ. ë³´í†µ ë¹ˆ ë¬¸ìì—´.
            const labelElement = document.querySelector(`label[for='${id}']`) || 
                                 (element && element.id === id && document.getElementById(`${id}_dropdown`) ? document.getElementById(`${id}_dropdown`).previousElementSibling : null ) || // ë“œë¡­ë‹¤ìš´ ë ˆì´ë¸”
                                 (element ? element.previousElementSibling : null); // ì¼ë°˜ input ë ˆì´ë¸”
            const fieldName = labelElement ? labelElement.textContent.replace(/ \(.+\):/, '').trim() : id;
            alert(`í•„ìˆ˜ í•­ëª© '${fieldName}'ì„(ë¥¼) ì„ íƒ ë˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.`);
            hideLoading();
            if (document.getElementById(`${id}_dropdown`)) document.getElementById(`${id}_selected_value`)?.click();
            else element?.focus();
            return;
        }
    }
    
    updateFinalURL(); // ìµœì¢… URL ë° utm_campaign, utm_content ê°’ ì—…ë°ì´íŠ¸

    // --- "ì˜µì…˜ ë§ˆìŠ¤í„° ì‹œíŠ¸"ì— ì—†ëŠ” ìƒˆë¡œìš´ ì˜µì…˜ ê°’ë“¤ë§Œ ì‹ë³„ ---
    let newOptionsForMasterList = [];
    for (const baseId of dropdownBaseIds) { // 'source', 'medium', 'ad_type', ...
        const hiddenInputElement = document.getElementById(baseId); // ì˜ˆ: id="source"ì¸ hidden input
        const selectedValueDisplayElement = document.getElementById(`${baseId}_selected_value`); // ì˜ˆ: id="source_selected_value"ì¸ div

        if (hiddenInputElement && selectedValueDisplayElement) {
            const selectedValueKey = hiddenInputElement.value.trim(); // ì†Œë¬¸ì key ê°’, ì˜ˆ: "google", "cpc"
            const selectedValueDisplayText = selectedValueDisplayElement.textContent.trim(); // í™”ë©´ì— í‘œì‹œëœ ì›ë³¸ ê°’, ì˜ˆ: "Google", "CPC"

            // "N"ì´ë‚˜ ì´ˆê¸° "-- ì„ íƒí•˜ì„¸ìš” --" ê°’ì€ ìƒˆ ì˜µì…˜ìœ¼ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ
            if (selectedValueKey && selectedValueKey !== "n" && selectedValueDisplayText !== "-- ì„ íƒí•˜ì„¸ìš” --") {
                const masterListForThisCategory = masterOptionLists[baseId] || new Set(); // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆìŠ¤í„° ì˜µì…˜ Set (ì›ë³¸ ëŒ€ì†Œë¬¸ì ìœ ì§€)
                
                // selectedValueDisplayText (í™”ë©´ í‘œì‹œ ì›ë³¸ ê°’)ê°€ masterListForThisCategoryì— ì—†ëŠ” ê²½ìš° "ìƒˆë¡œìš´ ê°’"ìœ¼ë¡œ ê°„ì£¼
                if (!masterListForThisCategory.has(selectedValueDisplayText)) {
                    newOptionsForMasterList.push({
                        parameter_category: baseId,              // ì˜ˆ: 'source', 'medium' (n8nì—ì„œ ì–´ë–¤ ì—´ì— ì¶”ê°€í• ì§€ êµ¬ë¶„)
                        new_value: selectedValueDisplayText      // êµ¬ê¸€ ì‹œíŠ¸ì— ì¶”ê°€í•  ì‹¤ì œ ê°’ (ì›ë³¸ ëŒ€ì†Œë¬¸ì)
                    });
                }
            }
        }
    }
    console.log("New options for master list (to be sent to n8n):", newOptionsForMasterList);
    // --- ìƒˆë¡œìš´ ì˜µì…˜ ê°’ ì‹ë³„ ë¡œì§ ì¢…ë£Œ ---

    const formDataForN8n = {
        page_url: document.getElementById('page_url').value.trim(),
        utm_source: document.getElementById('source').value.trim(), 
        utm_medium: document.getElementById('medium').value.trim(), 
        
        // ê°œë³„ êµ¬ì„±ìš”ì†Œ (hidden input ë˜ëŠ” text inputì—ì„œ ì§ì ‘ ê°’ì„ ê°€ì ¸ì˜´)
        // ì´ í‚¤ ì´ë¦„ë“¤ì€ n8nì—ì„œ $json.key_name ìœ¼ë¡œ ì°¸ì¡°ë¨
        campaign_date: document.getElementById('campaign_date').value.trim(),
        ad_type: document.getElementById('ad_type').value.trim(),
        campaign_goal: document.getElementById('campaign_goal').value.trim(),
        event_type: document.getElementById('event_type').value.trim(),
        product_category: document.getElementById('product_category').value.trim(),
        ad_target: document.getElementById('ad_target').value.trim(),
        creative_type: document.getElementById('creative_type').value.trim(),
        device_type: document.getElementById('device_type').value.trim(),
        content_action: document.getElementById('content_action').value.trim(),
        content_detail: document.getElementById('content_detail').value.trim(),
        content_version: document.getElementById('content_version').value.trim(),

        // ì¡°í•©ëœ ê°’
        utm_campaign: document.getElementById('utm_campaign').value.trim(), 
        utm_content: document.getElementById('utm_content').value.trim(), 
        utm_term: document.getElementById('utm_term').value.trim(), 
        final_url: document.getElementById('final_url').value.trim(),
        timestamp: new Date().toISOString(),
        new_options_for_master_list: newOptionsForMasterList // ì‹ë³„ëœ ìƒˆ ì˜µì…˜ ëª©ë¡ ì¶”ê°€
    };

    console.log("Submitting Form Data to n8n:", formDataForN8n);

    try {
        const n8nUrl = N8N_WEBHOOK_URL; 
        if (!n8nUrl || n8nUrl === 'ì—¬ê¸°ì—_N8N_WEBHOOK_PRODUCTION_URL_ì…ë ¥í•˜ì„¸ìš”' || (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:')) {
            let alertMessage = "n8n ì›¹í›… URLì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n";
            if (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:') {
                alertMessage = "ê²½ê³ : í˜„ì¬ í˜ì´ì§€ëŠ” HTTPSì´ë‚˜ n8n ì›¹í›…ì€ HTTP ë¡œì»¬í˜¸ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì •ìƒ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n(í˜¼í•© ì½˜í…ì¸  ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥)\n";
            }
            alertMessage += "\nUTM ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ë‹¨ì¶• ë° ì´ë ¥/ì‹œíŠ¸ ì €ì¥ ì•ˆë¨):\n" + formDataForN8n.final_url;
            alert(alertMessage);
            document.getElementById("responseContainer").style.display = "none";
            hideLoading();
            return; 
        }

        const res = await fetch(n8nUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formDataForN8n)
        });

        if (!res.ok) {
            const errorText = await res.text(); 
            throw new Error(`n8n ì›¹í›… ì‘ë‹µ ì˜¤ë¥˜ (${res.status}): ${errorText || res.statusText}`);
        }
        
        const result = await res.json(); 

        if (result.short_url) {
            document.getElementById("shortUrlInput").value = result.short_url;
            document.getElementById("responseContainer").style.display = "block";
            // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ëŠ” n8nì´ HISTORY_JSON_URLì„ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜, 
            // ë˜ëŠ” HISTORY_JSON_URLì´ êµ¬ê¸€ ì‹œíŠ¸ë¥¼ ì½ì–´ì˜¤ëŠ” n8n ì—”ë“œí¬ì¸íŠ¸ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ë³€ê²½ í•„ìš”
            await renderHistoryTable(); 
            alert("UTM ë§í¬ ìƒì„±, ë‹¨ì¶• ë° ì‹œíŠ¸ ì €ì¥ ìš”ì²­ ì™„ë£Œ!\nìµœì¢… URL: " + formDataForN8n.final_url + "\në‹¨ì¶• URL: " + result.short_url);
        } else {
            alert("ë‹¨ì¶• URLì„ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. n8n ì›Œí¬í”Œë¡œìš° ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.\n(ì‹œíŠ¸ ì €ì¥ì€ ì‹œë„ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\nìµœì¢… URL: " + formDataForN8n.final_url);
            document.getElementById("responseContainer").style.display = "none";
            await renderHistoryTable(); 
        }
    } catch (err) {
        console.error("n8n ì „ì†¡ ë˜ëŠ” ì²˜ë¦¬ ì˜¤ë¥˜:", err);
        alert(`ì„œë²„ í†µì‹  ë˜ëŠ” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}\n(UTM ë§í¬ëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ë‹¨ì¶• ë° ì´ë ¥/ì‹œíŠ¸ ì €ì¥ì€ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\nìµœì¢… URL: ${formDataForN8n.final_url}`);
        document.getElementById("responseContainer").style.display = "none";
    } finally {
        hideLoading();
    }
});

function copyLink() { /* ë‚´ìš© ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼ */ }
</script>
</body>
</html>