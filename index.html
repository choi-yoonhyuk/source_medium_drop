<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTM 링크 생성기 (n8n 연동 - 최종 로직 적용)</title>
<style>
/* 기본 스타일 - 사용자님 코드 유지 */
body { font-family: sans-serif; padding: 20px; font-size: 14px; }
.dv1, .dv2, .dv3 { margin-bottom: 20px; }
.button-container { margin-bottom: 20px; }
.button-container button { padding: 10px 15px; font-size: 1em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
.button-container button:hover { background-color: #0056b3; }
label { display: inline-block; min-width: 120px; margin-bottom: 5px; vertical-align: top; padding-top: 8px; }
input[type="text"] { padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px; vertical-align: middle; }
input[type="text"]#final_url { background-color: #eee; }
button { padding: 8px 15px; margin-left: 5px; cursor: pointer; vertical-align: middle; }
fieldset { margin-bottom: 20px; border:1px solid #ccc; padding:10px; }
legend { font-weight: bold; }
.required { color: red; font-weight: bold; }
.hidden { display: none !important; }
#loadingIndicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; display: none; }
.custom-dropdown-container { display: inline-block; vertical-align: top; }
.custom-dropdown { position: relative; display: inline-block; min-width: 200px; width: auto; max-width: 300px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; margin-bottom: 10px; }
.dropdown-selected { padding: 8px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
.dropdown-selected::after { content: '▼'; font-size: 0.8em; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #888; }
.dropdown-options { position: absolute; top: 100%; left: 0; right: 0; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; list-style: none; padding: 0; margin: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.dropdown-options li { padding: 8px 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; white-space: nowrap; }
.dropdown-options li:hover { background-color: #f0f0f0; }
.dropdown-options li .option-content { flex-grow: 1; margin-left: 8px; overflow: hidden; text-overflow: ellipsis; }
.dropdown-options li .icon { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #ddd; flex-shrink: 0; }
.dropdown-options li[data-type="default"] .icon { background-color: #aaa; }
.dropdown-options li[data-type="custom"] .icon { background-color: #6aabff; }
.dropdown-options li .delete-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 1.1em; padding: 0 5px; margin-left: 10px; flex-shrink: 0; font-weight: bold; }
.dropdown-options li .delete-btn:hover { color: #f00; }
.dropdown-options li[data-type="default"] .delete-btn { display: none; }
.dropdown-options .add-option { color: #007bff; font-weight: bold; border-top: 1px solid #eee; }
.add-option-input { padding: 5px; border-top: 1px solid #eee; background-color: #f9f9f9; }
.add-option-input input[type="text"] { width: calc(100% - 16px); margin: 0; box-sizing: border-box; }
#responseContainer { display: none; margin-top: 20px; }
#responseContainer input[type="text"] { width: calc(100% - 100px); margin-right: 10px; }
</style>
</head>
<body>
<div id="loadingIndicator">로딩 중...</div>

<div class="dv1">
<div class="dv2">
    <div class="button-container">
        <button onclick="location.href='https://choi-yoonhyuk.github.io/utm_key_value/'">UTM 옵션 목록</button>
    </div>
    <div class="button-container">
        <button onclick="location.href='https://choi-yoonhyuk.github.io/utm_history/'">UTM 생성 이력</button>
    </div>
    <h1>UTM 링크 생성</h1>
    <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;">
        <thead><tr><th colspan="2">UTM 네이밍 규칙</th></tr></thead>
        <tbody>
            <tr><td>공통 규칙</td><td><ul><li>띄어쓰기 금지</li><li>구분자: 언더스코어('_') 및 하이픈('-') 사용</li><li>영문 네이밍: 소문자만 사용</li><li>특수문자 사용 금지 (&amp;, ?, #, ., /, \ 등)</li></ul></td></tr>
            <tr><td>캠페인 규칙</td><td><ul><li>구성: 날짜_광고타입_캠페인목표_기획전종류_상품카테고리_광고타겟_소재타입_기기카테고리</li><li>없으면 'N'으로 채움</li><li><span class="required">필수 항목: 날짜, 광고타입, 기기카테고리</span></li></ul></td></tr>
            <tr><td>콘텐츠 규칙</td><td><ul><li>목표행동, 추가기입사항, 버전 중 하나라도 입력되면 해당 값으로 조합</li><li>입력되지 않으면 'N'으로 처리</li></ul></td></tr>
        </tbody>
    </table>
    <br>
</div>

<div class="dv3">
    <form id="utmForm">
        <label for="page_url">Page URL <span class="required">(필수)</span>:</label>
        <input type="text" id="page_url" name="page_url_form" required placeholder="https://example.com" oninput="updateFinalURL()"><br><br>

        <label for="source">소스 <span class="required">(필수)</span>:</label>
        <div class="custom-dropdown-container">
            <div class="custom-dropdown" id="source_dropdown">
                <div class="dropdown-selected" id="source_selected_value" tabindex="0">-- 선택하세요 --</div>
                <ul class="dropdown-options hidden" id="source_options_list">
                    <li class="add-option" id="source_add_option_button">+ 옵션 추가</li>
                </ul>
                <div class="add-option-input hidden" id="source_add_input_container">
                    <input type="text" id="source_add_input" placeholder="입력 후 Enter">
                </div>
            </div>
            <input type="hidden" id="source" name="source_hidden" required>
        </div>
        <br><br>

        <label for="medium">매체 <span class="required">(필수)</span>:</label>
        <div class="custom-dropdown-container">
            <div class="custom-dropdown" id="medium_dropdown">
                <div class="dropdown-selected" id="medium_selected_value" tabindex="0">-- 선택하세요 --</div>
                <ul class="dropdown-options hidden" id="medium_options_list">
                    <li class="add-option" id="medium_add_option_button">+ 옵션 추가</li>
                </ul>
                <div class="add-option-input hidden" id="medium_add_input_container">
                    <input type="text" id="medium_add_input" placeholder="입력 후 Enter">
                </div>
            </div>
            <input type="hidden" id="medium" name="medium_hidden" required>
        </div>
        <br><br>
        
        <fieldset style="border:1px solid #ccc; padding:10px;">
            <legend>UTM Campaign 구성</legend>
            <label for="campaign_date">날짜 <span class="required">(필수)</span>:</label>
            <input type="text" id="campaign_date" name="campaign_date_form" placeholder="YYYYMMDD" oninput="updateFinalURL()" required><br><br>
            
            <label for="utm_campaign_ad_type">광고타입 <span class="required">(필수)</span>:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="utm_campaign_ad_type_dropdown">
                    <div class="dropdown-selected" id="utm_campaign_ad_type_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="utm_campaign_ad_type_options_list"> <li class="add-option" id="utm_campaign_ad_type_add_option_button">+ 옵션 추가</li> </ul>
                    <div class="add-option-input hidden" id="utm_campaign_ad_type_add_input_container"><input type="text" id="utm_campaign_ad_type_add_input" placeholder="입력 후 Enter"></div>
                </div><input type="hidden" id="utm_campaign_ad_type" name="utm_campaign_ad_type_hidden" required>
            </div><br><br>

            <label for="utm_campaign_goal">캠페인목표:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="utm_campaign_goal_dropdown">
                    <div class="dropdown-selected" id="utm_campaign_goal_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="utm_campaign_goal_options_list"><li class="add-option" id="utm_campaign_goal_add_option_button">+ 옵션 추가</li></ul>
                    <div class="add-option-input hidden" id="utm_campaign_goal_add_input_container"><input type="text" id="utm_campaign_goal_add_input" placeholder="입력 후 Enter"></div>
                </div><input type="hidden" id="utm_campaign_goal" name="utm_campaign_goal_hidden">
            </div><br><br>

            <label for="utm_campaign_event_type">기획전종류:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="utm_campaign_event_type_dropdown">
                    <div class="dropdown-selected" id="utm_campaign_event_type_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="utm_campaign_event_type_options_list"><li class="add-option" id="utm_campaign_event_type_add_option_button">+ 옵션 추가</li></ul>
                    <div class="add-option-input hidden" id="utm_campaign_event_type_add_input_container"><input type="text" id="utm_campaign_event_type_add_input" placeholder="입력 후 Enter"></div>
                </div><input type="hidden" id="utm_campaign_event_type" name="utm_campaign_event_type_hidden">
            </div><br><br>

            <label for="utm_campaign_product_category">상품카테고리:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="utm_campaign_product_category_dropdown">
                    <div class="dropdown-selected" id="utm_campaign_product_category_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="utm_campaign_product_category_options_list"><li class="add-option" id="utm_campaign_product_category_add_option_button">+ 옵션 추가</li></ul>
                    <div class="add-option-input hidden" id="utm_campaign_product_category_add_input_container"><input type="text" id="utm_campaign_product_category_add_input" placeholder="입력 후 Enter"></div>
                </div><input type="hidden" id="utm_campaign_product_category" name="utm_campaign_product_category_hidden">
            </div><br><br>

            <label for="utm_campaign_ad_target">광고타겟:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="utm_campaign_ad_target_dropdown">
                    <div class="dropdown-selected" id="utm_campaign_ad_target_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="utm_campaign_ad_target_options_list"><li class="add-option" id="utm_campaign_ad_target_add_option_button">+ 옵션 추가</li></ul>
                    <div class="add-option-input hidden" id="utm_campaign_ad_target_add_input_container"><input type="text" id="utm_campaign_ad_target_add_input" placeholder="입력 후 Enter"></div>
                </div><input type="hidden" id="utm_campaign_ad_target" name="utm_campaign_ad_target_hidden">
            </div><br><br>

            <label for="utm_campaign_creative_type">소재타입:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="utm_campaign_creative_type_dropdown">
                    <div class="dropdown-selected" id="utm_campaign_creative_type_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="utm_campaign_creative_type_options_list"><li class="add-option" id="utm_campaign_creative_type_add_option_button">+ 옵션 추가</li></ul>
                    <div class="add-option-input hidden" id="utm_campaign_creative_type_add_input_container"><input type="text" id="utm_campaign_creative_type_add_input" placeholder="입력 후 Enter"></div>
                </div><input type="hidden" id="utm_campaign_creative_type" name="utm_campaign_creative_type_hidden">
            </div><br><br>

            <label for="utm_campaign_device_type">기기카테고리 <span class="required">(필수)</span>:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="utm_campaign_device_type_dropdown">
                    <div class="dropdown-selected" id="utm_campaign_device_type_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="utm_campaign_device_type_options_list"><li class="add-option" id="utm_campaign_device_type_add_option_button">+ 옵션 추가</li></ul>
                    <div class="add-option-input hidden" id="utm_campaign_device_type_add_input_container"><input type="text" id="utm_campaign_device_type_add_input" placeholder="입력 후 Enter"></div>
                </div><input type="hidden" id="utm_campaign_device_type" name="utm_campaign_device_type_hidden" required>
            </div><br><br>
        </fieldset>
        
        <fieldset style="border:1px solid #ccc; padding:10px;">
            <legend>UTM Content 구성</legend>
            <label for="utm_content_content_action">목표행동:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="utm_content_content_action_dropdown">
                    <div class="dropdown-selected" id="utm_content_content_action_selected_value" tabindex="0">-- 선택하세요 --</div>
                    <ul class="dropdown-options hidden" id="utm_content_content_action_options_list"><li class="add-option" id="utm_content_content_action_add_option_button">+ 옵션 추가</li></ul>
                    <div class="add-option-input hidden" id="utm_content_content_action_add_input_container"><input type="text" id="utm_content_content_action_add_input" placeholder="입력 후 Enter"></div>
                </div><input type="hidden" id="utm_content_content_action" name="utm_content_content_action_hidden">
            </div><br><br>
            <label for="content_detail">추가기입사항:</label>
            <input type="text" id="content_detail" name="content_detail_form" placeholder="120X240-vertical" oninput="updateFinalURL()"><br><br>
            <label for="content_version">버전:</label>
            <input type="text" id="content_version" name="content_version_form" placeholder="v1" oninput="updateFinalURL()"><br><br>
        </fieldset>

        <label for="utm_term">검색어 (선택):</label>
        <input type="text" id="utm_term" name="utm_term_form" placeholder="shoes" oninput="updateFinalURL()"><br><br>

        <input type="hidden" id="utm_campaign" name="utm_campaign_combined" required>
        <input type="hidden" id="utm_content" name="utm_content_combined">

        <label for="final_url">최종 URL:</label>
        <input type="text" id="final_url" name="final_url_display" readonly style="width:100%; font-family:monospace;">
        <button type="submit">제출</button>
    </form>

    <div id="responseContainer">
        <label for="shortUrlInput">🔗 단축 URL:</label>
        <input type="text" id="shortUrlInput" readonly="" style="font-family:monospace;">
        <button type="button" onclick="copyLink()">📋 복사</button>
    </div>

    <div id="historyTableContainer" style="margin-top: 30px;">
        <h2>생성 이력</h2>
        <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;" id="historyTable">
            <thead><tr><th>생성일시</th><th>Source</th><th>Medium</th><th>Campaign</th><th>Content</th><th>Term</th><th>페이지 URL</th><th>최종 URL</th><th>단축 URL</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</div>

<script>
// --- 설정값 ---
const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1846317494&single=true&output=csv'; // 드롭다운 옵션 시트 URL
const N8N_WEBHOOK_URL = 'https://n8n.logger.co.kr:7443/webhook-test/test'; // 실제 n8n URL로 변경 필수!
//const N8N_WEBHOOK_URL = 'http://localhost:5677/webhook-test/15daaf64-30ee-4b32-9426-45a8c8bd9184'; // 실제 n8n URL로 변경 필수!
const GOOGLE_SHEET_HISTORY_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1831366188&single=true&output=csv'; // 이력 시트 URL

// *** 중요: dropdownBaseIds를 시트의 parameter_type 값과 일치하도록 수정 ***
const dropdownBaseIds = [
    'source', 
    'medium', 
    'utm_campaign_ad_type', 
    'utm_campaign_goal',
    'utm_campaign_event_type',
    'utm_campaign_product_category', 
    'utm_campaign_ad_target', 
    'utm_campaign_creative_type', 
    'utm_campaign_device_type', 
    'utm_content_content_action' 
];

let masterOptionLists = {};

document.addEventListener('DOMContentLoaded', async () => {
    showLoading("옵션 및 이력 로딩 중...");
    let csvDataText = null;
    try {
        const response = await fetch(GOOGLE_SHEET_CSV_URL);
        if (!response.ok) throw new Error(`드롭다운 옵션 CSV 로드 실패 (${response.status})`);
        csvDataText = await response.text();
        console.log("드롭다운 옵션 CSV 데이터 로드 완료");

        parseAndStoreMasterOptions(csvDataText); 

        for (const baseId of dropdownBaseIds) { // 이제 baseId는 'utm_campaign_ad_type' 등 긴 이름 포함
            try {
                renderDropdownWithOptions(baseId);
                setupDropdownInteractions(baseId);
            } catch (error) {
                console.error(`Error initializing dropdown for ${baseId}:`, error);
            }
        }
        updateFinalURL();
        await renderHistoryTable();
    } catch (error) {
        console.error("초기 데이터 로딩 오류:", error);
        alert(`초기 데이터(드롭다운 옵션 또는 이력)를 불러오는 데 실패했습니다: ${error.message}`);
    } finally {
        hideLoading();
    }
});

function showLoading(message = "처리 중...") {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) { indicator.textContent = message; indicator.style.display = 'flex'; }
}
function hideLoading() {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) { indicator.style.display = 'none'; }
}

function createOptionLi(value, displayText, type) {
    const li = document.createElement('li');
    const valueForDataset = String(value).trim().toLowerCase(); 
    li.dataset.value = valueForDataset; 
    li.dataset.type = type;

    const iconSpan = document.createElement('span'); iconSpan.className = 'icon'; li.appendChild(iconSpan);
    const textSpan = document.createElement('span'); textSpan.className = 'option-content';
    textSpan.textContent = String(displayText).trim() || String(value).trim(); 
    li.appendChild(textSpan);

    if (type === 'custom') {
        const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; li.appendChild(deleteBtn);
    }
    return li;
}

function parseAndStoreMasterOptions(csvDataText) {
    // dropdownBaseIds를 기준으로 masterOptionLists 초기화 (이제 긴 이름 포함)
    dropdownBaseIds.forEach(baseId => {
        masterOptionLists[baseId] = new Set();
    });

    if (!csvDataText) {
        console.warn("CSV 데이터가 비어있어 마스터 옵션을 파싱할 수 없습니다.");
        return;
    }

    try {
        const lines = csvDataText.split(/\r?\n/);
        if (lines.length < 2) {
            console.warn("CSV 데이터가 충분하지 않습니다 (헤더와 최소 1개의 데이터 행 필요).");
            return;
        }

        const headers = lines[0].split(',').map(h => String(h).trim().replace(/^"|"$/g, ''));
        
        const parameter_type_ColIdx = headers.indexOf('parameter_type');
        const option_value_ColIdx = headers.indexOf('option_value');
        const is_active_ColIdx = headers.indexOf('is_active'); 

        if (parameter_type_ColIdx === -1 || option_value_ColIdx === -1) {
            console.error("필수 CSV 헤더('parameter_type' 또는 'option_value')를 찾을 수 없습니다. 현재 헤더:", headers.join(', '));
            alert("드롭다운 옵션 시트의 헤더 구성이 올바르지 않습니다 ('parameter_type' 또는 'option_value' 열을 찾을 수 없음). 관리자에게 문의하세요.");
            return;
        }

        for (let i = 1; i < lines.length; i++) {
            const lineContent = lines[i].trim();
            if (lineContent === '') continue; 

            const columns = lineContent.split(',').map(s => s.trim().replace(/^"|"$/g, ''));

            if (columns.length > Math.max(parameter_type_ColIdx, option_value_ColIdx)) {
                const paramTypeFromSheet = String(columns[parameter_type_ColIdx]).trim(); // 시트에서 읽은 paramType
                const optionVal = String(columns[option_value_ColIdx]).trim();
                let isActive;

                if (is_active_ColIdx !== -1) { 
                    if (columns.length > is_active_ColIdx) {
                        const activeFlag = String(columns[is_active_ColIdx]).trim().toUpperCase();
                        isActive = (activeFlag === 'Y'); // 'Y'일 때만 true, 그 외 (N, 빈값 등) false
                    } else {
                        isActive = false; // is_active 열은 있는데 해당 행에 값이 없으면 비활성
                    }
                } else {
                    isActive = true; // is_active 열 자체가 없으면 모두 활성
                }

                // 시트에서 읽은 paramTypeFromSheet가 dropdownBaseIds에 있는지 확인
                if (dropdownBaseIds.includes(paramTypeFromSheet)) {
                    if (isActive && optionVal && optionVal.toLowerCase() !== 'undefined') {
                        // masterOptionLists의 키로 paramTypeFromSheet (긴 이름) 사용
                        masterOptionLists[paramTypeFromSheet].add(optionVal); 
                    }
                }
            }
        }
        dropdownBaseIds.forEach(baseId => { // 디버깅 시 baseId는 긴 이름
             console.log(`DEBUG: Master options loaded for [${baseId}]:`, Array.from(masterOptionLists[baseId] || new Set()));
        });
    } catch (error) {
        console.error("마스터 옵션 CSV 파싱 오류:", error);
        alert("드롭다운 옵션을 불러오는 중 오류가 발생했습니다. 관리자에게 문의하세요.");
        dropdownBaseIds.forEach(baseId => {
            if (!masterOptionLists[baseId]) masterOptionLists[baseId] = new Set();
        });
    }
}

// 이하 함수들은 baseId로 긴 이름 ('utm_campaign_ad_type' 등)을 받도록 DOMContentLoaded에서 호출됨
function renderDropdownWithOptions(baseId) {
    const optionsList = document.getElementById(`${baseId}_options_list`);
    const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
    if (!optionsList || !addOptionButton) {
        console.error(`Dropdown elements not found for ${baseId}`);
        return;
    }

    optionsList.innerHTML = '';
    optionsList.appendChild(addOptionButton);

    // masterOptionLists의 키는 이제 긴 이름 (예: 'utm_campaign_ad_type')
    const defaultOptionsFromMaster = masterOptionLists[baseId] || new Set();
    const allRenderedValuesLowerCase = new Set(); 

    defaultOptionsFromMaster.forEach(originalValueFromMaster => { 
        const valueTrimmed = String(originalValueFromMaster).trim();
        const lowerCaseValue = valueTrimmed.toLowerCase();
        if (valueTrimmed && !allRenderedValuesLowerCase.has(lowerCaseValue)) {
            const li = createOptionLi(lowerCaseValue, valueTrimmed, 'default'); 
            optionsList.insertBefore(li, addOptionButton);
            allRenderedValuesLowerCase.add(lowerCaseValue);
        }
    });

    const storageKey = baseId; // 로컬 스토리지 키도 긴 이름 사용
   // const customValuesFromStorage = JSON.parse(localStorage.getItem(storageKey) || '[]'); 
    
    // customValuesFromStorage.forEach(originalValueFromStorage => {
    //     const valueTrimmed = String(originalValueFromStorage).trim();
    //     const lowerCaseValue = valueTrimmed.toLowerCase();

    //     if (valueTrimmed && !allRenderedValuesLowerCase.has(lowerCaseValue)) {
    //         let isInMasterListAlready = false;
    //         defaultOptionsFromMaster.forEach(masterOpt => {
    //             if (String(masterOpt).trim().toLowerCase() === lowerCaseValue) {
    //                 isInMasterListAlready = true;
    //             }
    //         });

    //         if (!isInMasterListAlready) {
    //             const li = createOptionLi(lowerCaseValue, valueTrimmed, 'custom');
    //             optionsList.insertBefore(li, addOptionButton);
    //             allRenderedValuesLowerCase.add(lowerCaseValue);
    //         }
    //     }
    // });
}

function saveCustomOptionsToStorage(baseId) { // baseId는 긴 이름
    const optionsList = document.getElementById(`${baseId}_options_list`);
    if (!optionsList) {
        console.error(`[saveCustomOptionsToStorage] Options list for ${baseId} not found.`);
        return;
    }
    const storageKey = baseId; // 로컬 스토리지 키도 긴 이름
    
    const customValues = [];
    optionsList.querySelectorAll('li[data-type="custom"]').forEach(li => {
        const contentElement = li.querySelector('.option-content');
        if (contentElement && contentElement.textContent) {
            customValues.push(contentElement.textContent.trim()); 
        }
    });
    try {
  //     localStorage.setItem(storageKey, JSON.stringify(customValues));
        console.log(`[saveCustomOptionsToStorage] Saved custom options for [${baseId}] to localStorage with key [${storageKey}]:`, customValues);
    } catch (e) {
        console.error(`[saveCustomOptionsToStorage] Error saving to localStorage for ${baseId} with key [${storageKey}]:`, e);
    }
}

function setupDropdownInteractions(baseId) { // baseId는 긴 이름
    const dropdown = document.getElementById(`${baseId}_dropdown`);
    const selectedValueDiv = document.getElementById(`${baseId}_selected_value`);
    const optionsList = document.getElementById(`${baseId}_options_list`);
    const hiddenInput = document.getElementById(baseId); 
    const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
    const addInputContainer = document.getElementById(`${baseId}_add_input_container`);
    const addInput = document.getElementById(`${baseId}_add_input`);

    if (!dropdown || !selectedValueDiv || !optionsList || !hiddenInput || !addOptionButton || !addInputContainer || !addInput) {
        console.warn(`SetupDropdownInteractions: Elements for ${baseId} not fully found.`);
        return;
    }


    selectedValueDiv.addEventListener('click', (event) => {
        event.stopPropagation(); closeOtherDropdowns(baseId); optionsList.classList.toggle('hidden'); addInputContainer.classList.add('hidden');
    });

    optionsList.addEventListener('click', (event) => {
        event.stopPropagation();
        const targetLi = event.target.closest('li');
        if (event.target.classList.contains('delete-btn') && targetLi && targetLi.dataset.type === 'custom') {
            const textContent = targetLi.querySelector('.option-content')?.textContent || targetLi.dataset.value;
            if (confirm(`'${textContent}' 항목을 삭제하시겠습니까? (브라우저 저장소에서만 삭제됩니다)`)) {
                if (hiddenInput.value === targetLi.dataset.value) { 
                    selectedValueDiv.textContent = '-- 선택하세요 --';
                    hiddenInput.value = '';
                }
                targetLi.remove();
                saveCustomOptionsToStorage(baseId); 
                updateFinalURL();
            }
        } else if (targetLi && targetLi.classList.contains('add-option')) {
            addInputContainer.classList.remove('hidden'); addInput.value = ''; addInput.focus();
        } else if (targetLi && typeof targetLi.dataset.value !== 'undefined') {
            const valueToStoreInHidden = targetLi.dataset.value; 
            const textToDisplay = targetLi.querySelector('.option-content')?.textContent || valueToStoreInHidden; 
            
            selectedValueDiv.textContent = textToDisplay;    
            hiddenInput.value = valueToStoreInHidden;       
            
            optionsList.classList.add('hidden');
            addInputContainer.classList.add('hidden');
            updateFinalURL();
        }
    });

    addInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            const originalNewValue = addInput.value.trim(); 
            const lowerCaseNewValue = originalNewValue.toLowerCase(); 

            if (!originalNewValue) { alert('추가할 값을 입력해주세요.'); return; }
            if (originalNewValue.toLowerCase() === 'undefined') { 
                alert("'undefined'라는 값은 옵션으로 추가할 수 없습니다.");
                addInput.value = '';
                return;
            }
            if (/\s|&|\?|#|\.|\/|\\/.test(originalNewValue)) { alert("띄어쓰기 및 특수문자(&, ?, #, ., /, \\)는 사용할 수 없습니다."); return; }
            if (/[^a-zA-Z0-9_\-]/.test(originalNewValue)) { alert("옵션 값은 영문, 숫자, 언더스코어(_), 하이픈(-)만 사용할 수 있습니다."); return; }
            if (/[^a-z0-9_\-]/.test(lowerCaseNewValue)) { alert("내부 Key값 생성 규칙에 어긋납니다(영문소문자,숫자,_, -). 입력값을 확인해주세요."); return;}


            let existsInCurrentDropdown = false;
            optionsList.querySelectorAll('li[data-value]').forEach(li => { if(li.dataset.value === lowerCaseNewValue) existsInCurrentDropdown = true; });
            if (existsInCurrentDropdown) { alert("이미 현재 드롭다운 목록에 존재하는 값입니다 (소문자 기준)."); return; }

            const newLi = createOptionLi(lowerCaseNewValue, originalNewValue, 'custom'); 
            optionsList.insertBefore(newLi, addOptionButton);
            saveCustomOptionsToStorage(baseId); 
            
            selectedValueDiv.textContent = originalNewValue; 
            hiddenInput.value = lowerCaseNewValue;    
            addInputContainer.classList.add('hidden');
            optionsList.classList.add('hidden');
            updateFinalURL();
        }
    });
    addInput.addEventListener('blur', () => {
        setTimeout(() => { if (!addInputContainer.contains(document.activeElement)) { addInputContainer.classList.add('hidden'); } }, 150);
    });
}

function closeOtherDropdowns(currentBaseId) { // baseId는 긴 이름
    dropdownBaseIds.forEach(baseId => {
        if (baseId !== currentBaseId) {
            document.getElementById(`${baseId}_options_list`)?.classList.add('hidden');
            document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden');
        }
    });
}
document.addEventListener('click', (event) => { // baseId는 긴 이름
    dropdownBaseIds.forEach(baseId => {
        const dropdownElement = document.getElementById(`${baseId}_dropdown`);
        if (dropdownElement && !dropdownElement.contains(event.target)) {
            document.getElementById(`${baseId}_options_list`)?.classList.add('hidden');
            document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden');
        }
    });
});

// getValueOrN은 baseId (이제 긴 이름)를 받아서 hidden input의 소문자 값을 반환
function getValueOrN(elementId /* 이제 긴 이름, 예: 'utm_campaign_ad_type' */) { 
    const element = document.getElementById(elementId); 
    let value = "";
    if (element) { 
        value = element.value.trim(); 
    }
    
    const selectedDisplayElement = document.getElementById(`${elementId}_selected_value`); 
    if (selectedDisplayElement && selectedDisplayElement.textContent.trim() === "-- 선택하세요 --") {
        return "n";
    }
    
    if (value === "") { 
        return "n";
    }
    return value.toLowerCase(); 
}

function updateFinalURL() { 
    const pageUrl = document.getElementById("page_url").value.trim();
    // getValueOrN에 긴 baseId 전달
    const utmSource = getValueOrN("source");
    const utmMedium = getValueOrN("medium");
    
    const campaignDateRaw = document.getElementById("campaign_date").value.trim(); 
    const campaignDate = campaignDateRaw === "" ? "N" : campaignDateRaw; 

    const adType = getValueOrN("utm_campaign_ad_type");
    const campaignGoal = getValueOrN("utm_campaign_goal");
    const eventType = getValueOrN("utm_campaign_event_type");
    const productCategory = getValueOrN("utm_campaign_product_category");
    const adTarget = getValueOrN("utm_campaign_ad_target");
    const creativeType = getValueOrN("utm_campaign_creative_type");
    const deviceType = getValueOrN("utm_campaign_device_type");

    const utmCampaignParts = [ 
        campaignDate, 
        adType === "n" ? "N" : adType,
        campaignGoal === "n" ? "N" : campaignGoal,
        eventType === "n" ? "N" : eventType,
        productCategory === "n" ? "N" : productCategory,
        adTarget === "n" ? "N" : adTarget,
        creativeType === "n" ? "N" : creativeType,
        deviceType === "n" ? "N" : deviceType
    ];
    const utmCampaign = utmCampaignParts.join("_");
    document.getElementById("utm_campaign").value = utmCampaign;

    const contentAction = getValueOrN("utm_content_content_action");
    const contentDetailRaw = document.getElementById("content_detail").value.trim();
    const contentDetail = contentDetailRaw === "" ? "N" : contentDetailRaw; 

    const contentVersionRaw = document.getElementById("content_version").value.trim();
    const contentVersion = contentVersionRaw === "" ? "N" : contentVersionRaw; 

    const utmContentParts = [
        contentAction === "n" ? "N" : contentAction,
        contentDetail === "N" ? "N" : contentDetail.toLowerCase(), 
        contentVersion === "N" ? "N" : contentVersion.toLowerCase() 
    ];
    const utmContentCombined = utmContentParts.every(part => part === "N") ? "N" : utmContentParts.join("_");
    document.getElementById("utm_content").value = utmContentCombined;
    
    const utmTermRaw = document.getElementById("utm_term").value.trim();
    const utmTerm = utmTermRaw === "" ? "n" : utmTermRaw; 

    let finalURLGenerated = pageUrl;
    if (!pageUrl) {
        document.getElementById("final_url").value = "";
        return;
    }
    const params = [];
    if (utmSource !== "n") params.push(`utm_source=${encodeURIComponent(utmSource)}`);
    if (utmMedium !== "n") params.push(`utm_medium=${encodeURIComponent(utmMedium)}`);
    
    const defaultCampaign = Array(utmCampaignParts.length).fill("N").join("_");
    if (utmCampaign && utmCampaign !== defaultCampaign) {
        params.push(`utm_campaign=${encodeURIComponent(utmCampaign)}`);
    }
    
    if (utmContentCombined && utmContentCombined !== "N" && utmContentCombined !== "N_N_N") { 
        params.push(`utm_content=${encodeURIComponent(utmContentCombined)}`);
    }
    if (utmTerm !== "n") params.push(`utm_term=${encodeURIComponent(utmTerm.toLowerCase())}`); 

    if (params.length > 0) {
        finalURLGenerated += (pageUrl.includes('?') ? '&' : '?') + params.join('&');
    }
    document.getElementById("final_url").value = finalURLGenerated;
}

async function fetchHistoryData() { 
    try {
        if (!GOOGLE_SHEET_HISTORY_CSV_URL || GOOGLE_SHEET_HISTORY_CSV_URL === '여기에_새로운_Google_Sheet_게시_CSV_URL_붙여넣기') {
            console.warn("Google Sheet 히스토리 CSV URL이 설정되지 않았습니다.");
            return [];
        }
        const response = await fetch(GOOGLE_SHEET_HISTORY_CSV_URL);
        if (!response.ok) {
            console.warn(`히스토리 CSV(${GOOGLE_SHEET_HISTORY_CSV_URL}) 없음 또는 불러오기 실패:`, response.status, response.statusText);
            return [];
        }
        const csvText = await response.text();
        if (!csvText) {
            console.warn(`히스토리 CSV(${GOOGLE_SHEET_HISTORY_CSV_URL}) 내용이 비어있습니다.`);
            return [];
        }

        const lines = csvText.split(/\r?\n/);
        if (lines.length < 2) { 
            console.warn("히스토리 CSV 데이터가 충분하지 않습니다 (헤더와 최소 1개의 데이터 행 필요).");
            return [];
        }

        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        const historyArray = [];

        const headerMap = { 
            timestamp: headers.indexOf('생성일시'),
            utm_source: headers.indexOf('Source'),
            utm_medium: headers.indexOf('Medium'),
            utm_campaign_combined: headers.indexOf('Campaign'),
            utm_content_combined: headers.indexOf('Content'),
            utm_term: headers.indexOf('Term'),
            page_url: headers.indexOf('페이지 URL'),
            final_url: headers.indexOf('최종 URL'),
            short_url: headers.indexOf('단축 URL')
        };

        for (const key in headerMap) {
            if (headerMap[key] === -1) {
                console.warn(`히스토리 CSV에서 필수 헤더 '${Object.keys(headerMap).find(k => k === key)}'(CSV 헤더: '${key}')를 찾을 수 없습니다. 현재 CSV 헤더: ${headers.join(', ')}`);
            }
        }

        for (let i = 1; i < lines.length; i++) {
            const lineContent = lines[i].trim();
            if (lineContent === '') continue; 

            const columns = lineContent.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
            
            const entry = {};
            for (const key in headerMap) {
                if (headerMap[key] !== -1 && columns.length > headerMap[key]) {
                    let cellValue = columns[headerMap[key]];
                    if (cellValue === undefined || cellValue.toLowerCase() === 'undefined' || cellValue === '') {
                        if (key === 'utm_term' || key === 'short_url' || key === 'utm_content_combined') {
                            cellValue = 'N'; 
                        } else if (key === 'timestamp') {
                            cellValue = ''; 
                        } else {
                             cellValue = 'N';
                        }
                    }
                    entry[key] = cellValue;
                } else {
                    entry[key] = (key === 'utm_term' || key === 'short_url' || key === 'utm_content_combined' || key === 'timestamp') ? 'N' : 'N/A';
                }
            }
            historyArray.push(entry);
        }

        return historyArray.sort((a, b) => {
            const timeA = a.timestamp || '';
            const timeB = b.timestamp || '';
            try {
                const dateA = new Date(timeA); 
                const dateB = new Date(timeB);
                const valA = !isNaN(dateA.getTime()) ? dateA.getTime() : 0;
                const valB = !isNaN(dateB.getTime()) ? dateB.getTime() : 0;
                return valB - valA; 
            } catch (e) { 
                return 0;
            }
        });
    } catch (error) {
        console.warn(`히스토리 데이터(CSV, ${GOOGLE_SHEET_HISTORY_CSV_URL}) 로딩 또는 파싱 실패:`, error);
        return [];
    }
}

async function renderHistoryTable() { 
    const tableBody = document.getElementById('historyTable')?.getElementsByTagName('tbody')[0];
    if (!tableBody) { console.error("History table body (tbody) 요소를 찾을 수 없습니다!"); return; }
    tableBody.innerHTML = '';

    showLoading("이력 로딩 중...");
    let historyData;
    try {
        historyData = await fetchHistoryData();
    } catch (fetchError) {
        console.error("fetchHistoryData 함수 호출 중 오류 발생:", fetchError);
        historyData = [];
    }
    hideLoading();

    if (!Array.isArray(historyData) || historyData.length === 0) {
        const row = tableBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 9;
        cell.textContent = '표시할 생성 이력이 없습니다.';
        cell.style.textAlign = 'center';
        return;
    }

    historyData.forEach(item => {
        const row = tableBody.insertRow();
        let displayTimestamp = 'N/A';
        const itemTimestamp = item?.timestamp;


        if (itemTimestamp && itemTimestamp !== 'N' && itemTimestamp !== '') {
    try {
        let dateObj;
        let parsableTimestamp = String(itemTimestamp).trim(); // 앞뒤 공백 

        // 1. ISO 8601 형식을 우선적으로 시도 (가장 표준적인 형식)
        // 예: "2025-05-27T00:00:00Z", "2025-05-27T09:00:00+09:00"
        if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+-]\d{2}:?\d{2})?$/.test(parsableTimestamp)) {
            dateObj = new Date(parsableTimestamp);
        } else {
            // 2. ISO 8601 형식이 아니라면, 기존의 한국어 형식 파싱 시도
            const kDateMatch = parsableTimestamp.match(/^(\d{2,4})\W?\s*(\d{1,2})\W?\s*(\d{1,2})\W?\s*(오전|오후)?\s*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?/);

            if (kDateMatch) {
                let year = parseInt(kDateMatch[1], 10);
                if (year < 100 && year >= 0) { // 두 자리 연도 처리
                    year += (year > 50 ? 1900 : 2000); // 50 초과면 19xx, 아니면 20xx (상황에 맞게 조정)
                }
                const month = parseInt(kDateMatch[2], 10) - 1; // JS 월은 0부터 시작
                const day = parseInt(kDateMatch[3], 10);
                const ampm = kDateMatch[4]; // "오전", "오후", 또는 undefined
                let hour = kDateMatch[5] ? parseInt(kDateMatch[5], 10) : 0;
                const minute = kDateMatch[6] ? parseInt(kDateMatch[6], 10) : 0;
                const second = kDateMatch[7] ? parseInt(kDateMatch[7], 10) : 0; // 초도 고려

                if (ampm) { // 오전/오후가 명시된 경우
                    if (ampm === '오후' && hour >= 1 && hour < 12) { // 오후 1시 ~ 11시
                        hour += 12;
                    } else if (ampm === '오전' && hour === 12) { // 오전 12시 (자정)
                        hour = 0;
                    }
                    // 오후 12시(정오)는 hour가 12이고 ampm이 '오후'이므로 첫 번째 조건에 안 걸리고 그대로 12시 유지 (정상)
                }
                // 오전/오후 명시 없이 24시간제로 들어올 수도 있음 (이 경우 ampm은 undefined)

                // Date 객체 생성 시, JavaScript는 이 숫자들을 로컬 시간대로 해석합니다.
                dateObj = new Date(year, month, day, hour, minute, second || 0);
            } else {
                // 위 두 형식 모두 아니면, 그냥 원본 문자열로 Date 객체 생성을 시도 (브라우저/JS 엔진의 자체 파싱 능력에 의존)
                // 이 경우, 문자열이 표준적이지 않으면 결과가 부정확하거나 Invalid Date가 될 수 있습니다.
                dateObj = new Date(parsableTimestamp);
            }
        }
        
        // 3. 생성된 Date 객체가 유효한지 확인
        if (dateObj && !isNaN(dateObj.getTime())) {
            // 4. 원하는 형식으로 한국 시간(KST)으로 표시
            displayTimestamp = dateObj.toLocaleString('ko-KR', {
                year: '2-digit',
                month: 'numeric', // '2-digit'로 하면 항상 두 자리 (예: "05월")
                day: 'numeric',   // '2-digit'로 하면 항상 두 자리 (예: "07일")
                hour: 'numeric',  // '2-digit'
                minute: 'numeric',// '2-digit'
                hour12: true,     // 오전/오후 표시
                timeZone: 'Asia/Seoul' // 명시적으로 한국 시간대로 지정 (선택 사항, 대부분 브라우저가 이미 한국 시간대)
            });
        } else {
            displayTimestamp = itemTimestamp; // 파싱 실패 시 원본 값 사용
            console.warn("Timestamp parsing failed for: ", itemTimestamp, ". Attempted with: ", parsableTimestamp, ". Resulting dateObj: ", dateObj);
        }
    } catch (e) {
        console.warn("Error parsing timestamp for history: ", itemTimestamp, e);
        displayTimestamp = itemTimestamp;
    }
}

        
        row.insertCell().textContent = displayTimestamp;
        row.insertCell().textContent = item?.utm_source || 'N';
        row.insertCell().textContent = item?.utm_medium || 'N';
        row.insertCell().textContent = item?.utm_campaign_combined || 'N';
        row.insertCell().textContent = item?.utm_content_combined || 'N';
        row.insertCell().textContent = item?.utm_term || 'N';
        
        const pageUrlCell = row.insertCell();
        pageUrlCell.style.cssText = 'max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
        const originalPageUrl = item?.page_url || '';
        if (originalPageUrl && originalPageUrl !=='N' && (originalPageUrl.startsWith('http://') || originalPageUrl.startsWith('https://'))) {
            const link = document.createElement('a');
            link.href = originalPageUrl; link.textContent = originalPageUrl; link.target = '_blank'; link.title = originalPageUrl;
            pageUrlCell.appendChild(link);
        } else {
            pageUrlCell.textContent = originalPageUrl || 'N/A'; if (originalPageUrl && originalPageUrl !== 'N') pageUrlCell.title = originalPageUrl; else pageUrlCell.title = '';
        }

        const finalUrlCell = row.insertCell();
        finalUrlCell.style.cssText = 'max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
        const finalUrl = item?.final_url || '';
        if (finalUrl && finalUrl !== 'N' && (finalUrl.startsWith('http://') || finalUrl.startsWith('https://'))) {
            const link = document.createElement('a');
            link.href = finalUrl; link.textContent = finalUrl; link.target = '_blank'; link.title = finalUrl;
            finalUrlCell.appendChild(link);
        } else {
            finalUrlCell.textContent = finalUrl || 'N/A'; if (finalUrl && finalUrl !== 'N') finalUrlCell.title = finalUrl; else finalUrlCell.title = '';
        }
        
        const shortUrlCell = row.insertCell();
        const shortUrl = item?.short_url || '';
        if (shortUrl && shortUrl !== 'N' && (shortUrl.startsWith('http://') || shortUrl.startsWith('https://'))) {
            const link = document.createElement('a');
            link.href = shortUrl; link.textContent = shortUrl; link.target = '_blank'; link.title = shortUrl;
            shortUrlCell.appendChild(link);
        } else {
            shortUrlCell.textContent = shortUrl || 'N/A'; if (shortUrl && shortUrl !== 'N') shortUrlCell.title = shortUrl; else shortUrlCell.title = '';
        }
        shortUrlCell.style.cssText = 'max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
    });
}
function copyLink() { 
    const input = document.getElementById("shortUrlInput");
    if (!input || !input.value) {
        alert("복사할 단축 URL이 없습니다."); return;
    }
    input.select(); input.setSelectionRange(0, 99999);
    try {
        const successful = document.execCommand("copy");
        if (successful) { alert("✅ 단축 URL 복사 완료!"); }
        else { alert("❌ 단축 URL 복사에 실패했습니다. 직접 복사해주세요."); }
    } catch (err) {
        alert("❌ 복사 기능 사용 중 오류가 발생했습니다."); console.error('Copy error', err);
    }
    if (window.getSelection) { window.getSelection().removeAllRanges(); }
    else if (document.selection) { document.selection.empty(); }
}

document.getElementById("utmForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    showLoading("UTM 링크 생성 및 전송 중...");

    const requiredFieldsCheck = [
        { id: "page_url", name: "Page URL" }, 
        { id: "source", name: "소스" }, // baseId가 'source' (짧은 이름)
        { id: "medium", name: "매체" }, // baseId가 'medium' (짧은 이름)
        { id: "campaign_date", name: "날짜" },
        { id: "utm_campaign_ad_type", name: "광고타입" },     // baseId가 'utm_campaign_ad_type' (긴 이름)
        { id: "utm_campaign_device_type", name: "기기카테고리" } // baseId가 'utm_campaign_device_type' (긴 이름)
    ];

    for (let field of requiredFieldsCheck) {
        let valueToCheck;
        if (field.id === "campaign_date") {
            valueToCheck = document.getElementById(field.id).value.trim();
            if (valueToCheck === "") valueToCheck = "n"; 
        } else {
            valueToCheck = getValueOrN(field.id); // getValueOrN은 이제 긴 ID를 받을 수 있음
        }

        if (valueToCheck === "n") { 
            alert(`필수 항목 '${field.name}'을(를) 선택 또는 입력해주세요.`);
            hideLoading();
            const elementToFocus = document.getElementById(field.id);
            // HTML의 ID가 긴 이름으로 변경되었으므로, _dropdown 접미사도 긴 이름 기준으로 찾음
            if (document.getElementById(`${field.id}_dropdown`)) { 
                document.getElementById(`${field.id}_selected_value`)?.focus(); 
                document.getElementById(`${field.id}_selected_value`)?.click();
            } else { 
                elementToFocus?.focus();
            }
            return;
        }
    }
    
    updateFinalURL(); 

    const formDataForN8n = {
        page_url: document.getElementById('page_url').value.trim(),
        utm_campaign_combined: document.getElementById('utm_campaign').value.trim(),
        utm_content_combined: document.getElementById('utm_content').value.trim(),
        final_url: document.getElementById('final_url').value.trim(),
        timestamp: new Date().toISOString()
    };

    // parametersToLog의 id도 긴 이름으로 변경해야 함 (getValueOrN에 전달되므로)
    const parametersToLog = [
        { id: 'source', keyForN8n: 'utm_source' }, 
        { id: 'medium', keyForN8n: 'utm_medium' },
        { id: 'utm_campaign_ad_type', keyForN8n: 'ad_type' }, // n8n 키는 짧은 이름으로 유지할지, 긴 이름으로 통일할지 결정 필요. 여기서는 이전처럼 유지
        { id: 'utm_campaign_goal', keyForN8n: 'campaign_goal' }, 
        { id: 'utm_campaign_event_type', keyForN8n: 'event_type' },
        { id: 'utm_campaign_product_category', keyForN8n: 'product_category' }, 
        { id: 'utm_campaign_ad_target', keyForN8n: 'ad_target' },
        { id: 'utm_campaign_creative_type', keyForN8n: 'creative_type' }, 
        { id: 'utm_campaign_device_type', keyForN8n: 'device_type' },
        { id: 'utm_content_content_action', keyForN8n: 'content_action' }
    ];

    const campaignDateVal = document.getElementById('campaign_date').value.trim();
    if (campaignDateVal) formDataForN8n.campaign_date = campaignDateVal;

    const contentDetailVal = document.getElementById('content_detail').value.trim();
    if (contentDetailVal) formDataForN8n.content_detail = contentDetailVal.toLowerCase();
    
    const contentVersionVal = document.getElementById('content_version').value.trim();
    if (contentVersionVal) formDataForN8n.content_version = contentVersionVal.toLowerCase();

    const utmTermVal = document.getElementById('utm_term').value.trim();
    if (utmTermVal) formDataForN8n.utm_term = utmTermVal.toLowerCase();


    for (const param of parametersToLog) {
        const elementValue = getValueOrN(param.id); // param.id는 이제 긴 이름
        if (elementValue !== "n") { 
            formDataForN8n[param.keyForN8n] = elementValue; 
        }
    }
    
    const newOptionsForMasterSheet = []; 
    console.log("--- Identifying new options to add to master sheet (Submit Event) ---");
    for (const baseId of dropdownBaseIds) { // baseId는 긴 이름
        const hiddenInputElement = document.getElementById(baseId); 
        const selectedValueDisplayElement = document.getElementById(`${baseId}_selected_value`);

        if (hiddenInputElement && selectedValueDisplayElement) {
            const selectedValueDisplayText = selectedValueDisplayElement.textContent.trim(); 
            
            if (selectedValueDisplayText && selectedValueDisplayText !== "-- 선택하세요 --" && selectedValueDisplayText.toLowerCase() !== 'n' && selectedValueDisplayText.toLowerCase() !== 'undefined') {
                const masterListForThisCategory = masterOptionLists[baseId] || new Set();
                let isNewForMaster = true;
                const lowercasedSelectedDisplayText = selectedValueDisplayText.toLowerCase();

                if (masterListForThisCategory.size > 0) {
                    for (const masterOption of masterListForThisCategory) { 
                        if (String(masterOption).trim().toLowerCase() === lowercasedSelectedDisplayText) {
                            isNewForMaster = false;
                            break;
                        }
                    }
                }
                
                if (isNewForMaster) {
                    newOptionsForMasterSheet.push({
                        unique_id: `${baseId}::${selectedValueDisplayText}`, // baseId는 긴 이름
                        parameter_type: baseId, // baseId는 긴 이름 (시트의 parameter_type과 일치)
                        option_value: selectedValueDisplayText, 
                        is_active: 'Y'
                    });
                }
            }
        }
    }
    
    if (newOptionsForMasterSheet.length > 0) {
        formDataForN8n.options_to_add_to_master_sheet = newOptionsForMasterSheet;
    }

    console.log("--- 최종 formDataForN8n (to be sent to n8n):", JSON.stringify(formDataForN8n, null, 2), " ---");
    
    try {
        // const n8nUrl = N8N_WEBHOOK_URL;
        // if (!n8nUrl || n8nUrl === '여기에_N8N_WEBHOOK_PRODUCTION_URL_입력하세요' || (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:')) {
        //     let alertMessage = "n8n 웹훅 URL이 올바르게 설정되지 않았습니다.\n";
        //     if (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:') {
        //         alertMessage = "경고: 현재 페이지는 HTTPS이나 n8n 웹훅은 HTTP 로컬호스트입니다. 실제 환경에서는 정상 동작하지 않을 수 있습니다.\n(혼합 콘텐츠 오류 발생 가능)\n";
        //     }
        //     alertMessage += "\nUTM 링크가 생성되었습니다 (단축 및 이력/시트 저장 안됨):\n" + (formDataForN8n.final_url || document.getElementById('final_url').value.trim());
        //     alert(alertMessage);
        //     document.getElementById("responseContainer").style.display = "none";
        //     hideLoading();
        //     return;
        // }

        const res = await fetch(N8N_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formDataForN8n)
        });

        if (!res.ok) { 
            const errorText = await res.text(); 
            console.error(`n8n 웹훅 응답 오류 (${res.status}):`, errorText);
            let displayError = `n8n 웹훅 응답 오류 (${res.status} ${res.statusText}).`;
            if (errorText) {
                try {
                    const errorJson = JSON.parse(errorText);
                    if (errorJson.message) {
                        displayError += `\n메시지: ${errorJson.message}`;
                    }
                } catch (e) {
                    displayError += `\n내용: ${errorText.substring(0, 200)}${errorText.length > 200 ? '...' : ''}`;
                }
            }
            throw new Error(displayError);
        }
        
        const resultText = await res.text(); // 먼저 텍스트로 받고 비어있는지 확인
        if (!resultText) { // 응답 본문이 비어있는 경우
            console.warn("n8n 응답 본문이 비어있습니다.");
            alert("n8n 요청은 성공했으나 응답 내용이 없습니다. (시트 저장은 시도되었을 수 있습니다)\n최종 URL: " + (formDataForN8n.final_url || document.getElementById('final_url').value.trim()));
            document.getElementById("responseContainer").style.display = "none";
            await renderHistoryTable();
            hideLoading();
            return;
        }

        const result = JSON.parse(resultText); // 비어있지 않으면 JSON 파싱

        if (result.short_url) {
            document.getElementById("shortUrlInput").value = result.short_url;
            document.getElementById("responseContainer").style.display = "block";
            await renderHistoryTable(); 
            alert("UTM 링크 생성, 단축 및 시트 저장 요청 완료!\n최종 URL: " + (formDataForN8n.final_url || document.getElementById('final_url').value.trim()) + "\n단축 URL: " + result.short_url);
        } else {
            let successMsg = "n8n 요청은 성공했으나 단축 URL을 받아오지 못했습니다.";
            if(result.message) successMsg = result.message; 
            else if(Object.keys(result).length > 0) successMsg += ` 응답: ${JSON.stringify(result)}`;

            alert(successMsg + "\n(시트 저장은 시도되었을 수 있습니다)\n최종 URL: " + (formDataForN8n.final_url || document.getElementById('final_url').value.trim()));
            document.getElementById("responseContainer").style.display = "none";
            await renderHistoryTable(); 
        }
    } catch (err) { 
        console.error("n8n 전송 또는 처리 오류:", err); 
        alert(`서버 통신 또는 처리 중 오류가 발생했습니다: ${err.message}\n(UTM 링크는 생성되었으나 단축 및 이력/시트 저장은 실패했을 수 있습니다)\n최종 URL: ${formDataForN8n.final_url || document.getElementById('final_url').value.trim()}`);
        document.getElementById("responseContainer").style.display = "none";
    } finally {
        hideLoading();
        location.reload();
    }
});
</script>
</body>
</html>