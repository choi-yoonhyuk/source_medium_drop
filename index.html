<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTM ë§í¬ ìƒì„±ê¸° (n8n ì—°ë™ - ìµœì¢… ë¡œì§ ì ìš©)</title>
<style>
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ - ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ */
body { font-family: sans-serif; padding: 20px; font-size: 14px; }
.dv1, .dv2, .dv3 { margin-bottom: 20px; }
.top-button-container { display: flex; justify-content: flex-end; margin-bottom: 15px; gap: 10px; }
.top-button-container button { padding: 8px 15px; font-size: 0.9em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
.top-button-container button:hover { background-color: #0056b3; }
h1 { margin-top: 0; }
label { display: inline-block; min-width: 120px; margin-bottom: 5px; vertical-align: top; padding-top: 8px; }
input[type="text"] { padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px; vertical-align: middle; }
input[type="text"]#final_url { background-color: #eee; }
button { padding: 8px 15px; margin-left: 5px; cursor: pointer; vertical-align: middle; } /* ì¼ë°˜ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
fieldset { margin-bottom: 20px; border:1px solid #ccc; padding:10px; }
legend { font-weight: bold; }
.required { color: red; font-weight: bold; }
.hidden { display: none !important; }
#loadingIndicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; display: none; }
.custom-dropdown-container { display: inline-block; vertical-align: top; }
.custom-dropdown { position: relative; display: inline-block; min-width: 200px; width: auto; max-width: 300px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; margin-bottom: 10px; }
.dropdown-selected { padding: 8px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
.dropdown-selected::after { content: 'â–¼'; font-size: 0.8em; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #888; }
.dropdown-options { position: absolute; top: 100%; left: 0; right: 0; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; list-style: none; padding: 0; margin: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.dropdown-options li { padding: 8px 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; white-space: nowrap; }
.dropdown-options li:hover { background-color: #f0f0f0; }
.dropdown-options li .option-content { flex-grow: 1; margin-left: 8px; overflow: hidden; text-overflow: ellipsis; }
.dropdown-options li .icon { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #ddd; flex-shrink: 0; }
.dropdown-options li[data-type="default"] .icon { background-color: #aaa; }
.dropdown-options li[data-type="custom"] .icon { background-color: #6aabff; }
.dropdown-options li .delete-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 1.1em; padding: 0 5px; margin-left: 10px; flex-shrink: 0; font-weight: bold; }
.dropdown-options li .delete-btn:hover { color: #f00; }
.dropdown-options li[data-type="default"] .delete-btn { display: none; }
.dropdown-options .add-option { color: #007bff; font-weight: bold; border-top: 1px solid #eee; }
.add-option-input { padding: 5px; border-top: 1px solid #eee; background-color: #f9f9f9; }
.add-option-input input[type="text"] { width: calc(100% - 16px); margin: 0; box-sizing: border-box; }
#responseContainer { display: none; margin-top: 20px; }
#responseContainer input[type="text"] { width: calc(100% - 100px); margin-right: 10px; }
form#utmForm button[type="submit"] { 
    padding: 8px 15px; 
    margin-left: 5px; 
    cursor: pointer; 
    vertical-align: middle; 
    background-color: #28a745; 
    color: white; 
    border:none; 
    border-radius:5px;
}
form#utmForm button[type="submit"]:hover { background-color: #218838; }
#historyTable th, #historyTable td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word; }
#historyTable th { background-color: #f0f0f0; position: sticky; top: 0; z-index: 1;}
#historyTableContainer { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; }
</style>
</head>
<body>
<div id="loadingIndicator">ë¡œë”© ì¤‘...</div>

<div class="dv1">
<div class="dv2">
    <div class="top-button-container">
        <button onclick="location.href='https://choi-yoonhyuk.github.io/utm_key_value/'">UTM ì˜µì…˜ ëª©ë¡</button>
        <button onclick="location.href='https://choi-yoonhyuk.github.io/utm_history/'">UTM ìƒì„± ì´ë ¥</button>
        </div>
    <h1>UTM ë§í¬ ìƒì„±</h1>
    <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;">
        <thead><tr><th colspan="2">UTM ë„¤ì´ë° ê·œì¹™</th></tr></thead>
        <tbody>
            <tr><td>ê³µí†µ ê·œì¹™</td><td><ul><li>ë„ì–´ì“°ê¸° ê¸ˆì§€</li><li>êµ¬ë¶„ì: ì–¸ë”ìŠ¤ì½”ì–´('_') ë° í•˜ì´í”ˆ('-') ì‚¬ìš©</li><li>ì˜ë¬¸ ë„¤ì´ë°: ì†Œë¬¸ìë§Œ ì‚¬ìš©</li><li>íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ê¸ˆì§€ (&amp;, ?, #, ., /, \ ë“±)</li></ul></td></tr>
            <tr><td>ìº í˜ì¸ ê·œì¹™</td><td><ul><li>êµ¬ì„±: ë‚ ì§œ_ê´‘ê³ íƒ€ì…_ìº í˜ì¸ëª©í‘œ_ê¸°íšì „ì¢…ë¥˜_ìƒí’ˆì¹´í…Œê³ ë¦¬_ê´‘ê³ íƒ€ê²Ÿ_ì†Œì¬íƒ€ì…_ê¸°ê¸°ì¹´í…Œê³ ë¦¬</li><li>ì—†ìœ¼ë©´ 'N'ìœ¼ë¡œ ì±„ì›€</li><li><span class="required">í•„ìˆ˜ í•­ëª©: ë‚ ì§œ, ê´‘ê³ íƒ€ì…, ê¸°ê¸°ì¹´í…Œê³ ë¦¬</span></li></ul></td></tr>
            <tr><td>ì½˜í…ì¸  ê·œì¹™</td><td><ul><li>ëª©í‘œí–‰ë™, ì¶”ê°€ê¸°ì…ì‚¬í•­, ë²„ì „ ì¤‘ í•˜ë‚˜ë¼ë„ ì…ë ¥ë˜ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ì¡°í•©</li><li>ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ 'N'ìœ¼ë¡œ ì²˜ë¦¬</li></ul></td></tr>
        </tbody>
    </table>
    <br>
</div>

<div class="dv3">
    <form id="utmForm">
        <label for="page_url">Page URL <span class="required">(í•„ìˆ˜)</span>:</label>
        <input type="text" id="page_url" name="page_url_form" required placeholder="https://example.com" oninput="updateFinalURL()"><br><br>

        <label for="source">UTM Source <span class="required">(í•„ìˆ˜)</span>:</label>
        <div class="custom-dropdown-container">
            <div class="custom-dropdown" id="source_dropdown">
                <div class="dropdown-selected" id="source_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                <ul class="dropdown-options hidden" id="source_options_list">
                    <li class="add-option" id="source_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                </ul>
                <div class="add-option-input hidden" id="source_add_input_container">
                    <input type="text" id="source_add_input" placeholder="ì…ë ¥ í›„ Enter">
                </div>
            </div>
            <input type="hidden" id="source" name="source_hidden" required>
        </div>
        <br><br>

        <label for="medium">UTM Medium <span class="required">(í•„ìˆ˜)</span>:</label>
        <div class="custom-dropdown-container">
            <div class="custom-dropdown" id="medium_dropdown">
                <div class="dropdown-selected" id="medium_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                <ul class="dropdown-options hidden" id="medium_options_list">
                    <li class="add-option" id="medium_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                </ul>
                <div class="add-option-input hidden" id="medium_add_input_container">
                    <input type="text" id="medium_add_input" placeholder="ì…ë ¥ í›„ Enter">
                </div>
            </div>
            <input type="hidden" id="medium" name="medium_hidden" required>
        </div>
        <br><br>
        
        <fieldset style="border:1px solid #ccc; padding:10px;">
            <legend>UTM Campaign êµ¬ì„±</legend>
            <label for="campaign_date">ë‚ ì§œ <span class="required">(í•„ìˆ˜)</span>:</label>
            <input type="text" id="campaign_date" name="campaign_date_form" placeholder="YYYYMMDD" oninput="updateFinalURL()" required><br><br> 
            <label for="ad_type">ê´‘ê³ íƒ€ì… <span class="required">(í•„ìˆ˜)</span>:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="ad_type_dropdown">
                    <div class="dropdown-selected" id="ad_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="ad_type_options_list"> <li class="add-option" id="ad_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li> </ul>
                    <div class="add-option-input hidden" id="ad_type_add_input_container"><input type="text" id="ad_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="ad_type" name="ad_type_hidden" required>
            </div><br><br>
            <label for="campaign_goal">ìº í˜ì¸ëª©í‘œ:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="campaign_goal_dropdown">
                    <div class="dropdown-selected" id="campaign_goal_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="campaign_goal_options_list"><li class="add-option" id="campaign_goal_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="campaign_goal_add_input_container"><input type="text" id="campaign_goal_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="campaign_goal" name="campaign_goal_hidden">
            </div><br><br>
            <label for="event_type">ê¸°íšì „ì¢…ë¥˜:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="event_type_dropdown">
                    <div class="dropdown-selected" id="event_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="event_type_options_list"><li class="add-option" id="event_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="event_type_add_input_container"><input type="text" id="event_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="event_type" name="event_type_hidden"> 
            </div><br><br>
            <label for="product_category">ìƒí’ˆì¹´í…Œê³ ë¦¬:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="product_category_dropdown">
                    <div class="dropdown-selected" id="product_category_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="product_category_options_list"><li class="add-option" id="product_category_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="product_category_add_input_container"><input type="text" id="product_category_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="product_category" name="product_category_hidden"> 
            </div><br><br>
            <label for="ad_target">ê´‘ê³ íƒ€ê²Ÿ:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="ad_target_dropdown">
                    <div class="dropdown-selected" id="ad_target_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="ad_target_options_list"><li class="add-option" id="ad_target_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="ad_target_add_input_container"><input type="text" id="ad_target_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="ad_target" name="ad_target_hidden"> 
            </div><br><br>
            <label for="creative_type">ì†Œì¬íƒ€ì…:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="creative_type_dropdown">
                    <div class="dropdown-selected" id="creative_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="creative_type_options_list"><li class="add-option" id="creative_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="creative_type_add_input_container"><input type="text" id="creative_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="creative_type" name="creative_type_hidden"> 
            </div><br><br>
            <label for="device_type">ê¸°ê¸°ì¹´í…Œê³ ë¦¬ <span class="required">(í•„ìˆ˜)</span>:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="device_type_dropdown">
                    <div class="dropdown-selected" id="device_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="device_type_options_list"><li class="add-option" id="device_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="device_type_add_input_container"><input type="text" id="device_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="device_type" name="device_type_hidden" required> 
            </div><br><br>
        </fieldset>
    
        <fieldset style="border:1px solid #ccc; padding:10px;">
            <legend>UTM Content êµ¬ì„±</legend>
            <label for="content_action">ëª©í‘œí–‰ë™:</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="content_action_dropdown">
                    <div class="dropdown-selected" id="content_action_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="content_action_options_list"><li class="add-option" id="content_action_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="content_action_add_input_container"><input type="text" id="content_action_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="content_action" name="content_action_hidden"> 
            </div><br><br>
            <label for="content_detail">ì¶”ê°€ê¸°ì…ì‚¬í•­:</label>
            <input type="text" id="content_detail" name="content_detail_form" placeholder="120X240-vertical" oninput="updateFinalURL()"><br><br> 
            <label for="content_version">ë²„ì „:</label>
            <input type="text" id="content_version" name="content_version_form" placeholder="v1" oninput="updateFinalURL()"><br><br> 
        </fieldset>

        <label for="utm_term">UTM Term (ì„ íƒ):</label>
        <input type="text" id="utm_term" name="utm_term_form" placeholder="shoes" oninput="updateFinalURL()"><br><br> 

        <input type="hidden" id="utm_campaign" name="utm_campaign_combined" required>
        <input type="hidden" id="utm_content" name="utm_content_combined">

        <label for="final_url">ìµœì¢… URL:</label>
        <input type="text" id="final_url" name="final_url_display" readonly style="width:100%; font-family:monospace;"> 
        <button type="submit">ì œì¶œ</button>
    </form>

    <div id="responseContainer">
        <label for="shortUrlInput">ğŸ”— ë‹¨ì¶• URL:</label>
        <input type="text" id="shortUrlInput" readonly="" style="font-family:monospace;">
        <button type="button" onclick="copyLink()">ğŸ“‹ ë³µì‚¬</button>
    </div>

    <div id="historyTableContainer" style="margin-top: 30px;">
        <h2>ìƒì„± ì´ë ¥</h2>
        <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;" id="historyTable">
            <thead></thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>
</div>

<script>
// --- ì„¤ì •ê°’ ---
const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1861589139&single=true&output=csv';
const N8N_WEBHOOK_URL = 'https://entrench-consulting.app.n8n.cloud/webhook-test/15daaf64-30ee-4b32-9426-45a8c8bd9184'; // <-- ì‚¬ìš©ì ì‹¤ì œ n8n URLë¡œ ë³€ê²½ í•„ìˆ˜!
const HISTORY_JSON_URL = 'https://raw.githubusercontent.com/choi-yoonhyuk/source_medium_drop/main/n8n-builder.json'; 


const dropdownBaseIds = [
    'source', 'medium', 'ad_type', 'campaign_goal', 'event_type', 
    'product_category', 'ad_target', 'creative_type', 'device_type', 'content_action'
];

const columnHeaderMap = { 
    'source': 'source', 'medium': 'medium', 'ad_type': 'utm_campaign_ad_type',
    'campaign_goal': 'utm_campaign_goal', 'event_type': 'utm_campaign_event_type',
    'product_category': 'utm_campaign_product_category', 'ad_target': 'utm_campaign_ad_target',
    'creative_type': 'utm_campaign_creative_type', 'device_type': 'utm_campaign_device_type',
    'content_action': 'utm_content_content_action'
};

let masterOptionLists = {}; 

// â–¼â–¼â–¼ "ìƒì„± ì´ë ¥" í…Œì´ë¸” í—¤ë” ë° ë°ì´í„° ë§¤í•‘ ì •ë³´ â–¼â–¼â–¼
const historyTableConfig = [
    { displayName: 'ìƒì„±ì¼ì‹œ', csvHeaderKey: 'timestamp', isLink: false }, // CSV í—¤ë”ê°€ 'timestamp'ë¼ê³  ê°€ì •
    { displayName: 'Source', csvHeaderKey: 'utm_source', isLink: false },
    { displayName: 'Medium', csvHeaderKey: 'utm_medium', isLink: false },
    { displayName: 'Campaign', csvHeaderKey: 'utm_campaign_combined', isLink: false },
    { displayName: 'Content', csvHeaderKey: 'utm_content_combined', isLink: false },
    { displayName: 'Term', csvHeaderKey: 'utm_term', isLink: false },
    { displayName: 'í˜ì´ì§€ URL', csvHeaderKey: 'page_url', isLink: true },
    { displayName: 'ìµœì¢… URL', csvHeaderKey: 'final_url', isLink: true },
    { displayName: 'ë‹¨ì¶• URL', csvHeaderKey: 'short_url', isLink: true }
];
// â–²â–²â–² "ìƒì„± ì´ë ¥" í…Œì´ë¸” í—¤ë” ë° ë°ì´í„° ë§¤í•‘ ì •ë³´ ì™„ë£Œ â–²â–²â–²


document.addEventListener('DOMContentLoaded', async () => {
    showLoading("ì˜µì…˜ ë° ì´ë ¥ ë¡œë”© ì¤‘...");
    try {
        // ì˜µì…˜ ë§ˆìŠ¤í„° ë¡œë“œ
        const csvResponse = await fetch(GOOGLE_SHEET_CSV_URL);
        if (!csvResponse.ok) throw new Error(`ë“œë¡­ë‹¤ìš´ ì˜µì…˜ CSV ë¡œë“œ ì‹¤íŒ¨ (${csvResponse.status})`);
        const csvDataText = await csvResponse.text();
        console.log("ë“œë¡­ë‹¤ìš´ ì˜µì…˜ CSV ë°ì´í„° ë¡œë“œ ì™„ë£Œ");
        parseAndStoreMasterOptions(csvDataText);

        for (const baseId of dropdownBaseIds) {
            renderDropdownWithOptions(baseId);
            setupDropdownInteractions(baseId);
        }
        updateFinalURL(); 
        
        // ìƒì„± ì´ë ¥ í…Œì´ë¸” ë Œë”ë§
        await renderHistoryTable(); 

    } catch (error) {
        console.error("ì´ˆê¸° ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
        alert(`ì´ˆê¸° ë°ì´í„°(ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë˜ëŠ” ì´ë ¥)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    } finally {
        hideLoading();
    }
});

function showLoading(message = "ì²˜ë¦¬ ì¤‘...") { /* ì´ì „ê³¼ ë™ì¼ */ }
function hideLoading() { /* ì´ì „ê³¼ ë™ì¼ */ }
function createOptionLi(value, displayText, type) { /* ì´ì „ê³¼ ë™ì¼ */ }
function parseAndStoreMasterOptions(csvDataText) { /* ì´ì „ê³¼ ë™ì¼ */ }
function renderDropdownWithOptions(baseId) { /* ì´ì „ê³¼ ë™ì¼ (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë¡œë”© ì£¼ì„ ì²˜ë¦¬) */ }
function saveCustomOptionsToStorage(baseId) { /* ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ ê¸°ëŠ¥ ì„ì‹œ ì¤‘ë‹¨ */ }
function setupDropdownInteractions(baseId) { /* ì´ì „ê³¼ ë™ì¼ (saveCustomOptionsToStorage í˜¸ì¶œ ì£¼ì„ ì²˜ë¦¬) */ }
function closeOtherDropdowns(currentBaseId) { /* ì´ì „ê³¼ ë™ì¼ */ }
document.addEventListener('click', (event) => { /* ì´ì „ê³¼ ë™ì¼ */ });
function getValueOrN(elementId) { /* ì´ì „ê³¼ ë™ì¼ */ }
function updateFinalURL() { /* ì´ì „ê³¼ ë™ì¼ */ }

// â–¼â–¼â–¼ fetchHistoryData í•¨ìˆ˜: HISTORY_DATA_CSV_URL ì‚¬ìš© ë° CSV íŒŒì‹± ë¡œì§ â–¼â–¼â–¼
async function fetchHistoryData() { 
    if (!HISTORY_DATA_CSV_URL || HISTORY_DATA_CSV_URL.startsWith('ì—¬ê¸°ì—_')) { 
        console.warn("UTM ìƒì„± ì´ë ¥ CSV URLì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return [];
    }
    try {
        const response = await fetch(HISTORY_DATA_CSV_URL, { cache: 'no-cache' });
        if (!response.ok) {
            console.warn(`ìƒì„± ì´ë ¥ CSV ë¡œë“œ ì‹¤íŒ¨ (${HISTORY_DATA_CSV_URL}):`, response.status, response.statusText);
            return []; 
        }
        const csvText = await response.text(); 
        if (!csvText.trim()) {
            console.warn(`ìƒì„± ì´ë ¥ CSV ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤ (${HISTORY_DATA_CSV_URL}).`);
            return []; 
        }
        
        const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== "");
        if (lines.length < 2) { 
            console.warn("ìƒì„± ì´ë ¥ CSVì— í—¤ë” ë˜ëŠ” ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return [];
        }
        const csvHeaders = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        const historyArray = [];

        for (let i = 1; i < lines.length; i++) {
            const cells = lines[i].split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
            const entry = {};
            csvHeaders.forEach((header, index) => {
                // historyTableConfigë¥¼ ì‚¬ìš©í•˜ì—¬ CSV í—¤ë”ë¥¼ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  í‚¤ë¡œ ë§¤í•‘
                const headerConfigEntry = historyTableConfig.find(hConf => hConf.csvHeader === header);
                const keyToUse = headerConfigEntry ? headerConfigEntry.key : header.toLowerCase().replace(/\s+/g, '_'); // ë§¤í•‘ëœ í‚¤ ë˜ëŠ” ê¸°ë³¸ ë³€í™˜
                entry[keyToUse] = cells[index] || "";
            });
            historyArray.push(entry);
        }
        
        // ìµœì‹ ìˆœ ì •ë ¬ (timestamp í•„ë“œê°€ Date.parse ê°€ëŠ¥í•œ í˜•ì‹ì´ì–´ì•¼ í•¨)
        return historyArray.sort((a, b) => {
            const timestampKey = historyTableConfig.find(h => h.displayName === 'ìƒì„±ì¼ì‹œ')?.key || 'timestamp';
            const timeA = new Date(a[timestampKey] || 0).getTime(); 
            const timeB = new Date(b[timestampKey] || 0).getTime();
            if (isNaN(timeA)) return 1; 
            if (isNaN(timeB)) return -1;
            return timeB - timeA; 
        });

    } catch (error) {
        console.warn(`ìƒì„± ì´ë ¥ ë°ì´í„° ë¡œë”© ë˜ëŠ” íŒŒì‹± ì‹¤íŒ¨(${HISTORY_DATA_CSV_URL}):`, error);
        return []; 
    }
}
// â–²â–²â–² fetchHistoryData í•¨ìˆ˜ ì™„ë£Œ â–²â–²â–²


// â–¼â–¼â–¼ renderHistoryTable í•¨ìˆ˜: ì§€ì •ëœ í—¤ë” ìˆœì„œëŒ€ë¡œ, URL í•˜ì´í¼ë§í¬ í¬í•¨ â–¼â–¼â–¼
async function renderHistoryTable() { 
    const tableBody = document.getElementById('historyTable')?.getElementsByTagName('tbody')[0];
    const tableHead = document.getElementById('historyTable')?.getElementsByTagName('thead')[0]; 
    if (!tableBody || !tableHead) { 
        console.error("History table body (tbody) ë˜ëŠ” thead ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); 
        return; 
    }
    tableBody.innerHTML = ''; 
    tableHead.innerHTML = ''; 

    const headerRow = tableHead.insertRow();
    historyTableConfig.forEach(headerConf => {
        const th = document.createElement('th');
        th.textContent = headerConf.displayName;
        headerRow.appendChild(th);
    });

    showLoading("ì´ë ¥ ë¡œë”© ì¤‘...");
    let historyDataToRender = [];
    try {
        historyDataToRender = await fetchHistoryData(); 
    } catch (fetchError) {
        console.error("fetchHistoryData í•¨ìˆ˜ í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", fetchError);
    }
    hideLoading();

    if (!Array.isArray(historyDataToRender) || historyDataToRender.length === 0) { 
        const row = tableBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = historyTableConfig.length; 
        cell.textContent = 'í‘œì‹œí•  ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.';
        cell.style.textAlign = 'center';
        return;
    }

    historyDataToRender.forEach(item => { 
        const row = tableBody.insertRow(); 
        
        historyTableConfig.forEach(headerConf => {
            const td = row.insertCell();
            let cellValue = item[headerConf.key] || ''; 

            if (headerConf.displayName === 'ìƒì„±ì¼ì‹œ' && cellValue) {
                try {
                    const dateObj = new Date(cellValue);
                    if (!isNaN(dateObj.getTime())) {
                        td.textContent = dateObj.toLocaleString('ko-KR', { dateStyle: 'short', timeStyle: 'short'});
                    } else {
                        td.textContent = cellValue; 
                    }
                } catch (e) { td.textContent = cellValue; }
            } else if (headerConf.isLink && cellValue && String(cellValue).startsWith('http')) {
                const a = document.createElement('a');
                a.href = cellValue;
                a.textContent = cellValue; 
                a.target = "_blank";
                td.appendChild(a);
            } else {
                td.textContent = cellValue || (headerConf.key.startsWith('utm_') ? 'N' : '');
            }
            td.title = cellValue; 
            if (headerConf.key === 'page_url' || headerConf.key === 'final_url' || headerConf.key === 'short_url') {
                 td.style.cssText = `max-width: ${headerConf.key === 'page_url' ? 150 : (headerConf.key === 'final_url' ? 200 : 100)}px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;`;
            }
        });
    });
}
// â–²â–²â–² renderHistoryTable í•¨ìˆ˜ ì™„ë£Œ â–²â–²â–²

function copyLink() { /* ì´ì „ê³¼ ë™ì¼ */ }

// === í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ===
document.getElementById("utmForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    showLoading("UTM ë§í¬ ìƒì„± ë° ì „ì†¡ ì¤‘...");

    const requiredFieldsCheck = [ /* ì´ì „ê³¼ ë™ì¼ */ ];
    for (let field of requiredFieldsCheck) { /* ì´ì „ê³¼ ë™ì¼ */ }
    
    updateFinalURL(); 

    const formDataForN8n = { /* ì´ì „ê³¼ ë™ì¼ (options_to_add_to_master_sheet í¬í•¨) */ };
    const parametersToLog = [ /* ì´ì „ê³¼ ë™ì¼ */ ];
    for (const param of parametersToLog) { /* ì´ì „ê³¼ ë™ì¼ */ }
    const optionsForMasterUpdate = {}; 
    // console.log("--- Identifying new options to add to master sheet (Submit Event) ---");
    for (const baseId of dropdownBaseIds) { /* ì´ì „ê³¼ ë™ì¼ (optionsForMasterUpdate ì±„ìš°ëŠ” ë¡œì§) */ }
    if (Object.keys(optionsForMasterUpdate).length > 0) {
        formDataForN8n.options_to_add_to_master_sheet = optionsForMasterUpdate;
    }
    console.log("--- ìµœì¢… formDataForN8n (to be sent to n8n):", formDataForN8n, " ---");
    
    try {
        const n8nUrl = N8N_WEBHOOK_URL; 
        if (!n8nUrl || n8nUrl === 'ì—¬ê¸°ì—_N8N_WEBHOOK_PRODUCTION_URL_ì…ë ¥í•˜ì„¸ìš”' || (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:')) {
            /* ì´ì „ê³¼ ë™ì¼ */
            hideLoading(); return;
        }

        const res = await fetch(n8nUrl, { /* ì´ì „ê³¼ ë™ì¼ */ });
        if (!res.ok) { /* ì´ì „ê³¼ ë™ì¼ */ }
        
        const result = await res.json(); 
        let alertMessage = "";

        if (result.short_url) { /* ì´ì „ê³¼ ë™ì¼ */ } 
        else { /* ì´ì „ê³¼ ë™ì¼ */ }
        
        // n8n ì‘ë‹µì— history_dataê°€ ìˆë‹¤ë©´ ê·¸ê²ƒìœ¼ë¡œ ë°”ë¡œ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì„ íƒì  ê°•í™”)
        if (result.history_data && Array.isArray(result.history_data)) {
            console.log("Received updated history data from n8n, re-rendering table immediately.");
            await renderHistoryTableWithData(result.history_data); // ì´ í•¨ìˆ˜ëŠ” ì•„ì§ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                                                                    // renderHistoryTableì„ ìˆ˜ì •í•˜ì—¬ ë°ì´í„°ë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•˜ê±°ë‚˜,
                                                                    // ë˜ëŠ” location.reload()ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ 
                                                                    // HISTORY_DATA_CSV_URLì—ì„œ ë‹¤ì‹œ ë¡œë“œí•˜ë„ë¡ í•©ë‹ˆë‹¤.
                                                                    // ì—¬ê¸°ì„œëŠ” location.reload()ì— ì˜ì¡´í•˜ê² ìŠµë‹ˆë‹¤.
        } else {
            console.warn("n8n ì‘ë‹µì— ìµœì‹  íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ í¬í•¨ë˜ì§€ ì•Šì•„, í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ GitHub/CSVì—ì„œ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.");
        }
        alert(alertMessage);
        if (!(result.history_data && Array.isArray(result.history_data))) { // ì¦‰ì‹œ ì—…ë°ì´íŠ¸ ì•ˆí–ˆë‹¤ë©´
             await renderHistoryTable(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì „ì— í•œë²ˆ ë” ì‹œë„ (ìºì‹œ ë¬¸ì œ ìˆì„ ìˆ˜ ìˆìŒ)
        }


    } catch (err) { /* ì´ì „ê³¼ ë™ì¼ */ } 
    finally {
        hideLoading();
        location.reload(); // CSVë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ìµœì‹  ì´ë ¥ ë°˜ì˜
    }
});

// (ì„ íƒì ) n8n ì‘ë‹µìœ¼ë¡œ ë°›ì€ ë°ì´í„°ë¡œ ë°”ë¡œ íˆìŠ¤í† ë¦¬ í…Œì´ë¸”ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
// ì´ í•¨ìˆ˜ëŠ” renderHistoryTableê³¼ ê±°ì˜ ë™ì¼í•œ ë¡œì§ì„ ê°€ì§‘ë‹ˆë‹¤.
// ë§Œì•½ n8nì´ ì‘ë‹µìœ¼ë¡œ ê°€ê³µëœ history_data ë°°ì—´ì„ ë³´ë‚´ì¤€ë‹¤ë©´ ì´ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
/*
async function renderHistoryTableWithData(data) {
    const tableBody = document.getElementById('historyTable')?.getElementsByTagName('tbody')[0];
    const tableHead = document.getElementById('historyTable')?.getElementsByTagName('thead')[0];
    if (!tableBody || !tableHead) { 
        console.error("History table body or head not found! (renderHistoryTableWithData)");
        return; 
    }
    tableBody.innerHTML = ''; 
    tableHead.innerHTML = ''; 

    const headerRow = tableHead.insertRow();
    historyTableConfig.forEach(headerConf => {
        const th = document.createElement('th');
        th.textContent = headerConf.displayName;
        headerRow.appendChild(th);
    });

    if (!Array.isArray(data) || data.length === 0) { 
        // ... (ì´ë ¥ ì—†ìŒ ë©”ì‹œì§€ - renderHistoryTableê³¼ ë™ì¼)
        return;
    }

    data.forEach(item => {
        // ... (renderHistoryTableì˜ forEach ë‚´ë¶€ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ í–‰ ì¶”ê°€) ...
    });
}
*/
</script>
</body>
</html>