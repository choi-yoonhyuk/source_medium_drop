<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTM ë§í¬ ìƒì„±ê¸° (n8n ì—°ë™ - ìµœì¢… ë¡œì§ ì ìš©)</title>
<style>
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ - ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ */
body { font-family: sans-serif; padding: 20px; font-size: 14px; }
.dv1, .dv2, .dv3 { margin-bottom: 20px; }
.button-container { margin-bottom: 20px; }
.button-container button { padding: 10px 15px; font-size: 1em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
.button-container button:hover { background-color: #0056b3; }
label { display: inline-block; min-width: 120px; margin-bottom: 5px; vertical-align: top; padding-top: 8px; }
input[type="text"] { padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px; vertical-align: middle; }
input[type="text"]#final_url { background-color: #eee; }
button { padding: 8px 15px; margin-left: 5px; cursor: pointer; vertical-align: middle; }
fieldset { margin-bottom: 20px; border:1px solid #ccc; padding:10px; }
legend { font-weight: bold; }
.required { color: red; font-weight: bold; }
.hidden { display: none !important; }
#loadingIndicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; display: none; }
.custom-dropdown-container { display: inline-block; vertical-align: top; }
.custom-dropdown { position: relative; display: inline-block; min-width: 200px; width: auto; max-width: 300px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; margin-bottom: 10px; }
.dropdown-selected { padding: 8px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
.dropdown-selected::after { content: 'â–¼'; font-size: 0.8em; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #888; }
.dropdown-options { position: absolute; top: 100%; left: 0; right: 0; background-color: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; list-style: none; padding: 0; margin: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.dropdown-options li { padding: 8px 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; white-space: nowrap; }
.dropdown-options li:hover { background-color: #f0f0f0; }
.dropdown-options li .option-content { flex-grow: 1; margin-left: 8px; overflow: hidden; text-overflow: ellipsis; }
.dropdown-options li .icon { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #ddd; flex-shrink: 0; }
.dropdown-options li[data-type="default"] .icon { background-color: #aaa; }
.dropdown-options li[data-type="custom"] .icon { background-color: #6aabff; }
.dropdown-options li .delete-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 1.1em; padding: 0 5px; margin-left: 10px; flex-shrink: 0; font-weight: bold; }
.dropdown-options li .delete-btn:hover { color: #f00; }
.dropdown-options li[data-type="default"] .delete-btn { display: none; }
.dropdown-options .add-option { color: #007bff; font-weight: bold; border-top: 1px solid #eee; }
.add-option-input { padding: 5px; border-top: 1px solid #eee; background-color: #f9f9f9; }
.add-option-input input[type="text"] { width: calc(100% - 16px); margin: 0; box-sizing: border-box; }
#responseContainer { display: none; margin-top: 20px; }
#responseContainer input[type="text"] { width: calc(100% - 100px); margin-right: 10px; }
</style>
</head>
<body>
<div id="loadingIndicator">ë¡œë”© ì¤‘...</div>

<div class="dv1">
<div class="dv2">
Â  Â  <div class="button-container">
Â  Â  Â  Â  <button onclick="location.href='https://choi-yoonhyuk.github.io/utm_key_value/'">UTM ì˜µì…˜ ëª©ë¡</button>
Â  Â  </div>
Â  Â  <div class="button-container">
Â  Â  Â  Â  <button onclick="location.href='https://choi-yoonhyuk.github.io/utm_history/'">UTM ìƒì„± ì´ë ¥</button>
Â  Â  </div>
Â  Â  <h1>UTM ë§í¬ ìƒì„±</h1>
Â  Â  <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;">
Â  Â  Â  Â  <thead><tr><th colspan="2">UTM ë„¤ì´ë° ê·œì¹™</th></tr></thead>
Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  <tr><td>ê³µí†µ ê·œì¹™</td><td><ul><li>ë„ì–´ì“°ê¸° ê¸ˆì§€</li><li>êµ¬ë¶„ì: ì–¸ë”ìŠ¤ì½”ì–´('_') ë° í•˜ì´í”ˆ('-') ì‚¬ìš©</li><li>ì˜ë¬¸ ë„¤ì´ë°: ì†Œë¬¸ìë§Œ ì‚¬ìš©</li><li>íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ê¸ˆì§€ (&amp;, ?, #, ., /, \ ë“±)</li></ul></td></tr>
Â  Â  Â  Â  Â  Â  <tr><td>ìº í˜ì¸ ê·œì¹™</td><td><ul><li>êµ¬ì„±: ë‚ ì§œ_ê´‘ê³ íƒ€ì…_ìº í˜ì¸ëª©í‘œ_ê¸°íšì „ì¢…ë¥˜_ìƒí’ˆì¹´í…Œê³ ë¦¬_ê´‘ê³ íƒ€ê²Ÿ_ì†Œì¬íƒ€ì…_ê¸°ê¸°ì¹´í…Œê³ ë¦¬</li><li>ì—†ìœ¼ë©´ 'N'ìœ¼ë¡œ ì±„ì›€</li><li><span class="required">í•„ìˆ˜ í•­ëª©: ë‚ ì§œ, ê´‘ê³ íƒ€ì…, ê¸°ê¸°ì¹´í…Œê³ ë¦¬</span></li></ul></td></tr>
Â  Â  Â  Â  Â  Â  <tr><td>ì½˜í…ì¸  ê·œì¹™</td><td><ul><li>ëª©í‘œí–‰ë™, ì¶”ê°€ê¸°ì…ì‚¬í•­, ë²„ì „ ì¤‘ í•˜ë‚˜ë¼ë„ ì…ë ¥ë˜ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ì¡°í•©</li><li>ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ 'N'ìœ¼ë¡œ ì²˜ë¦¬</li></ul></td></tr>
Â  Â  Â  Â  </tbody>
Â  Â  </table>
Â  Â  <br>
</div>

<div class="dv3">
Â  Â  <form id="utmForm">
Â  Â  Â  Â  <label for="page_url">Page URL <span class="required">(í•„ìˆ˜)</span>:</label>
Â  Â  Â  Â  <input type="text" id="page_url" name="page_url_form" required placeholder="https://example.com" oninput="updateFinalURL()"><br><br>

Â  Â  Â  Â  <label for="source">UTM Source <span class="required">(í•„ìˆ˜)</span>:</label>
Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="source_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="source_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="source_options_list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="add-option" id="source_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="source_add_input_container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="source_add_input" placeholder="ì…ë ¥ í›„ Enter">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <input type="hidden" id="source" name="source_hidden" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <br><br>

Â  Â  Â  Â  <label for="medium">UTM Medium <span class="required">(í•„ìˆ˜)</span>:</label>
Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="medium_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="medium_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="medium_options_list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="add-option" id="medium_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="medium_add_input_container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="medium_add_input" placeholder="ì…ë ¥ í›„ Enter">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <input type="hidden" id="medium" name="medium_hidden" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <br><br>
Â  Â  Â  Â  
Â  Â  Â  Â  <fieldset style="border:1px solid #ccc; padding:10px;">
Â  Â  Â  Â  Â  Â  <legend>UTM Campaign êµ¬ì„±</legend>
Â  Â  Â  Â  Â  Â  <label for="campaign_date">ë‚ ì§œ <span class="required">(í•„ìˆ˜)</span>:</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="campaign_date" name="campaign_date_form" placeholder="YYYYMMDD" oninput="updateFinalURL()" required><br><br>
Â  Â  Â  Â  Â  Â  <label for="ad_type">ê´‘ê³ íƒ€ì… <span class="required">(í•„ìˆ˜)</span>:</label>
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="ad_type_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="ad_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="ad_type_options_list"> <li class="add-option" id="ad_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li> </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="ad_type_add_input_container"><input type="text" id="ad_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div><input type="hidden" id="ad_type" name="ad_type_hidden" required>
Â  Â  Â  Â  Â  Â  </div><br><br>
Â  Â  Â  Â  Â  Â  <label for="campaign_goal">ìº í˜ì¸ëª©í‘œ:</label>
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="campaign_goal_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="campaign_goal_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="campaign_goal_options_list"><li class="add-option" id="campaign_goal_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="campaign_goal_add_input_container"><input type="text" id="campaign_goal_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div><input type="hidden" id="campaign_goal" name="campaign_goal_hidden">
Â  Â  Â  Â  Â  Â  </div><br><br>
Â  Â  Â  Â  Â  Â  <label for="event_type">ê¸°íšì „ì¢…ë¥˜:</label>
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="event_type_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="event_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="event_type_options_list"><li class="add-option" id="event_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="event_type_add_input_container"><input type="text" id="event_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div><input type="hidden" id="event_type" name="event_type_hidden">
Â  Â  Â  Â  Â  Â  </div><br><br>
Â  Â  Â  Â  Â  Â  <label for="product_category">ìƒí’ˆì¹´í…Œê³ ë¦¬:</label>
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="product_category_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="product_category_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="product_category_options_list"><li class="add-option" id="product_category_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="product_category_add_input_container"><input type="text" id="product_category_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div><input type="hidden" id="product_category" name="product_category_hidden">
Â  Â  Â  Â  Â  Â  </div><br><br>
Â  Â  Â  Â  Â  Â  <label for="ad_target">ê´‘ê³ íƒ€ê²Ÿ:</label>
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="ad_target_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="ad_target_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="ad_target_options_list"><li class="add-option" id="ad_target_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="ad_target_add_input_container"><input type="text" id="ad_target_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div><input type="hidden" id="ad_target" name="ad_target_hidden">
Â  Â  Â  Â  Â  Â  </div><br><br>
Â  Â  Â  Â  Â  Â  <label for="creative_type">ì†Œì¬íƒ€ì…:</label>
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="creative_type_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="creative_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="creative_type_options_list"><li class="add-option" id="creative_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="creative_type_add_input_container"><input type="text" id="creative_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div><input type="hidden" id="creative_type" name="creative_type_hidden">
Â  Â  Â  Â  Â  Â  </div><br><br>
Â  Â  Â  Â  Â  Â  <label for="device_type">ê¸°ê¸°ì¹´í…Œê³ ë¦¬ <span class="required">(í•„ìˆ˜)</span>:</label>
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="device_type_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="device_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="device_type_options_list"><li class="add-option" id="device_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="device_type_add_input_container"><input type="text" id="device_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div><input type="hidden" id="device_type" name="device_type_hidden" required>
Â  Â  Â  Â  Â  Â  </div><br><br>
Â  Â  Â  Â  </fieldset>
Â  Â  
Â  Â  Â  Â  <fieldset style="border:1px solid #ccc; padding:10px;">
Â  Â  Â  Â  Â  Â  <legend>UTM Content êµ¬ì„±</legend>
Â  Â  Â  Â  Â  Â  <label for="content_action">ëª©í‘œí–‰ë™:</label>
Â  Â  Â  Â  Â  Â  <div class="custom-dropdown-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-dropdown" id="content_action_dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown-selected" id="content_action_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="dropdown-options hidden" id="content_action_options_list"><li class="add-option" id="content_action_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="add-option-input hidden" id="content_action_add_input_container"><input type="text" id="content_action_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div><input type="hidden" id="content_action" name="content_action_hidden">
Â  Â  Â  Â  Â  Â  </div><br><br>
Â  Â  Â  Â  Â  Â  <label for="content_detail">ì¶”ê°€ê¸°ì…ì‚¬í•­:</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="content_detail" name="content_detail_form" placeholder="120X240-vertical" oninput="updateFinalURL()"><br><br>
Â  Â  Â  Â  Â  Â  <label for="content_version">ë²„ì „:</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="content_version" name="content_version_form" placeholder="v1" oninput="updateFinalURL()"><br><br>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  <label for="utm_term">UTM Term (ì„ íƒ):</label>
Â  Â  Â  Â  <input type="text" id="utm_term" name="utm_term_form" placeholder="shoes" oninput="updateFinalURL()"><br><br>

Â  Â  Â  Â  <input type="hidden" id="utm_campaign" name="utm_campaign_combined" required>
Â  Â  Â  Â  <input type="hidden" id="utm_content" name="utm_content_combined">

Â  Â  Â  Â  <label for="final_url">ìµœì¢… URL:</label>
Â  Â  Â  Â  <input type="text" id="final_url" name="final_url_display" readonly style="width:100%; font-family:monospace;">
Â  Â  Â  Â  <button type="submit">ì œì¶œ</button>
Â  Â  </form>

Â  Â  <div id="responseContainer">
Â  Â  Â  Â  <label for="shortUrlInput">ğŸ”— ë‹¨ì¶• URL:</label>
Â  Â  Â  Â  <input type="text" id="shortUrlInput" readonly="" style="font-family:monospace;">
Â  Â  Â  Â  <button type="button" onclick="copyLink()">ğŸ“‹ ë³µì‚¬</button>
Â  Â  </div>

Â  Â  <div id="historyTableContainer" style="margin-top: 30px;">
Â  Â  Â  Â  <h2>ìƒì„± ì´ë ¥</h2>
Â  Â  Â  Â  <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;" id="historyTable">
Â  Â  Â  Â  Â  Â  <thead><tr><th>ìƒì„±ì¼ì‹œ</th><th>Source</th><th>Medium</th><th>Campaign</th><th>Content</th><th>Term</th><th>í˜ì´ì§€ URL</th><th>ìµœì¢… URL</th><th>ë‹¨ì¶• URL</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
</div>
</div>

<script>
// --- ì„¤ì •ê°’ ---
const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1846317494&single=true&output=csv'; // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì‹œíŠ¸ URL
const N8N_WEBHOOK_URL = 'https://entrench-consulting.app.n8n.cloud/webhook-test/15daaf64-30ee-4b32-9426-45a8c8bd9184'; // ì‹¤ì œ n8n URLë¡œ ë³€ê²½ í•„ìˆ˜!
const GOOGLE_SHEET_HISTORY_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1831366188&single=true&output=csv'; // ì´ë ¥ ì‹œíŠ¸ URL

const dropdownBaseIds = [
Â  Â  'source', 'medium', 'ad_type', 'campaign_goal', 'event_type',
Â  Â  'product_category', 'ad_target', 'creative_type', 'device_type', 'content_action'
];

let masterOptionLists = {};

document.addEventListener('DOMContentLoaded', async () => {
Â  Â  showLoading("ì˜µì…˜ ë° ì´ë ¥ ë¡œë”© ì¤‘...");
Â  Â  let csvDataText = null;
Â  Â  try {
Â  Â  Â  Â  const response = await fetch(GOOGLE_SHEET_CSV_URL);
Â  Â  Â  Â  if (!response.ok) throw new Error(`ë“œë¡­ë‹¤ìš´ ì˜µì…˜ CSV ë¡œë“œ ì‹¤íŒ¨ (${response.status})`);
Â  Â  Â  Â  csvDataText = await response.text();
Â  Â  Â  Â  console.log("ë“œë¡­ë‹¤ìš´ ì˜µì…˜ CSV ë°ì´í„° ë¡œë“œ ì™„ë£Œ");

Â  Â  Â  Â  parseAndStoreMasterOptions(csvDataText); 

Â  Â  Â  Â  for (const baseId of dropdownBaseIds) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  renderDropdownWithOptions(baseId);
Â  Â  Â  Â  Â  Â  Â  Â  setupDropdownInteractions(baseId);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Error initializing dropdown for ${baseId}:`, error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  updateFinalURL();
Â  Â  Â  Â  await renderHistoryTable();
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("ì´ˆê¸° ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
Â  Â  Â  Â  alert(`ì´ˆê¸° ë°ì´í„°(ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë˜ëŠ” ì´ë ¥)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
Â  Â  } finally {
Â  Â  Â  Â  hideLoading();
Â  Â  }
});

function showLoading(message = "ì²˜ë¦¬ ì¤‘...") {
Â  Â  const indicator = document.getElementById('loadingIndicator');
Â  Â  if (indicator) { indicator.textContent = message; indicator.style.display = 'flex'; }
}
function hideLoading() {
Â  Â  const indicator = document.getElementById('loadingIndicator');
Â  Â  if (indicator) { indicator.style.display = 'none'; }
}

function createOptionLi(value, displayText, type) {
Â  Â  const li = document.createElement('li');
Â  Â  const valueForDataset = String(value).trim().toLowerCase();
Â  Â  li.dataset.value = valueForDataset;
Â  Â  li.dataset.type = type;

Â  Â  const iconSpan = document.createElement('span'); iconSpan.className = 'icon'; li.appendChild(iconSpan);
Â  Â  const textSpan = document.createElement('span'); textSpan.className = 'option-content';
Â  Â  textSpan.textContent = String(displayText).trim() || String(value).trim();
Â  Â  li.appendChild(textSpan);

Â  Â  if (type === 'custom') {
Â  Â  Â  Â  const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; li.appendChild(deleteBtn);
Â  Â  }
Â  Â  return li;
}

function parseAndStoreMasterOptions(csvDataText) {
    dropdownBaseIds.forEach(baseId => {
        masterOptionLists[baseId] = new Set();
    });

    if (!csvDataText) {
        console.warn("CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´ ë§ˆìŠ¤í„° ì˜µì…˜ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    try {
        const lines = csvDataText.split(/\r?\n/);
        if (lines.length < 2) {
            console.warn("CSV ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (í—¤ë”ì™€ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ í•„ìš”). ìƒˆë¡œìš´ êµ¬ì¡°ì—ì„œëŠ” ë°ì´í„°ê°€ 2ë²ˆì§¸ ì¤„ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.");
            return;
        }

        const headers = lines[0].split(',').map(h => String(h).trim().replace(/^"|"$/g, ''));
        
        const parameter_type_ColIdx = headers.indexOf('parameter_type');
        const option_value_ColIdx = headers.indexOf('option_value');
        const is_active_ColIdx = headers.indexOf('is_active'); 

        if (parameter_type_ColIdx === -1 || option_value_ColIdx === -1) {
            console.error("í•„ìˆ˜ CSV í—¤ë”('parameter_type' ë˜ëŠ” 'option_value')ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ í—¤ë”:", headers.join(', '));
            alert("ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì‹œíŠ¸ì˜ í—¤ë” êµ¬ì„±ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ ('parameter_type' ë˜ëŠ” 'option_value' ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ). ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
            return;
        }

        for (let i = 1; i < lines.length; i++) {
            const lineContent = lines[i].trim();
            if (lineContent === '') continue; 

            const columns = lineContent.split(',').map(s => s.trim().replace(/^"|"$/g, ''));

            if (columns.length > Math.max(parameter_type_ColIdx, option_value_ColIdx)) {
                const paramType = String(columns[parameter_type_ColIdx]).trim();
                const optionVal = String(columns[option_value_ColIdx]).trim();
                let isActive;

                if (is_active_ColIdx !== -1) { 
                    if (columns.length > is_active_ColIdx) {
                        const activeFlag = String(columns[is_active_ColIdx]).trim().toUpperCase();
                        if (activeFlag === 'Y') {
                            isActive = true;
                        } else if (activeFlag === 'N') {
                            isActive = false;
                        } else {
                            isActive = false; 
                        }
                    } else {
                        isActive = false;
                    }
                } else {
                    isActive = true;
                }

                if (dropdownBaseIds.includes(paramType)) {
                    if (isActive && optionVal && optionVal.toLowerCase() !== 'undefined') {
                        masterOptionLists[paramType].add(optionVal); // ì›ë³¸ ëŒ€ì†Œë¬¸ì ìœ ì§€í•˜ë©° ì €ì¥
                    }
                }
            }
        }
        dropdownBaseIds.forEach(baseId => {
             console.log(`DEBUG: Master options loaded for [${baseId}]:`, Array.from(masterOptionLists[baseId] || new Set()));
        });
    } catch (error) {
        console.error("ë§ˆìŠ¤í„° ì˜µì…˜ CSV íŒŒì‹± ì˜¤ë¥˜ (ìƒˆë¡œìš´ êµ¬ì¡°):", error);
        alert("ë“œë¡­ë‹¤ìš´ ì˜µì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        dropdownBaseIds.forEach(baseId => {
            if (!masterOptionLists[baseId]) masterOptionLists[baseId] = new Set();
        });
    }
}

function renderDropdownWithOptions(baseId) {
Â  Â  const optionsList = document.getElementById(`${baseId}_options_list`);
Â  Â  const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
Â  Â  if (!optionsList || !addOptionButton) {
Â  Â  Â  Â  console.error(`Dropdown elements not found for ${baseId}`);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  optionsList.innerHTML = '';
Â  Â  optionsList.appendChild(addOptionButton);

Â  Â  const defaultOptionsFromMaster = masterOptionLists[baseId] || new Set();
Â  Â  const allRenderedValuesLowerCase = new Set();

Â  Â  defaultOptionsFromMaster.forEach(originalValue => {
Â  Â  Â  Â  const valueTrimmed = String(originalValue).trim(); // ì›ë³¸ ê°’ (ëŒ€ì†Œë¬¸ì ìœ ì§€)
Â  Â  Â  Â  const lowerCaseValue = valueTrimmed.toLowerCase(); // ë¹„êµ ë° ì¤‘ë³µ ì²´í¬ìš©
Â  Â  Â  Â  if (valueTrimmed && !allRenderedValuesLowerCase.has(lowerCaseValue)) {
Â  Â  Â  Â  Â  Â  const li = createOptionLi(valueTrimmed, valueTrimmed, 'default'); // í‘œì‹œ ë° data-valueì— ì›ë³¸ê°’ ì‚¬ìš©
Â  Â  Â  Â  Â  Â  optionsList.insertBefore(li, addOptionButton);
Â  Â  Â  Â  Â  Â  allRenderedValuesLowerCase.add(lowerCaseValue);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  const storageKey = baseId; 
Â  Â  const customValuesFromStorage = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  
Â  Â  customValuesFromStorage.forEach(originalValueFromStorage => {
Â  Â  Â  Â  const valueTrimmed = String(originalValueFromStorage).trim(); // ì›ë³¸ ê°’
Â  Â  Â  Â  const lowerCaseValue = valueTrimmed.toLowerCase();

Â  Â  Â  Â  if (valueTrimmed && !allRenderedValuesLowerCase.has(lowerCaseValue)) {
Â  Â  Â  Â  Â  Â  let isInMasterListAlready = false;
Â  Â  Â  Â  Â  Â  defaultOptionsFromMaster.forEach(masterOpt => { // masterOptëŠ” ì›ë³¸ ëŒ€ì†Œë¬¸ì ìœ ì§€
Â  Â  Â  Â  Â  Â  Â  Â  if (String(masterOpt).trim().toLowerCase() === lowerCaseValue) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isInMasterListAlready = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!isInMasterListAlready) {
Â  Â  Â  Â  Â  Â  Â  Â  const li = createOptionLi(valueTrimmed, valueTrimmed, 'custom');
Â  Â  Â  Â  Â  Â  Â  Â  optionsList.insertBefore(li, addOptionButton);
Â  Â  Â  Â  Â  Â  Â  Â  allRenderedValuesLowerCase.add(lowerCaseValue);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
}

function saveCustomOptionsToStorage(baseId) { 
Â  Â  const optionsList = document.getElementById(`${baseId}_options_list`);
Â  Â  if (!optionsList) {
Â  Â  Â  Â  console.error(`[saveCustomOptionsToStorage] Options list for ${baseId} not found.`);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  const storageKey = baseId;
Â  Â  
Â  Â  const customValues = [];
Â  Â  optionsList.querySelectorAll('li[data-type="custom"]').forEach(li => {
Â  Â  Â  Â  const contentElement = li.querySelector('.option-content');
Â  Â  Â  Â  if (contentElement && contentElement.textContent) {
Â  Â  Â  Â  Â  Â  customValues.push(contentElement.textContent.trim()); // ì›ë³¸ ëŒ€ì†Œë¬¸ì ìœ ì§€í•˜ë©° ì €ì¥
Â  Â  Â  Â  }
Â  Â  });
Â  Â  try {
Â  Â  Â  Â localStorage.setItem(storageKey, JSON.stringify(customValues));
Â  Â  Â  Â  console.log(`[saveCustomOptionsToStorage] Saved custom options for [${baseId}] to localStorage with key [${storageKey}]:`, customValues);
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(`[saveCustomOptionsToStorage] Error saving to localStorage for ${baseId} with key [${storageKey}]:`, e);
Â  Â  }
}

function setupDropdownInteractions(baseId) { 
Â  Â  const dropdown = document.getElementById(`${baseId}_dropdown`);
Â  Â  const selectedValueDiv = document.getElementById(`${baseId}_selected_value`);
Â  Â  const optionsList = document.getElementById(`${baseId}_options_list`);
Â  Â  const hiddenInput = document.getElementById(baseId);
Â  Â  const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
Â  Â  const addInputContainer = document.getElementById(`${baseId}_add_input_container`);
Â  Â  const addInput = document.getElementById(`${baseId}_add_input`);

Â  Â  if (!dropdown || !selectedValueDiv || !optionsList || !hiddenInput || !addOptionButton || !addInputContainer || !addInput) return;

Â  Â  selectedValueDiv.addEventListener('click', (event) => {
Â  Â  Â  Â  event.stopPropagation(); closeOtherDropdowns(baseId); optionsList.classList.toggle('hidden'); addInputContainer.classList.add('hidden');
Â  Â  });

Â  Â  optionsList.addEventListener('click', (event) => {
Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  const targetLi = event.target.closest('li');
Â  Â  Â  Â  if (event.target.classList.contains('delete-btn') && targetLi && targetLi.dataset.type === 'custom') {
Â  Â  Â  Â  Â  Â  const textContent = targetLi.querySelector('.option-content')?.textContent || targetLi.dataset.value;
Â  Â  Â  Â  Â  Â  if (confirm(`'${textContent}' í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¸Œë¼ìš°ì € ì €ì¥ì†Œì—ì„œë§Œ ì‚­ì œë©ë‹ˆë‹¤)`)) {
Â  Â  Â  Â  Â  Â  Â  Â  if (hiddenInput.value === targetLi.dataset.value.toLowerCase()) { // hiddenInput.valueëŠ” ì†Œë¬¸ì
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedValueDiv.textContent = '-- ì„ íƒí•˜ì„¸ìš” --';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hiddenInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  targetLi.remove();
Â  Â  Â  Â  Â  Â  Â  Â  saveCustomOptionsToStorage(baseId); 
Â  Â  Â  Â  Â  Â  Â  Â  updateFinalURL();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else if (targetLi && targetLi.classList.contains('add-option')) {
Â  Â  Â  Â  Â  Â  addInputContainer.classList.remove('hidden'); addInput.value = ''; addInput.focus();
Â  Â  Â  Â  } else if (targetLi && typeof targetLi.dataset.value !== 'undefined') {
            // createOptionLiì—ì„œ dataset.valueëŠ” ì†Œë¬¸ìí™”ëœ ê°’ì„ ì €ì¥í•˜ë„ë¡ í–ˆìŒ.
            // hiddenInputì—ëŠ” ì†Œë¬¸ì ê°’ì„, selectedValueDivì—ëŠ” ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œ
Â  Â  Â  Â  Â  Â  const valueToStore = targetLi.dataset.value; // ì†Œë¬¸ìí™”ëœ ê°’
Â  Â  Â  Â  Â  Â  const textToDisplay = targetLi.querySelector('.option-content')?.textContent || targetLi.dataset.value; // ì›ë³¸ í…ìŠ¤íŠ¸
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  selectedValueDiv.textContent = textToDisplay;
Â  Â  Â  Â  Â  Â  hiddenInput.value = valueToStore; // ì‹¤ì œ UTM íŒŒë¼ë¯¸í„° ê°’ì€ ì†Œë¬¸ìë¡œ
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  optionsList.classList.add('hidden');
Â  Â  Â  Â  Â  Â  addInputContainer.classList.add('hidden');
Â  Â  Â  Â  Â  Â  updateFinalURL();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  addInput.addEventListener('keypress', (event) => {
Â  Â  Â  Â  if (event.key === 'Enter') {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  const originalNewValue = addInput.value.trim(); // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì›ë³¸ ê°’
Â  Â  Â  Â  Â  Â  const lowerCaseNewValue = originalNewValue.toLowerCase(); // ë‚´ë¶€ ì²˜ë¦¬ ë° í‚¤ ê°’ìš©

Â  Â  Â  Â  Â  Â  if (!originalNewValue) { alert('ì¶”ê°€í•  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
Â  Â  Â  Â  Â  Â  if (originalNewValue.toLowerCase() === 'undefined') { 
Â  Â  Â  Â  Â  Â  Â  Â  alert("'undefined'ë¼ëŠ” ê°’ì€ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  Â  Â  Â  Â  Â  Â  addInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (/\s|&|\?|#|\.|\/|\\/.test(originalNewValue)) { alert("ë„ì–´ì“°ê¸° ë° íŠ¹ìˆ˜ë¬¸ì(&, ?, #, ., /, \\)ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
Â  Â  Â  Â  Â  Â  if (/[^a-z0-9_\-]/.test(lowerCaseNewValue) && !(/[^a-zA-Z0-9_\-]/.test(originalNewValue) && lowerCaseNewValue !== originalNewValue)) { // ì›ë³¸ì— ëŒ€ë¬¸ì í—ˆìš©, ë³€í™˜ëœ ê°’ì€ ì†Œë¬¸ì ê·œì¹™ ì²´í¬
               // ì´ ë¶€ë¶„ì€ key ê°’ì€ ì†Œë¬¸ì ê·œì¹™ì„ ë”°ë¥´ë˜, ì›ë³¸ ê°’ì€ ëŒ€ë¬¸ìë¥¼ í—ˆìš©í•˜ê¸° ìœ„í•œ ì¡°ê±´ ìˆ˜ì • í•„ìš”
               // UTM íŒŒë¼ë¯¸í„° ê°’ ìì²´ëŠ” ì†Œë¬¸ìë§Œ ì‚¬ìš©í•˜ë„ë¡ ê·œì¹™ì´ ìˆì—ˆìœ¼ë¯€ë¡œ, originalNewValueë„ ì†Œë¬¸ì ê·œì¹™ì„ ë”°ë¥´ë„ë¡ ìœ ë„í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
               // ë‹¤ë§Œ, í™”ë©´ í‘œì‹œ ë° ë§ˆìŠ¤í„° ì‹œíŠ¸ ì €ì¥ìš©ìœ¼ë¡œëŠ” originalNewValueë¥¼ ì‚¬ìš©
                if (/[^a-z0-9_\-]/.test(lowerCaseNewValue)) {
                     alert("Key ê°’(ì†Œë¬¸ìë¡œ ë³€í™˜ëœ ê°’)ì€ ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_), í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™”ë©´ í‘œì‹œê°’ë„ ì´ ê·œì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”."); return;
                }
            }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let existsInCurrentDropdown = false;
Â  Â  Â  Â  Â  Â  optionsList.querySelectorAll('li[data-value]').forEach(li => { if(li.dataset.value === lowerCaseNewValue) existsInCurrentDropdown = true; });
Â  Â  Â  Â  Â  Â  if (existsInCurrentDropdown) { alert("ì´ë¯¸ í˜„ì¬ ë“œë¡­ë‹¤ìš´ ëª©ë¡ì— ì¡´ì¬í•˜ëŠ” ê°’ì…ë‹ˆë‹¤ (ì†Œë¬¸ì ê¸°ì¤€)."); return; }

            // createOptionLiëŠ” ì²«ë²ˆì§¸ ì¸ìë¡œ key ê°’ì„, ë‘ë²ˆì§¸ ì¸ìë¡œ í‘œì‹œ í…ìŠ¤íŠ¸ë¥¼ ë°›ìŒ.
            // keyëŠ” ì†Œë¬¸ì, í‘œì‹œëŠ” ì›ë³¸ìœ¼ë¡œ
Â  Â  Â  Â  Â  Â  const newLi = createOptionLi(lowerCaseNewValue, originalNewValue, 'custom'); 
Â  Â  Â  Â  Â  Â  optionsList.insertBefore(newLi, addOptionButton);
Â  Â  Â  Â  Â  Â  saveCustomOptionsToStorage(baseId); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  selectedValueDiv.textContent = originalNewValue; // í™”ë©´ í‘œì‹œëŠ” ì›ë³¸ ê°’
Â  Â  Â  Â  Â  Â  hiddenInput.value = lowerCaseNewValue;         // ì‹¤ì œ ì €ì¥ì€ ì†Œë¬¸ì ê°’
Â  Â  Â  Â  Â  Â  addInputContainer.classList.add('hidden');
Â  Â  Â  Â  Â  Â  optionsList.classList.add('hidden');
Â  Â  Â  Â  Â  Â  updateFinalURL();
Â  Â  Â  Â  }
Â  Â  });
Â  Â  addInput.addEventListener('blur', () => {
Â  Â  Â  Â  setTimeout(() => { if (!addInputContainer.contains(document.activeElement)) { addInputContainer.classList.add('hidden'); } }, 150);
Â  Â  });
}

function closeOtherDropdowns(currentBaseId) { 
Â  Â  dropdownBaseIds.forEach(baseId => {
Â  Â  Â  Â  if (baseId !== currentBaseId) {
Â  Â  Â  Â  Â  Â  document.getElementById(`${baseId}_options_list`)?.classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden');
Â  Â  Â  Â  }
Â  Â  });
}
document.addEventListener('click', (event) => { 
Â  Â  dropdownBaseIds.forEach(baseId => {
Â  Â  Â  Â  const dropdownElement = document.getElementById(`${baseId}_dropdown`);
Â  Â  Â  Â  if (dropdownElement && !dropdownElement.contains(event.target)) {
Â  Â  Â  Â  Â  Â  document.getElementById(`${baseId}_options_list`)?.classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden');
Â  Â  Â  Â  }
Â  Â  });
});

function getValueOrN(elementId) { 
Â  Â  const element = document.getElementById(elementId);
Â  Â  let value = "";
Â  Â  if (element) { 
Â  Â  Â  Â  value = element.value.trim(); // hidden inputì˜ ê²½ìš° ì†Œë¬¸ìí™”ëœ ê°’ì´ê±°ë‚˜, text inputì˜ ê²½ìš° ì›ë³¸ ê°’
Â  Â  }
Â  Â  
Â  Â  const selectedDisplayElement = document.getElementById(`${elementId}_selected_value`);
Â  Â  if (selectedDisplayElement && selectedDisplayElement.textContent.trim() === "-- ì„ íƒí•˜ì„¸ìš” --") {
Â  Â  Â  Â  return "n";
Â  Â  }
    // hiddenInput.value (ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ)ëŠ” ì´ë¯¸ ì†Œë¬¸ìí™” ë˜ì–´ìˆìŒ.
    // ì¼ë°˜ í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì˜ ê²½ìš° ì—¬ê¸°ì„œ ì†Œë¬¸ìí™”.
Â  Â  if (value === "") { 
Â  Â  Â  Â  return "n";
Â  Â  }
    // ìµœì¢…ì ìœ¼ë¡œ UTM íŒŒë¼ë¯¸í„°ì— ì‚¬ìš©ë  ê°’ì€ ì†Œë¬¸ìë¡œ í†µì¼ (ë‹¨, 'N'ì€ ëŒ€ë¬¸ì ìœ ì§€)
    const lowercasedValue = value.toLowerCase();
Â  Â  return lowercasedValue === "n" ? "n" : lowercasedValue; 
}

function updateFinalURL() { 
Â  Â  const pageUrl = document.getElementById("page_url").value.trim();
Â  Â  const utmSource = getValueOrN("source");
Â  Â  const utmMedium = getValueOrN("medium");
Â  Â  const campaignDateRaw = document.getElementById("campaign_date").value.trim(); // ë‚ ì§œëŠ” YYYYMMDD í˜•ì‹ì´ë¯€ë¡œ ì†Œë¬¸ì ë³€í™˜ ë¶ˆí•„ìš”
    const campaignDate = campaignDateRaw === "" ? "N" : campaignDateRaw;

Â  Â  const adType = getValueOrN("ad_type");
Â  Â  const campaignGoal = getValueOrN("campaign_goal");
Â  Â  const eventType = getValueOrN("event_type");
Â  Â  const productCategory = getValueOrN("product_category");
Â  Â  const adTarget = getValueOrN("ad_target");
Â  Â  const creativeType = getValueOrN("creative_type");
Â  Â  const deviceType = getValueOrN("device_type");

Â  Â  const utmCampaignParts = [ // getValueOrNì€ ì´ë¯¸ 'n' ë˜ëŠ” ì†Œë¬¸ì ê°’ì„ ë°˜í™˜
Â  Â  Â  Â  campaignDate, // 'N' ë˜ëŠ” YYYYMMDD
        adType.toUpperCase() === 'N' ? 'N' : adType,
        campaignGoal.toUpperCase() === 'N' ? 'N' : campaignGoal,
        eventType.toUpperCase() === 'N' ? 'N' : eventType,
        productCategory.toUpperCase() === 'N' ? 'N' : productCategory,
        adTarget.toUpperCase() === 'N' ? 'N' : adTarget,
        creativeType.toUpperCase() === 'N' ? 'N' : creativeType,
        deviceType.toUpperCase() === 'N' ? 'N' : deviceType
Â  Â  ];
Â  Â  const utmCampaign = utmCampaignParts.join("_");
Â  Â  document.getElementById("utm_campaign").value = utmCampaign;

Â  Â  const contentAction = getValueOrN("content_action");
Â  Â  const contentDetailRaw = document.getElementById("content_detail").value.trim();
    const contentDetail = contentDetailRaw === "" ? "N" : contentDetailRaw.toLowerCase(); // ì§ì ‘ ì…ë ¥ì€ ì†Œë¬¸ìí™” ë˜ëŠ” 'N'

Â  Â  const contentVersionRaw = document.getElementById("content_version").value.trim();
    const contentVersion = contentVersionRaw === "" ? "N" : contentVersionRaw.toLowerCase(); // ì§ì ‘ ì…ë ¥ì€ ì†Œë¬¸ìí™” ë˜ëŠ” 'N'

    const utmContentParts = [
        contentAction.toUpperCase() === 'N' ? 'N' : contentAction,
        contentDetail.toUpperCase() === 'N' ? 'N' : contentDetail,
        contentVersion.toUpperCase() === 'N' ? 'N' : contentVersion
    ];
Â  Â  const utmContent = utmContentParts.every(part => part === "N") ? "N" : utmContentParts.join("_");
Â  Â  document.getElementById("utm_content").value = utmContent;
Â  Â  
Â  Â  const utmTermRaw = document.getElementById("utm_term").value.trim();
    const utmTerm = utmTermRaw === "" ? "n" : utmTermRaw.toLowerCase(); // getValueOrNê³¼ ìœ ì‚¬í•˜ê²Œ ì²˜ë¦¬

Â  Â  let finalURLGenerated = pageUrl;
Â  Â  if (!pageUrl) {
Â  Â  Â  Â  document.getElementById("final_url").value = "";
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  const params = [];
Â  Â  if (utmSource && utmSource !== "n") params.push(`utm_source=${encodeURIComponent(utmSource)}`);
Â  Â  if (utmMedium && utmMedium !== "n") params.push(`utm_medium=${encodeURIComponent(utmMedium)}`);
Â  Â  
Â  Â  const defaultCampaign = Array(utmCampaignParts.length).fill("N").join("_");
Â  Â  if (utmCampaign && utmCampaign !== defaultCampaign) {
Â  Â  Â  Â  params.push(`utm_campaign=${encodeURIComponent(utmCampaign)}`);
Â  Â  }
Â  Â  
Â  Â  const defaultContent = "N_N_N"; 
Â  Â  if (utmContent && utmContent !== "N" && utmContent !== defaultContent) { 
Â  Â  Â  Â  params.push(`utm_content=${encodeURIComponent(utmContent)}`);
Â  Â  }
Â  Â  if (utmTerm && utmTerm !== "n") params.push(`utm_term=${encodeURIComponent(utmTerm)}`);

Â  Â  if (params.length > 0) {
Â  Â  Â  Â  finalURLGenerated += (pageUrl.includes('?') ? '&' : '?') + params.join('&');
Â  Â  }
Â  Â  document.getElementById("final_url").value = finalURLGenerated;
}

async function fetchHistoryData() { 
Â  Â  try {
Â  Â  Â  Â  if (!GOOGLE_SHEET_HISTORY_CSV_URL || GOOGLE_SHEET_HISTORY_CSV_URL === 'ì—¬ê¸°ì—_ìƒˆë¡œìš´_Google_Sheet_ê²Œì‹œ_CSV_URL_ë¶™ì—¬ë„£ê¸°') {
Â  Â  Â  Â  Â  Â  console.warn("Google Sheet íˆìŠ¤í† ë¦¬ CSV URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  }
Â  Â  Â  Â  const response = await fetch(GOOGLE_SHEET_HISTORY_CSV_URL);
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  console.warn(`íˆìŠ¤í† ë¦¬ CSV(${GOOGLE_SHEET_HISTORY_CSV_URL}) ì—†ìŒ ë˜ëŠ” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:`, response.status, response.statusText);
Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  }
Â  Â  Â  Â  const csvText = await response.text();
Â  Â  Â  Â  if (!csvText) {
Â  Â  Â  Â  Â  Â  console.warn(`íˆìŠ¤í† ë¦¬ CSV(${GOOGLE_SHEET_HISTORY_CSV_URL}) ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  }

Â  Â  Â  Â  const lines = csvText.split(/\r?\n/);
Â  Â  Â  Â  if (lines.length < 2) { 
Â  Â  Â  Â  Â  Â  console.warn("íˆìŠ¤í† ë¦¬ CSV ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (í—¤ë”ì™€ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ í•„ìš”).");
Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  }

Â  Â  Â  Â  const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
Â  Â  Â  Â  const historyArray = [];

Â  Â  Â  Â  const headerMap = { 
Â  Â  Â  Â  Â  Â  timestamp: headers.indexOf('ìƒì„±ì¼ì‹œ'),
Â  Â  Â  Â  Â  Â  utm_source: headers.indexOf('Source'),
Â  Â  Â  Â  Â  Â  utm_medium: headers.indexOf('Medium'),
Â  Â  Â  Â  Â  Â  utm_campaign_combined: headers.indexOf('Campaign'),
Â  Â  Â  Â  Â  Â  utm_content_combined: headers.indexOf('Content'),
Â  Â  Â  Â  Â  Â  utm_term: headers.indexOf('Term'),
Â  Â  Â  Â  Â  Â  page_url: headers.indexOf('í˜ì´ì§€ URL'),
Â  Â  Â  Â  Â  Â  final_url: headers.indexOf('ìµœì¢… URL'),
Â  Â  Â  Â  Â  Â  short_url: headers.indexOf('ë‹¨ì¶• URL')
Â  Â  Â  Â  };

Â  Â  Â  Â  for (const key in headerMap) {
Â  Â  Â  Â  Â  Â  if (headerMap[key] === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`íˆìŠ¤í† ë¦¬ CSVì—ì„œ í•„ìˆ˜ í—¤ë” '${Object.keys(headerMap).find(k => k === key)}'(CSV í—¤ë”: '${key}')ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ CSV í—¤ë”: ${headers.join(', ')}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  for (let i = 1; i < lines.length; i++) {
Â  Â  Â  Â  Â  Â  const lineContent = lines[i].trim();
Â  Â  Â  Â  Â  Â  if (lineContent === '') continue; 

Â  Â  Â  Â  Â  Â  const columns = lineContent.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const entry = {};
Â  Â  Â  Â  Â  Â  for (const key in headerMap) {
                if (headerMap[key] !== -1 && columns.length > headerMap[key]) {
    Â  Â  Â  Â  Â  Â  Â  Â  let cellValue = columns[headerMap[key]];
    Â  Â  Â  Â  Â  Â  Â  Â  if (cellValue === undefined || cellValue.toLowerCase() === 'undefined' || cellValue === '') {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (key === 'utm_term' || key === 'short_url' || key === 'utm_content_combined') {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cellValue = 'N'; 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (key === 'timestamp') {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cellValue = ''; 
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â cellValue = 'N';
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  Â  Â  Â  Â  entry[key] = cellValue;
                } else {
                    entry[key] = (key === 'utm_term' || key === 'short_url' || key === 'utm_content_combined' || key === 'timestamp') ? 'N' : 'N/A';
                }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  historyArray.push(entry);
Â  Â  Â  Â  }

Â  Â  Â  Â  return historyArray.sort((a, b) => {
Â  Â  Â  Â  Â  Â  const timeA = a.timestamp || '';
Â  Â  Â  Â  Â  Â  const timeB = b.timestamp || '';
Â  Â  Â  Â  Â  Â  try {
                const dateA = new Date(timeA); 
    Â  Â  Â  Â  Â  Â  const dateB = new Date(timeB);
    Â  Â  Â  Â  Â  Â  const valA = !isNaN(dateA.getTime()) ? dateA.getTime() : 0;
    Â  Â  Â  Â  Â  Â  const valB = !isNaN(dateB.getTime()) ? dateB.getTime() : 0;
    Â  Â  Â  Â  Â  Â  return valB - valA; 
            } catch (e) { 
                return 0;
            }
Â  Â  Â  Â  });
Â  Â  } catch (error) {
Â  Â  Â  Â  console.warn(`íˆìŠ¤í† ë¦¬ ë°ì´í„°(CSV, ${GOOGLE_SHEET_HISTORY_CSV_URL}) ë¡œë”© ë˜ëŠ” íŒŒì‹± ì‹¤íŒ¨:`, error);
Â  Â  Â  Â  return [];
Â  Â  }
}

async function renderHistoryTable() { 
Â  Â  const tableBody = document.getElementById('historyTable')?.getElementsByTagName('tbody')[0];
Â  Â  if (!tableBody) { console.error("History table body (tbody) ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); return; }
Â  Â  tableBody.innerHTML = '';

Â  Â  showLoading("ì´ë ¥ ë¡œë”© ì¤‘...");
Â  Â  let historyData;
Â  Â  try {
Â  Â  Â  Â  historyData = await fetchHistoryData();
Â  Â  } catch (fetchError) {
Â  Â  Â  Â  console.error("fetchHistoryData í•¨ìˆ˜ í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", fetchError);
Â  Â  Â  Â  historyData = [];
Â  Â  }
Â  Â  hideLoading();

Â  Â  if (!Array.isArray(historyData) || historyData.length === 0) {
Â  Â  Â  Â  const row = tableBody.insertRow();
Â  Â  Â  Â  const cell = row.insertCell();
Â  Â  Â  Â  cell.colSpan = 9;
Â  Â  Â  Â  cell.textContent = 'í‘œì‹œí•  ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.';
Â  Â  Â  Â  cell.style.textAlign = 'center';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  historyData.forEach(item => {
Â  Â  Â  Â  const row = tableBody.insertRow();
Â  Â  Â  Â  let displayTimestamp = 'N/A';
Â  Â  Â  Â  const itemTimestamp = item?.timestamp;

Â  Â  Â  Â  if (itemTimestamp && itemTimestamp !== 'N' && itemTimestamp !== '') {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let dateObj;
                let parsableTimestamp = String(itemTimestamp);
                // 'YY. MM. DD. ì˜¤í›„ H:MM' ë˜ëŠ” 'YYYY-MM-DDTHH:MM:SSZ' ë“± ë‹¤ì–‘í•œ í˜•ì‹ ì‹œë„
                const kDateMatch = parsableTimestamp.match(/^(\d{2,4})\W?\s*(\d{1,2})\W?\s*(\d{1,2})\W?\s*(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?/);

                if (kDateMatch) {
                    let year = parseInt(kDateMatch[1], 10);
                    if (year < 100 && year >= 0) year += 2000; // YY í˜•ì‹ (00-99)
                    const month = parseInt(kDateMatch[2], 10) - 1; 
                    const day = parseInt(kDateMatch[3], 10);
                    const ampm = kDateMatch[4];
                    let hour = kDateMatch[5] ? parseInt(kDateMatch[5], 10) : 0;
                    const minute = kDateMatch[6] ? parseInt(kDateMatch[6], 10) : 0;
                    // const second = kDateMatch[7] ? parseInt(kDateMatch[7], 10) : 0; // ì´ˆëŠ” ì‚¬ìš© ì•ˆí•¨

                    if (ampm === 'ì˜¤í›„' && hour >= 1 && hour < 12) hour += 12;
                    if (ampm === 'ì˜¤ì „' && hour === 12) hour = 0; 

                    parsableTimestamp = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}T${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}:00`;
                }
Â  Â  Â  Â  Â  Â  Â  Â  dateObj = new Date(parsableTimestamp);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (!isNaN(dateObj.getTime())) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayTimestamp = dateObj.toLocaleString('ko-KR', { year: '2-digit', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayTimestamp = itemTimestamp; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Timestamp parsing failed for: ", itemTimestamp, ". Attempted with: ", parsableTimestamp);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Error parsing timestamp for history: ", itemTimestamp, e);
Â  Â  Â  Â  Â  Â  Â  Â  displayTimestamp = itemTimestamp;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  row.insertCell().textContent = displayTimestamp;
Â  Â  Â  Â  row.insertCell().textContent = item?.utm_source || 'N';
Â  Â  Â  Â  row.insertCell().textContent = item?.utm_medium || 'N';
Â  Â  Â  Â  row.insertCell().textContent = item?.utm_campaign_combined || 'N';
Â  Â  Â  Â  row.insertCell().textContent = item?.utm_content_combined || 'N';
Â  Â  Â  Â  row.insertCell().textContent = item?.utm_term || 'N';
Â  Â  Â  Â  
Â  Â  Â  Â  const pageUrlCell = row.insertCell();
Â  Â  Â  Â  pageUrlCell.style.cssText = 'max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
Â  Â  Â  Â  const originalPageUrl = item?.page_url || '';
Â  Â  Â  Â  if (originalPageUrl && originalPageUrl !=='N' && (originalPageUrl.startsWith('http://') || originalPageUrl.startsWith('https://'))) {
Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  link.href = originalPageUrl; link.textContent = originalPageUrl; link.target = '_blank'; link.title = originalPageUrl;
Â  Â  Â  Â  Â  Â  pageUrlCell.appendChild(link);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  pageUrlCell.textContent = originalPageUrl || 'N/A'; if (originalPageUrl && originalPageUrl !== 'N') pageUrlCell.title = originalPageUrl; else pageUrlCell.title = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  const finalUrlCell = row.insertCell();
Â  Â  Â  Â  finalUrlCell.style.cssText = 'max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
Â  Â  Â  Â  const finalUrl = item?.final_url || '';
Â  Â  Â  Â  if (finalUrl && finalUrl !== 'N' && (finalUrl.startsWith('http://') || finalUrl.startsWith('https://'))) {
Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  link.href = finalUrl; link.textContent = finalUrl; link.target = '_blank'; link.title = finalUrl;
Â  Â  Â  Â  Â  Â  finalUrlCell.appendChild(link);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  finalUrlCell.textContent = finalUrl || 'N/A'; if (finalUrl && finalUrl !== 'N') finalUrlCell.title = finalUrl; else finalUrlCell.title = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const shortUrlCell = row.insertCell();
Â  Â  Â  Â  const shortUrl = item?.short_url || '';
Â  Â  Â  Â  if (shortUrl && shortUrl !== 'N' && (shortUrl.startsWith('http://') || shortUrl.startsWith('https://'))) {
Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  link.href = shortUrl; link.textContent = shortUrl; link.target = '_blank'; link.title = shortUrl;
Â  Â  Â  Â  Â  Â  shortUrlCell.appendChild(link);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  shortUrlCell.textContent = shortUrl || 'N/A'; if (shortUrl && shortUrl !== 'N') shortUrlCell.title = shortUrl; else shortUrlCell.title = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  shortUrlCell.style.cssText = 'max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
Â  Â  });
}
function copyLink() { 
Â  Â  const input = document.getElementById("shortUrlInput");
Â  Â  if (!input || !input.value) {
Â  Â  Â  Â  alert("ë³µì‚¬í•  ë‹¨ì¶• URLì´ ì—†ìŠµë‹ˆë‹¤."); return;
Â  Â  }
Â  Â  input.select(); input.setSelectionRange(0, 99999);
Â  Â  try {
Â  Â  Â  Â  const successful = document.execCommand("copy");
Â  Â  Â  Â  if (successful) { alert("âœ… ë‹¨ì¶• URL ë³µì‚¬ ì™„ë£Œ!"); }
Â  Â  Â  Â  else { alert("âŒ ë‹¨ì¶• URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”."); }
Â  Â  } catch (err) {
Â  Â  Â  Â  alert("âŒ ë³µì‚¬ ê¸°ëŠ¥ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); console.error('Copy error', err);
Â  Â  }
Â  Â  if (window.getSelection) { window.getSelection().removeAllRanges(); }
Â  Â  else if (document.selection) { document.selection.empty(); }
}

document.getElementById("utmForm").addEventListener("submit", async (e) => {
Â  Â  e.preventDefault();
Â  Â  showLoading("UTM ë§í¬ ìƒì„± ë° ì „ì†¡ ì¤‘...");

Â  Â  const requiredFieldsCheck = [
Â  Â  Â  Â  { id: "page_url", name: "Page URL" }, { id: "source", name: "UTM Source" },
Â  Â  Â  Â  { id: "medium", name: "UTM Medium" }, { id: "campaign_date", name: "ë‚ ì§œ" },
Â  Â  Â  Â  { id: "ad_type", name: "ê´‘ê³ íƒ€ì…" }, { id: "device_type", name: "ê¸°ê¸°ì¹´í…Œê³ ë¦¬" }
Â  Â  ];

Â  Â  for (let field of requiredFieldsCheck) {
Â  Â  Â  Â  let valueToCheck;
        if (field.id === "campaign_date") { // ë‚ ì§œ í•„ë“œëŠ” ì§ì ‘ ì…ë ¥ ê°’ì´ë¯€ë¡œ getValueOrNì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            valueToCheck = document.getElementById(field.id).value.trim();
             if (valueToCheck === "") valueToCheck = "n"; // ë¹ˆ ê°’ì´ë©´ "n"ìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ í•„ìˆ˜ê°’ ì²´í¬
        } else {
            valueToCheck = getValueOrN(field.id);
        }

Â  Â  Â  Â  if (valueToCheck === "n") { 
Â  Â  Â  Â  Â  Â  alert(`í•„ìˆ˜ í•­ëª© '${field.name}'ì„(ë¥¼) ì„ íƒ ë˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.`);
Â  Â  Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  Â  Â  const elementToFocus = document.getElementById(field.id);
Â  Â  Â  Â  Â  Â  if (document.getElementById(`${field.id}_dropdown`)) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById(`${field.id}_selected_value`)?.focus(); 
                    document.getElementById(`${field.id}_selected_value`)?.click();
Â  Â  Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  Â  Â  Â elementToFocus?.focus();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  updateFinalURL(); 

Â  Â  const formDataForN8n = {
Â  Â  Â  Â  page_url: document.getElementById('page_url').value.trim(),
Â  Â  Â  Â  utm_campaign_combined: document.getElementById('utm_campaign').value.trim(),
Â  Â  Â  Â  utm_content_combined: document.getElementById('utm_content').value.trim(),
Â  Â  Â  Â  final_url: document.getElementById('final_url').value.trim(),
Â  Â  Â  Â  timestamp: new Date().toISOString()
Â  Â  };

Â  Â  const parametersToLog = [
Â  Â  Â  Â  { id: 'source', keyForN8n: 'utm_source' }, { id: 'medium', keyForN8n: 'utm_medium' },
      // campaign_dateëŠ” ì§ì ‘ ì…ë ¥ í•„ë“œì´ë¯€ë¡œ, getValueOrN ëŒ€ì‹  ì§ì ‘ ê°’ì„ ê°€ì ¸ì™€ì„œ ì²˜ë¦¬
      // { id: 'campaign_date', keyForN8n: 'campaign_date' }, 
Â  Â  Â  Â  { id: 'ad_type', keyForN8n: 'ad_type' },
Â  Â  Â  Â  { id: 'campaign_goal', keyForN8n: 'campaign_goal' }, { id: 'event_type', keyForN8n: 'event_type' },
Â  Â  Â  Â  { id: 'product_category', keyForN8n: 'product_category' }, { id: 'ad_target', keyForN8n: 'ad_target' },
Â  Â  Â  Â  { id: 'creative_type', keyForN8n: 'creative_type' }, { id: 'device_type', keyForN8n: 'device_type' },
Â  Â  Â  Â  { id: 'content_action', keyForN8n: 'content_action' }, 
      // content_detail, content_version, utm_termì€ ì§ì ‘ ì…ë ¥ í•„ë“œ
      // { id: 'content_detail', keyForN8n: 'content_detail' }, 
      // { id: 'content_version', keyForN8n: 'content_version' }, 
      // { id: 'utm_term', keyForN8n: 'utm_term' }
Â  Â  ];

    // ì§ì ‘ ì…ë ¥ í•„ë“œ ê°’ ì¶”ê°€
    const campaignDateVal = document.getElementById('campaign_date').value.trim();
    if (campaignDateVal) formDataForN8n.campaign_date = campaignDateVal;

    const contentDetailVal = document.getElementById('content_detail').value.trim();
    if (contentDetailVal) formDataForN8n.content_detail = contentDetailVal.toLowerCase();
    
    const contentVersionVal = document.getElementById('content_version').value.trim();
    if (contentVersionVal) formDataForN8n.content_version = contentVersionVal.toLowerCase();

    const utmTermVal = document.getElementById('utm_term').value.trim();
    if (utmTermVal) formDataForN8n.utm_term = utmTermVal.toLowerCase();


Â  Â  for (const param of parametersToLog) { // ë“œë¡­ë‹¤ìš´ ë° getValueOrNìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ” í•„ë“œë“¤
Â  Â  Â  Â  const elementValue = getValueOrN(param.id); 
Â  Â  Â  Â  if (elementValue !== "n") { 
Â  Â  Â  Â  Â  Â  formDataForN8n[param.keyForN8n] = elementValue;
Â  Â  Â  Â  }
Â  Â  }
    
    // === START: options_to_add_to_master_sheet ìˆ˜ì •ëœ ë¡œì§ ===
    formDataForN8n.options_to_add_to_master_sheet = []; // ë°°ì—´ë¡œ ì´ˆê¸°í™”

Â  Â  console.log("--- Identifying new options to add to master sheet (Submit Event) ---");
Â  Â  for (const baseId of dropdownBaseIds) {
Â  Â  Â  Â  const hiddenInputElement = document.getElementById(baseId); 
Â  Â  Â  Â  const selectedValueDisplayElement = document.getElementById(`${baseId}_selected_value`);

Â  Â  Â  Â  if (hiddenInputElement && selectedValueDisplayElement) {
Â  Â  Â  Â  Â  Â  const selectedValueDisplayText = selectedValueDisplayElement.textContent.trim(); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (selectedValueDisplayText && selectedValueDisplayText !== "-- ì„ íƒí•˜ì„¸ìš” --" && selectedValueDisplayText.toLowerCase() !== 'n' && selectedValueDisplayText.toLowerCase() !== 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  const masterListForThisCategory = masterOptionLists[baseId] || new Set();
Â  Â  Â  Â  Â  Â  Â  Â  let isNewForMaster = true;
Â  Â  Â  Â  Â  Â  Â  Â  const lowercasedSelectedDisplayText = selectedValueDisplayText.toLowerCase();

Â  Â  Â  Â  Â  Â  Â  Â  if (masterListForThisCategory.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const masterOption of masterListForThisCategory) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (String(masterOption).trim().toLowerCase() === lowercasedSelectedDisplayText) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isNewForMaster = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (isNewForMaster) {
                    formDataForN8n.options_to_add_to_master_sheet.push({
                        unique_id: `${baseId}::${selectedValueDisplayText}`,
                        parameter_type: baseId,
                        option_value: selectedValueDisplayText, // ì›ë³¸ ëŒ€ì†Œë¬¸ì ìœ ì§€
                        is_active: 'Y'
                    });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
    // ë°°ì—´ì´ ë¹„ì–´ìˆìœ¼ë©´ í˜ì´ë¡œë“œì—ì„œ í•´ë‹¹ í‚¤ë¥¼ ë³´ë‚´ì§€ ì•ŠìŒ (n8nì—ì„œ undefinedë¡œ ë°›ê²Œ ë¨)
Â  Â  if (formDataForN8n.options_to_add_to_master_sheet.length === 0) {
Â  Â  Â  Â  delete formDataForN8n.options_to_add_to_master_sheet;
Â  Â  }
    // === END: options_to_add_to_master_sheet ìˆ˜ì •ëœ ë¡œì§ ===

Â  Â  console.log("--- ìµœì¢… formDataForN8n (to be sent to n8n):", JSON.stringify(formDataForN8n, null, 2), " ---");
Â  Â  
Â  Â  try {
Â  Â  Â  Â  const n8nUrl = N8N_WEBHOOK_URL;
Â  Â  Â  Â  if (!n8nUrl || n8nUrl === 'ì—¬ê¸°ì—_N8N_WEBHOOK_PRODUCTION_URL_ì…ë ¥í•˜ì„¸ìš”' || (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:')) {
Â  Â  Â  Â  Â  Â  let alertMessage = "n8n ì›¹í›… URLì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n";
Â  Â  Â  Â  Â  Â  if (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:') {
Â  Â  Â  Â  Â  Â  Â  Â  alertMessage = "ê²½ê³ : í˜„ì¬ í˜ì´ì§€ëŠ” HTTPSì´ë‚˜ n8n ì›¹í›…ì€ HTTP ë¡œì»¬í˜¸ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì •ìƒ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n(í˜¼í•© ì½˜í…ì¸  ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥)\n";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  alertMessage += "\nUTM ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ë‹¨ì¶• ë° ì´ë ¥/ì‹œíŠ¸ ì €ì¥ ì•ˆë¨):\n" + (formDataForN8n.final_url || document.getElementById('final_url').value.trim());
Â  Â  Â  Â  Â  Â  alert(alertMessage);
Â  Â  Â  Â  Â  Â  document.getElementById("responseContainer").style.display = "none";
Â  Â  Â  Â  Â  Â  hideLoading();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const res = await fetch(n8nUrl, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(formDataForN8n)
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  const errorText = await res.text();
Â  Â  Â  Â  Â  Â  throw new Error(`n8n ì›¹í›… ì‘ë‹µ ì˜¤ë¥˜ (${res.status}): ${errorText || res.statusText}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const result = await res.json();

Â  Â  Â  Â  if (result.short_url) {
Â  Â  Â  Â  Â  Â  document.getElementById("shortUrlInput").value = result.short_url;
Â  Â  Â  Â  Â  Â  document.getElementById("responseContainer").style.display = "block";
Â  Â  Â  Â  Â  Â  await renderHistoryTable(); 
Â  Â  Â  Â  Â  Â  alert("UTM ë§í¬ ìƒì„±, ë‹¨ì¶• ë° ì‹œíŠ¸ ì €ì¥ ìš”ì²­ ì™„ë£Œ!\nìµœì¢… URL: " + (formDataForN8n.final_url || document.getElementById('final_url').value.trim()) + "\në‹¨ì¶• URL: " + result.short_url);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("ë‹¨ì¶• URLì„ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. n8n ì›Œí¬í”Œë¡œìš° ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.\n(ì‹œíŠ¸ ì €ì¥ì€ ì‹œë„ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\nìµœì¢… URL: " + (formDataForN8n.final_url || document.getElementById('final_url').value.trim()));
Â  Â  Â  Â  Â  Â  document.getElementById("responseContainer").style.display = "none";
Â  Â  Â  Â  Â  Â  await renderHistoryTable(); 
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("n8n ì „ì†¡ ë˜ëŠ” ì²˜ë¦¬ ì˜¤ë¥˜:", err);
Â  Â  Â  Â  alert(`ì„œë²„ í†µì‹  ë˜ëŠ” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}\n(UTM ë§í¬ëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ë‹¨ì¶• ë° ì´ë ¥/ì‹œíŠ¸ ì €ì¥ì€ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\nìµœì¢… URL: ${formDataForN8n.final_url || document.getElementById('final_url').value.trim()}`);
Â  Â  Â  Â  document.getElementById("responseContainer").style.display = "none";
Â  Â  } finally {
Â  Â  Â  Â  hideLoading();
Â  Â  }
});
</script>
</body>
</html>